name: üîì Quick Deobfuscator - FIXED

on:
  workflow_dispatch:
    inputs:
      file_types:
        description: 'File types to decode (comma separated)'
        required: false
        default: 'py,sh,js'

jobs:
  deobfuscate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Decode Obfuscated Files
      run: |
        echo "üîì Starting deobfuscation process..."
        
        # Create backup directory
        mkdir -p backup_original
        
        # Process Python files
        for file in $(find . -name "*.py" ! -path "./.git/*" ! -path "./backup_original/*"); do
          echo "üîç Checking: $file"
          
          # Check if file contains base64 obfuscation pattern
          if grep -q "base64.b64decode" "$file"; then
            echo "üéØ Obfuscated Python file detected!"
            
            # Backup original obfuscated file
            cp "$file" "backup_original/$(basename "$file").obfuscated"
            
            # Extract base64 string (handle both single and double quotes)
            b64=$(grep -o "base64.b64decode(['\"][^'\"]*['\"])" "$file" | \
                  sed "s/base64.b64decode(['\"]//;s/['\"])//")
            
            if [ -z "$b64" ]; then
              # Try alternative pattern for exec()
              b64=$(grep -o "exec(base64.b64decode(['\"][^'\"]*['\"]))" "$file" | \
                    sed "s/exec(base64.b64decode(['\"]//;s/['\"]))//")
            fi
            
            if [ -n "$b64" ]; then
              echo "‚úÖ Extracted base64 string (length: ${#b64})"
              
              # Decode and replace file
              echo "$b64" | base64 -d > "$file.decoded_temp"
              
              # Check if decoding was successful
              if [ $? -eq 0 ] && [ -s "$file.decoded_temp" ]; then
                mv "$file.decoded_temp" "$file"
                echo "üìÑ File successfully decoded"
                
                # Show first 3 lines
                echo "--- Preview ---"
                head -3 "$file"
                echo "---"
              else
                echo "‚ùå Decoding failed, restoring backup"
                cp "backup_original/$(basename "$file").obfuscated" "$file"
                rm -f "$file.decoded_temp"
              fi
            else
              echo "‚ö†Ô∏è Could not extract base64 data"
            fi
          else
            echo "‚ÑπÔ∏è Not obfuscated (no pattern found)"
          fi
          echo ""
        done
        
        # Process Shell files
        for file in $(find . -name "*.sh" ! -path "./.git/*" ! -path "./backup_original/*"); do
          echo "üîç Checking: $file"
          
          if grep -q "echo.*base64 -d" "$file" || grep -q 'eval.*base64' "$file"; then
            echo "üéØ Obfuscated Shell file detected!"
            cp "$file" "backup_original/$(basename "$file").obfuscated"
            
            # Extract base64 string
            b64=$(grep -o "echo ['\"][^'\"]*['\"]" "$file" | sed "s/echo ['\"]//;s/['\"]//")
            
            if [ -z "$b64" ]; then
              b64=$(grep -o 'eval.*echo ['\"][^'\"]*['\"]' "$file" | sed "s/eval.*echo ['\"]//;s/['\"]//")
            fi
            
            if [ -n "$b64" ]; then
              echo "$b64" | base64 -d > "$file.decoded_temp"
              if [ $? -eq 0 ]; then
                mv "$file.decoded_temp" "$file"
                chmod +x "$file"
                echo "‚úÖ Shell file decoded"
              fi
            fi
          fi
          echo ""
        done
        
        # Process JavaScript files
        for file in $(find . -name "*.js" ! -path "./.git/*" ! -path "./backup_original/*"); do
          echo "üîç Checking: $file"
          
          if grep -q "Buffer.from.*base64" "$file"; then
            echo "üéØ Obfuscated JavaScript file detected!"
            cp "$file" "backup_original/$(basename "$file").obfuscated"
            
            b64=$(grep -o "Buffer.from(['\"][^'\"]*['\"])" "$file" | sed "s/Buffer.from(['\"]//;s/['\"])//")
            
            if [ -n "$b64" ]; then
              echo "$b64" | base64 -d > "$file.decoded_temp"
              if [ $? -eq 0 ]; then
                mv "$file.decoded_temp" "$file"
                chmod +x "$file"
                echo "‚úÖ JavaScript file decoded"
              fi
            fi
          fi
          echo ""
        done
        
        echo "========================================"
        echo "üìä DECODING COMPLETE"
        echo "üíæ Backups saved in: backup_original/"
        echo "üìÅ Files processed:"
        find . -name "*.py" -o -name "*.sh" -o -name "*.js" | wc -l
    
    - name: Commit Changes
      run: |
        # Configure git
        git config --global user.name "Deobfuscator Bot"
        git config --global user.email "deobfuscator@github.com"
        
        # Check if there are any changes
        if git diff --quiet; then
          echo "ü§∑ No changes to commit"
        else
          # Add all modified files
          git add -A
          
          # Create commit
          git commit -m "üîì Deobfuscate files [$(date +'%Y-%m-%d %H:%M:%S')]" || echo "Commit failed but continuing..."
          
          # Push changes (force with lease to avoid conflicts)
          git push origin HEAD || echo "Push failed, maybe no changes?"
        fi
    
    - name: Upload Backups
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: original-backups
        path: backup_original/
        retention-days: 30
