name: ğŸ› ï¸ Safe Deobfuscator

on:
  workflow_dispatch:

jobs:
  decode-safe:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Decode Without Git Operations
      id: decode
      run: |
        echo "ğŸ”“ DECODING FILES (Read-Only Mode)"
        echo "===================================="
        
        # Function to decode a file
        decode_file() {
          local file="$1"
          local ext="${file##*.}"
          
          echo "ğŸ“„ Processing: $file"
          
          case "$ext" in
            py)
              if grep -q "base64.b64decode" "$file"; then
                echo "ğŸ¯ Python obfuscation detected"
                b64=$(python3 -c "
import re
with open('$file', 'r') as f:
    content = f.read()
# Find base64 string
match = re.search(r\"base64\\.b64decode\\(['\\\"]([^'\\\"]+)['\\\"]\\)\", content)
if match:
    print(match.group(1))
")
                if [ -n "$b64" ]; then
                  echo "âœ… Decoding successful"
                  echo "$b64" | base64 -d
                  return 0
                fi
              fi
              ;;
              
            sh)
              if grep -q "echo.*base64 -d" "$file"; then
                echo "ğŸ¯ Shell obfuscation detected"
                # Extract between quotes
                b64=$(sed -n "s/.*echo ['\"]\([^'\"]*\)['\"].*/\1/p" "$file")
                if [ -n "$b64" ]; then
                  echo "âœ… Decoding successful"
                  echo "$b64" | base64 -d
                  return 0
                fi
              fi
              ;;
              
            js)
              if grep -q "Buffer.from.*base64" "$file"; then
                echo "ğŸ¯ JavaScript obfuscation detected"
                b64=$(sed -n "s/.*Buffer.from(['\"]\([^'\"]*\)['\"].*/\1/p" "$file")
                if [ -n "$b64" ]; then
                  echo "âœ… Decoding successful"
                  echo "$b64" | base64 -d
                  return 0
                fi
              fi
              ;;
          esac
          
          echo "âŒ Not obfuscated or cannot decode"
          return 1
        }
        
        # Process files and save decoded versions
        mkdir -p decoded_output
        
        TOTAL=0
        SUCCESS=0
        
        for file in $(find . -name "*.py" -o -name "*.sh" -o -name "*.js" | head -20); do
          if [ -f "$file" ]; then
            ((TOTAL++))
            echo ""
            echo "--- $file ---"
            OUTPUT=$(decode_file "$file" 2>/dev/null)
            
            if [ $? -eq 0 ] && [ -n "$OUTPUT" ]; then
              ((SUCCESS++))
              # Save decoded output
              echo "$OUTPUT" > "decoded_output/$(basename "$file").decoded"
              echo "ğŸ’¾ Saved to: decoded_output/$(basename "$file").decoded"
            fi
          fi
        done
        
        echo ""
        echo "========================================"
        echo "ğŸ“Š RESULTS:"
        echo "Total files checked: $TOTAL"
        echo "Successfully decoded: $SUCCESS"
        echo "Decoded files saved in: decoded_output/"
        
        # Set output for next step
        echo "success_count=$SUCCESS" >> $GITHUB_OUTPUT
    
    - name: Show Results
      run: |
        echo "ğŸ‰ Decoding completed!"
        echo "ğŸ“ Decoded files available in: decoded_output/"
        
        # List decoded files
        if [ -d "decoded_output" ] && [ -n "$(ls -A decoded_output 2>/dev/null)" ]; then
          echo "ğŸ“„ Decoded files:"
          ls -la decoded_output/
          
          echo ""
          echo "ğŸ“‹ Sample content:"
          for f in decoded_output/*.decoded; do
            echo "--- $(basename "$f") ---"
            head -5 "$f"
            echo ""
          done
        else
          echo "âš ï¸ No files were decoded"
        fi
    
    - name: Upload Decoded Files
      uses: actions/upload-artifact@v4
      with:
        name: decoded-files
        path: decoded_output/
        retention-days: 7
