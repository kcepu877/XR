#!/usr/bin/env python3
import base64
exec(base64.b64decode('aW1wb3J0IHJlcXVlc3RzLCB0aW1lCmZyb20gcmFuZG9tIGltcG9ydCByYW5kaW50CmltcG9ydCBqc29uCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCmltcG9ydCBvcwoKZnJvbSBhcHAyLmNvbmZpZy5pbXBvcnRzIGltcG9ydCAqCmZyb20gYXBwMi5jbGllbnQucHVyY2hhc2UuYmFsYW5jZSBpbXBvcnQgc2V0dGxlbWVudF9iYWxhbmNlCmZyb20gYXBwLnR5cGVfZGljdCBpbXBvcnQgUGF5bWVudEl0ZW0KZnJvbSBhcHAyLm1lbnVzLnV0aWwgaW1wb3J0ICgKICAgIGNsZWFyX3NjcmVlbiwKICAgIHBhdXNlLAogICAgcHJpbnRfcGFuZWwsCiAgICBnZXRfcnVwaWFoLAogICAgZGlzcGxheV9odG1sLAogICAgc2ltcGxlX251bWJlciwKICAgIGRlbGF5X2lubGluZSwKICAgIGZvcm1hdF9xdW90YV9ieXRlCikKCmZyb20gYXBwMi5jbGllbnQucHVyY2hhc2UucmVkZWVtIGltcG9ydCBzZXR0bGVtZW50X2JvdW50eQpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBkZWZhdWx0ZGljdAoKY29uc29sZSA9IENvbnNvbGUoKQoKCmJvbnVzX2JwID0gWwogICAgewogICAgICAgICJmYW1pbHlfbmFtZSI6ICJCb251cyBCZWJhcyBQdWFzIiwKICAgICAgICAiZmFtaWx5X2NvZGUiOiAiN2U1ZWIyODgtNThhMC00NGQwLTgwMDItYjY2YmFkMjEwZjIxIiwKICAgICAgICAidmFyaWFudF9uYW1lIjogIkJvbnVzIEJlYmFzIFB1YXMiLAogICAgICAgICJvcHRpb25fbmFtZSI6ICJLdW90YSBZb3V0dWJlICYgVGlrdG9rIDMuMTNHQiIsCiAgICAgICAgIm9yZGVyIjogMjAwCiAgICB9LAogICAgewogICAgICAgICJmYW1pbHlfbmFtZSI6ICJCb251cyBCZWJhcyBQdWFzIiwKICAgICAgICAiZmFtaWx5X2NvZGUiOiAiN2U1ZWIyODgtNThhMC00NGQwLTgwMDItYjY2YmFkMjEwZjIxIiwKICAgICAgICAidmFyaWFudF9uYW1lIjogIkJvbnVzIEJlYmFzIFB1YXMiLAogICAgICAgICJvcHRpb25fbmFtZSI6ICJLdW90YSBVdGFtYSAxLjI1R0IiLAogICAgICAgICJvcmRlciI6IDIwMQogICAgfSwKICAgIHsKICAgICAgICAiZmFtaWx5X25hbWUiOiAiQm9udXMgQmViYXMgUHVhcyIsCiAgICAgICAgImZhbWlseV9jb2RlIjogIjdlNWViMjg4LTU4YTAtNDRkMC04MDAyLWI2NmJhZDIxMGYyMSIsCiAgICAgICAgInZhcmlhbnRfbmFtZSI6ICJCb251cyBCZWJhcyBQdWFzIiwKICAgICAgICAib3B0aW9uX25hbWUiOiAiS3VvdGEgTWFsYW0gMy43NUdCIiwKICAgICAgICAib3JkZXIiOiAxOTkKICAgIH0KXQoKZGVmIHJlZGVlbV9sb29waW5nKGxvb3BfY291bnQ6IGludCwgcGF1c2Vfb25fc3VjY2Vzcz1UcnVlKToKICAgIHRoZW1lID0gZ2V0X3RoZW1lKCkKICAgIGFwaV9rZXkgPSBBdXRoSW5zdGFuY2UuYXBpX2tleQoKICAgIHRvdGFsX3N1Y2Nlc3MgPSBkZWZhdWx0ZGljdChpbnQpCiAgICB0b3RhbF9mYWlsZWQgPSBkZWZhdWx0ZGljdChpbnQpCgogICAgZm9yIGkgaW4gcmFuZ2UobG9vcF9jb3VudCk6CiAgICAgICAgdG9rZW5zID0gQXV0aEluc3RhbmNlLmdldF9hY3RpdmVfdG9rZW5zKCkgb3Ige30KCiAgICAgICAgaWYgaSA+IDA6CiAgICAgICAgICAgIGNsZWFyX2NhY2hlKCkKCiAgICAgICAgY29uc29sZS5ydWxlKCkKICAgICAgICBjb25zb2xlLnByaW50KGYiW3t0aGVtZVsndGV4dF90aXRsZSddfV1SZWRlZW0gTG9vcGluZyBrZS17aSsxfS97bG9vcF9jb3VudH1bL10iKQoKICAgICAgICBzdWNjZXNzZnVsID0gW10KICAgICAgICBmYWlsZWQgPSBbXQoKICAgICAgICBmb3IgYm0gaW4gYm9udXNfYnA6CiAgICAgICAgICAgIGZhbWlseV9jb2RlID0gYm1bImZhbWlseV9jb2RlIl0KICAgICAgICAgICAgb3JkZXIgPSBibVsib3JkZXIiXQogICAgICAgICAgICBvcHRpb25fbmFtZSA9IGJtWyJvcHRpb25fbmFtZSJdCgogICAgICAgICAgICBjb25zb2xlLnByaW50KGYiQ2xhaW0gYm9udXM6IHtibVsndmFyaWFudF9uYW1lJ119IC0ge29wdGlvbl9uYW1lfSIpCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmYW1pbHlfZGF0YSA9IGdldF9mYW1pbHkoYXBpX2tleSwgdG9rZW5zLCBmYW1pbHlfY29kZSkKICAgICAgICAgICAgICAgIGlmIG5vdCBmYW1pbHlfZGF0YToKICAgICAgICAgICAgICAgICAgICBmYWlsZWQuYXBwZW5kKG9wdGlvbl9uYW1lKQogICAgICAgICAgICAgICAgICAgIHRvdGFsX2ZhaWxlZFtvcHRpb25fbmFtZV0gKz0gMQogICAgICAgICAgICAgICAgICAgIHByaW50X3BhbmVsKCJLZXNhbGFoYW4iLCBmIkdhZ2FsIGFtYmlsIGRhdGEgZmFtaWx5IHVudHVrIHtvcHRpb25fbmFtZX0iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgdGFyZ2V0X3ZhcmlhbnQgPSBuZXh0KAogICAgICAgICAgICAgICAgICAgICh2IGZvciB2IGluIGZhbWlseV9kYXRhWyJwYWNrYWdlX3ZhcmlhbnRzIl0gaWYgdlsibmFtZSJdID09IGJtWyJ2YXJpYW50X25hbWUiXSksCiAgICAgICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgaWYgbm90IHRhcmdldF92YXJpYW50OgogICAgICAgICAgICAgICAgICAgIGZhaWxlZC5hcHBlbmQob3B0aW9uX25hbWUpCiAgICAgICAgICAgICAgICAgICAgdG90YWxfZmFpbGVkW29wdGlvbl9uYW1lXSArPSAxCiAgICAgICAgICAgICAgICAgICAgcHJpbnRfcGFuZWwoIktlc2FsYWhhbiIsIGYiVmFyaWFudCB0aWRhayBkaXRlbXVrYW4gdW50dWsge29wdGlvbl9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICB0YXJnZXRfcGFja2FnZV9kZXRhaWwgPSBnZXRfcGFja2FnZV9kZXRhaWxzKAogICAgICAgICAgICAgICAgICAgIGFwaV9rZXksCiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICAgICAgICAgIGZhbWlseV9jb2RlLAogICAgICAgICAgICAgICAgICAgIHRhcmdldF92YXJpYW50WyJwYWNrYWdlX3ZhcmlhbnRfY29kZSJdLAogICAgICAgICAgICAgICAgICAgIG9yZGVyLAogICAgICAgICAgICAgICAgICAgIE5vbmUsCiAgICAgICAgICAgICAgICAgICAgTm9uZSwKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICBpZiBub3QgdGFyZ2V0X3BhY2thZ2VfZGV0YWlsIG9yICJwYWNrYWdlX29wdGlvbiIgbm90IGluIHRhcmdldF9wYWNrYWdlX2RldGFpbDoKICAgICAgICAgICAgICAgICAgICBmYWlsZWQuYXBwZW5kKG9wdGlvbl9uYW1lKQogICAgICAgICAgICAgICAgICAgIHRvdGFsX2ZhaWxlZFtvcHRpb25fbmFtZV0gKz0gMQogICAgICAgICAgICAgICAgICAgIHByaW50X3BhbmVsKCJLZXNhbGFoYW4iLCBmIkRldGFpbCBwYWtldCB0aWRhayBkaXRlbXVrYW4gdW50dWsge29wdGlvbl9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICByZXMgPSBzZXR0bGVtZW50X2JvdW50eSgKICAgICAgICAgICAgICAgICAgICBhcGlfa2V5PWFwaV9rZXksCiAgICAgICAgICAgICAgICAgICAgdG9rZW5zPXRva2VucywKICAgICAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb249dGFyZ2V0X3BhY2thZ2VfZGV0YWlsLmdldCgidG9rZW5fY29uZmlybWF0aW9uIiwgIiIpLAogICAgICAgICAgICAgICAgICAgIHRzX3RvX3NpZ249dGFyZ2V0X3BhY2thZ2VfZGV0YWlsLmdldCgidGltZXN0YW1wIiwgIiIpLAogICAgICAgICAgICAgICAgICAgIHBheW1lbnRfdGFyZ2V0PXRhcmdldF9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicGFja2FnZV9vcHRpb25fY29kZSJdLAogICAgICAgICAgICAgICAgICAgIHByaWNlPXRhcmdldF9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicHJpY2UiXSwKICAgICAgICAgICAgICAgICAgICBpdGVtX25hbWU9dGFyZ2V0X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJuYW1lIl0sCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgPT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3NmdWwuYXBwZW5kKG9wdGlvbl9uYW1lKQogICAgICAgICAgICAgICAgICAgIHRvdGFsX3N1Y2Nlc3Nbb3B0aW9uX25hbWVdICs9IDEKICAgICAgICAgICAgICAgICAgICBwcmludF9wYW5lbCgiU3Vrc2VzIiwgZiJSZWRlZW0gYmVyaGFzaWw6IHtvcHRpb25fbmFtZX0iKQogICAgICAgICAgICAgICAgICAgIGlmIHBhdXNlX29uX3N1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbXNnID0gcmVzLmdldCgibWVzc2FnZSIsICJUaWRhayBkaWtldGFodWkiKSBpZiBpc2luc3RhbmNlKHJlcywgZGljdCkgZWxzZSAiRXJyb3IiCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkLmFwcGVuZChvcHRpb25fbmFtZSkKICAgICAgICAgICAgICAgICAgICB0b3RhbF9mYWlsZWRbb3B0aW9uX25hbWVdICs9IDEKICAgICAgICAgICAgICAgICAgICBwcmludF9wYW5lbCgiS2VzYWxhaGFuIiwgZiJSZWRlZW0gZ2FnYWw6IHttc2d9IikKCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGZhaWxlZC5hcHBlbmQob3B0aW9uX25hbWUpCiAgICAgICAgICAgICAgICB0b3RhbF9mYWlsZWRbb3B0aW9uX25hbWVdICs9IDEKICAgICAgICAgICAgICAgIHByaW50X3BhbmVsKCJLZXNhbGFoYW4iLCBmIkVycm9yIHNhYXQgcmVkZWVtIHtvcHRpb25fbmFtZX06IHtlfSIpCgogICAgICAgIGNvbnNvbGUucnVsZSgpCiAgICAgICAgc3VtbWFyeV90ZXh0ID0gZiJTZWxlc2FpIGxvb3Bpbmcge2krMX0ve2xvb3BfY291bnR9XG4iIFwKICAgICAgICAgICAgICAgICAgICAgICBmIkJlcmhhc2lsOiB7bGVuKHN1Y2Nlc3NmdWwpfVxuIiBcCiAgICAgICAgICAgICAgICAgICAgICAgZiJHYWdhbDoge2xlbihmYWlsZWQpfSIKICAgICAgICBjb25zb2xlLnByaW50KFBhbmVsKHN1bW1hcnlfdGV4dCwgYm9yZGVyX3N0eWxlPXRoZW1lWyJib3JkZXJfaW5mbyJdKSkKICAgICAgICBpZiBzdWNjZXNzZnVsOgogICAgICAgICAgICBjb25zb2xlLnByaW50KCJEYWZ0YXIgc3Vrc2VzOiIpCiAgICAgICAgICAgIGZvciBzIGluIHN1Y2Nlc3NmdWw6CiAgICAgICAgICAgICAgICBjb25zb2xlLnByaW50KGYiLSB7c30iKQogICAgICAgIGlmIGZhaWxlZDoKICAgICAgICAgICAgY29uc29sZS5wcmludCgiRGFmdGFyIGdhZ2FsOiIpCiAgICAgICAgICAgIGZvciBmIGluIGZhaWxlZDoKICAgICAgICAgICAgICAgIGNvbnNvbGUucHJpbnQoZiItIHtmfSIpCgogICAgICAgIGlmIGkgPCBsb29wX2NvdW50IC0gMToKICAgICAgICAgICAgY29uc29sZS5wcmludChmIlt7dGhlbWVbJ3RleHRfc3ViJ119XVR1bmdndSAxMSBtZW5pdCBzZWJlbHVtIGxvb3BpbmcgYmVyaWt1dG55YS4uLlsvXSIpCiAgICAgICAgICAgIGRlbGF5X2lubGluZSg2NjApCgogICAgY29uc29sZS5ydWxlKCkKICAgIGNvbnNvbGUucHJpbnQoUGFuZWwoIlJla2FwIEFraGlyIFNlbXVhIExvb3BpbmciLCBib3JkZXJfc3R5bGU9dGhlbWVbImJvcmRlcl9wcmltYXJ5Il0pKQogICAgaWYgdG90YWxfc3VjY2VzczoKICAgICAgICBjb25zb2xlLnByaW50KCJUb3RhbCBzdWtzZXM6IikKICAgICAgICBmb3IgbmFtZSwgY291bnQgaW4gdG90YWxfc3VjY2Vzcy5pdGVtcygpOgogICAgICAgICAgICBjb25zb2xlLnByaW50KGYiLSB7bmFtZX0ge2NvdW50fXggc3Vrc2VzIikKICAgIGlmIHRvdGFsX2ZhaWxlZDoKICAgICAgICBjb25zb2xlLnByaW50KCJUb3RhbCBnYWdhbDoiKQogICAgICAgIGZvciBuYW1lLCBjb3VudCBpbiB0b3RhbF9mYWlsZWQuaXRlbXMoKToKICAgICAgICAgICAgY29uc29sZS5wcmludChmIi0ge25hbWV9IHtjb3VudH14IGdhZ2FsIikKCiAgICBwYXVzZSgpCgoKCmRlZiBwdXJjaGFzZV9sb29wKAogICAgZmFtaWx5X2NvZGU6IHN0ciwKICAgIG9yZGVyOiBpbnQsCiAgICB1c2VfZGVjb3k6IGJvb2wsCiAgICBkZWxheTogaW50LAogICAgcGF1c2Vfb25fc3VjY2VzczogYm9vbCA9IEZhbHNlLAopOgogICAgdGhlbWUgPSBnZXRfdGhlbWUoKQogICAgZW5zdXJlX2dpdCgpCiAgICBhcGlfa2V5ID0gQXV0aEluc3RhbmNlLmFwaV9rZXkKICAgIHRva2VuczogZGljdCA9IEF1dGhJbnN0YW5jZS5nZXRfYWN0aXZlX3Rva2VucygpIG9yIHt9CgogICAgZmFtaWx5X2RhdGEgPSBnZXRfZmFtaWx5KGFwaV9rZXksIHRva2VucywgZmFtaWx5X2NvZGUpCiAgICBpZiBub3QgZmFtaWx5X2RhdGE6CiAgICAgICAgcHJpbnRfcGFuZWwoIlBlcmluZ2F0YW4iLCBmIkdhZ2FsIG1lbmdhbWJpbCBkYXRhIGZhbWlseSB1bnR1ayBrb2RlOiB7ZmFtaWx5X2NvZGV9IikKICAgICAgICBwYXVzZSgpCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgdGFyZ2V0X3ZhcmlhbnQgPSBOb25lCiAgICB0YXJnZXRfb3B0aW9uID0gTm9uZQogICAgZm9yIHZhcmlhbnQgaW4gZmFtaWx5X2RhdGFbInBhY2thZ2VfdmFyaWFudHMiXToKICAgICAgICBmb3Igb3B0aW9uIGluIHZhcmlhbnRbInBhY2thZ2Vfb3B0aW9ucyJdOgogICAgICAgICAgICBpZiBvcHRpb25bIm9yZGVyIl0gPT0gb3JkZXI6CiAgICAgICAgICAgICAgICB0YXJnZXRfdmFyaWFudCA9IHZhcmlhbnQKICAgICAgICAgICAgICAgIHRhcmdldF9vcHRpb24gPSBvcHRpb24KICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgaWYgdGFyZ2V0X29wdGlvbjoKICAgICAgICAgICAgYnJlYWsKCiAgICBpZiBub3QgdGFyZ2V0X29wdGlvbiBvciBub3QgdGFyZ2V0X3ZhcmlhbnQ6CiAgICAgICAgcHJpbnRfcGFuZWwoIlBlcmluZ2F0YW4iLCBmIk9wdGlvbiBvcmRlciB7b3JkZXJ9IHRpZGFrIGRpdGVtdWthbiBwYWRhIGZhbWlseSB7ZmFtaWx5X2NvZGV9IikKICAgICAgICBwYXVzZSgpCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgb3B0aW9uX25hbWUgPSB0YXJnZXRfb3B0aW9uWyJuYW1lIl0KICAgIG9wdGlvbl9wcmljZSA9IHRhcmdldF9vcHRpb25bInByaWNlIl0KICAgIHZhcmlhbnRfY29kZSA9IHRhcmdldF92YXJpYW50WyJwYWNrYWdlX3ZhcmlhbnRfY29kZSJdCgogICAgY29uc29sZS5ydWxlKCkKICAgIGNvbnNvbGUucHJpbnQoZiJbe3RoZW1lWyd0ZXh0X3RpdGxlJ119XVByb3NlcyBwZW1iZWxpYW46IHt0YXJnZXRfdmFyaWFudFsnbmFtZSddfSAtIHtvcmRlcn0uIHtvcHRpb25fbmFtZX0gLSBScHtvcHRpb25fcHJpY2V9Wy9dIikKCiAgICBkZWNveV9wYWNrYWdlX2RldGFpbCA9IE5vbmUKICAgIGlmIHVzZV9kZWNveToKICAgICAgICBkZWNveSA9IERlY295SW5zdGFuY2UuZ2V0X2RlY295KCJiYWxhbmNlIikKICAgICAgICBkZWNveV9wYWNrYWdlX2RldGFpbCA9IGdldF9wYWNrYWdlKGFwaV9rZXksIHRva2VucywgZGVjb3lbIm9wdGlvbl9jb2RlIl0pCiAgICAgICAgaWYgbm90IGRlY295X3BhY2thZ2VfZGV0YWlsOgogICAgICAgICAgICBwcmludF9wYW5lbCgiUGVyaW5nYXRhbiIsICJHYWdhbCBtZW11YXQgZGV0YWlsIHBha2V0IGRlY295IikKICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICB0cnk6CiAgICAgICAgdGFyZ2V0X3BhY2thZ2VfZGV0YWlsID0gZ2V0X3BhY2thZ2VfZGV0YWlscygKICAgICAgICAgICAgYXBpX2tleSwKICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICBmYW1pbHlfY29kZSwKICAgICAgICAgICAgdmFyaWFudF9jb2RlLAogICAgICAgICAgICBvcmRlciwKICAgICAgICAgICAgTm9uZSwKICAgICAgICAgICAgTm9uZSwKICAgICAgICApCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnRfcGFuZWwoIktlc2FsYWhhbiIsIGYiVGVyamFkaSBlcnJvciBzYWF0IG1lbmdhbWJpbCBkZXRhaWwgcGFrZXQ6IHtlfSIpCiAgICAgICAgZGVsYXlfaW5saW5lKGRlbGF5KQogICAgICAgIHJldHVybiBUcnVlCgogICAgcGF5bWVudF9pdGVtcyA9IFsKICAgICAgICBQYXltZW50SXRlbSgKICAgICAgICAgICAgaXRlbV9jb2RlPXRhcmdldF9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicGFja2FnZV9vcHRpb25fY29kZSJdLAogICAgICAgICAgICBwcm9kdWN0X3R5cGU9IiIsCiAgICAgICAgICAgIGl0ZW1fcHJpY2U9dGFyZ2V0X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdLAogICAgICAgICAgICBpdGVtX25hbWU9ZiJ7cmFuZGludCgxMDAwLCA5OTk5KX0ge3RhcmdldF9wYWNrYWdlX2RldGFpbFsncGFja2FnZV9vcHRpb24nXVsnbmFtZSddfSIsCiAgICAgICAgICAgIHRheD0wLAogICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb249dGFyZ2V0X3BhY2thZ2VfZGV0YWlsWyJ0b2tlbl9jb25maXJtYXRpb24iXSwKICAgICAgICApCiAgICBdCgogICAgaWYgdXNlX2RlY295IGFuZCBkZWNveV9wYWNrYWdlX2RldGFpbDoKICAgICAgICBwYXltZW50X2l0ZW1zLmFwcGVuZCgKICAgICAgICAgICAgUGF5bWVudEl0ZW0oCiAgICAgICAgICAgICAgICBpdGVtX2NvZGU9ZGVjb3lfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInBhY2thZ2Vfb3B0aW9uX2NvZGUiXSwKICAgICAgICAgICAgICAgIHByb2R1Y3RfdHlwZT0iIiwKICAgICAgICAgICAgICAgIGl0ZW1fcHJpY2U9ZGVjb3lfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInByaWNlIl0sCiAgICAgICAgICAgICAgICBpdGVtX25hbWU9ZiJ7cmFuZGludCgxMDAwLCA5OTk5KX0ge2RlY295X3BhY2thZ2VfZGV0YWlsWydwYWNrYWdlX29wdGlvbiddWyduYW1lJ119IiwKICAgICAgICAgICAgICAgIHRheD0wLAogICAgICAgICAgICAgICAgdG9rZW5fY29uZmlybWF0aW9uPWRlY295X3BhY2thZ2VfZGV0YWlsWyJ0b2tlbl9jb25maXJtYXRpb24iXSwKICAgICAgICAgICAgKQogICAgICAgICkKCiAgICBvdmVyd3JpdGVfYW1vdW50ID0gdGFyZ2V0X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdCiAgICBpZiB1c2VfZGVjb3kgYW5kIGRlY295X3BhY2thZ2VfZGV0YWlsOgogICAgICAgIG92ZXJ3cml0ZV9hbW91bnQgKz0gZGVjb3lfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInByaWNlIl0KCiAgICB0cnk6CiAgICAgICAgcmVzID0gc2V0dGxlbWVudF9iYWxhbmNlKAogICAgICAgICAgICBhcGlfa2V5LAogICAgICAgICAgICB0b2tlbnMsCiAgICAgICAgICAgIHBheW1lbnRfaXRlbXMsCiAgICAgICAgICAgICJCVVlfUEFDS0FHRSIsCiAgICAgICAgICAgIEZhbHNlLAogICAgICAgICAgICBvdmVyd3JpdGVfYW1vdW50LAogICAgICAgICkKCiAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgIT0gIlNVQ0NFU1MiOgogICAgICAgICAgICBlcnJvcl9tc2cgPSByZXMuZ2V0KCJtZXNzYWdlIiwgIlVua25vd24gZXJyb3IiKQogICAgICAgICAgICBpZiAiQml6ei1lcnIuQW1vdW50LlRvdGFsIiBpbiBlcnJvcl9tc2c6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2dfYXJyID0gZXJyb3JfbXNnLnNwbGl0KCI9IikKICAgICAgICAgICAgICAgIHZhbGlkX2Ftb3VudCA9IGludChlcnJvcl9tc2dfYXJyWzFdLnN0cmlwKCkpCiAgICAgICAgICAgICAgICBwcmludF9wYW5lbCgiSW5mb3JtYXNpIiwgZiJUb3RhbCBhbW91bnQgZGlzZXN1YWlrYW4gbWVuamFkaToge3ZhbGlkX2Ftb3VudH0iKQogICAgICAgICAgICAgICAgcmVzID0gc2V0dGxlbWVudF9iYWxhbmNlKAogICAgICAgICAgICAgICAgICAgIGFwaV9rZXksCiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICAgICAgICAgIHBheW1lbnRfaXRlbXMsCiAgICAgICAgICAgICAgICAgICAgIkJVWV9QQUNLQUdFIiwKICAgICAgICAgICAgICAgICAgICBGYWxzZSwKICAgICAgICAgICAgICAgICAgICB2YWxpZF9hbW91bnQsCiAgICAgICAgICAgICAgICApCgogICAgICAgIGlmIHJlcyBhbmQgcmVzLmdldCgic3RhdHVzIiwgIiIpID09ICJTVUNDRVNTIjoKICAgICAgICAgICAgcHJpbnRfcGFuZWwoIlN1a3NlcyIsICJQZW1iZWxpYW4gYmVyaGFzaWwiKQogICAgICAgICAgICBpZiBwYXVzZV9vbl9zdWNjZXNzOgogICAgICAgICAgICAgICAgY2hvaWNlID0gY29uc29sZS5pbnB1dCgiQXBha2FoIGluZ2luIG1lbGFuanV0a2FuPyAoeS9uKTogIikuc3RyaXAoKS5sb3dlcigpCiAgICAgICAgICAgICAgICBpZiBjaG9pY2UgPT0gJ24nOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludF9wYW5lbCgiS2VzYWxhaGFuIiwgZiJUZXJqYWRpIGVycm9yIHNhYXQgbWVtYnVhdCBvcmRlcjoge2V9IikKCiAgICBpZiBkZWxheSA+IDA6CiAgICAgICAgZGVsYXlfaW5saW5lKGRlbGF5KQoKICAgIHJldHVybiBUcnVlCgoKCmRlZiBwdXJjaGFzZV9ieV9mYW1pbHkoCiAgICBmYW1pbHlfY29kZTogc3RyLAogICAgdXNlX2RlY295OiBib29sLAogICAgcGF1c2Vfb25fc3VjY2VzczogYm9vbCA9IFRydWUsCiAgICBkZWxheV9zZWNvbmRzOiBpbnQgPSAwLAogICAgc3RhcnRfZnJvbV9vcHRpb246IGludCA9IDEsCiAgICBzYXZlX3RvX2pzb246IGJvb2wgPSBUcnVlLCAgIyBQYXJhbWV0ZXIgYmFydSB1bnR1ayBrb250cm9sIHBlbnlpbXBhbmFuIEpTT04KKToKICAgIHRoZW1lID0gZ2V0X3RoZW1lKCkKICAgIGVuc3VyZV9naXQoKQogICAgYWN0aXZlX3VzZXIgPSBBdXRoSW5zdGFuY2UuZ2V0X2FjdGl2ZV91c2VyKCkKICAgIHN1YnNjcmlwdGlvbl90eXBlID0gYWN0aXZlX3VzZXIuZ2V0KCJzdWJzY3JpcHRpb25fdHlwZSIsICIiKQogICAgCiAgICBhcGlfa2V5ID0gQXV0aEluc3RhbmNlLmFwaV9rZXkKICAgIHRva2VuczogZGljdCA9IEF1dGhJbnN0YW5jZS5nZXRfYWN0aXZlX3Rva2VucygpIG9yIHt9CgogICAgaWYgdXNlX2RlY295OgogICAgICAgIGRlY295ID0gRGVjb3lJbnN0YW5jZS5nZXRfZGVjb3koImJhbGFuY2UiKQogICAgICAgIGRlY295X3BhY2thZ2VfZGV0YWlsID0gZ2V0X3BhY2thZ2UoYXBpX2tleSwgdG9rZW5zLCBkZWNveVsib3B0aW9uX2NvZGUiXSkKICAgICAgICBpZiBub3QgZGVjb3lfcGFja2FnZV9kZXRhaWw6CiAgICAgICAgICAgIHByaW50X3BhbmVsKCJQZXJpbmdhdGFuIiwgIkdhZ2FsIG1lbXVhdCBkZXRhaWwgcGFrZXQgZGVjb3kiKQogICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIGJhbGFuY2VfdGhyZXNob2xkID0gZGVjb3lfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInByaWNlIl0KICAgICAgICBjb25zb2xlLnByaW50KGYiW3t0aGVtZVsndGV4dF93YXJuJ119XVBhc3Rpa2FuIHNpc2Egc2FsZG8gS1VSQU5HIERBUkkgUnB7YmFsYW5jZV90aHJlc2hvbGR9Wy9dIikKICAgICAgICBiYWxhbmNlX2Fuc3dlciA9IGNvbnNvbGUuaW5wdXQoIkFwYWthaCBpbmdpbiBtZWxhbmp1dGthbiBwZW1iZWxpYW4/ICh5L24pOiAiKS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICBpZiBiYWxhbmNlX2Fuc3dlciAhPSAieSI6CiAgICAgICAgICAgIHByaW50X3BhbmVsKCJJbmZvcm1hc2kiLCAiUGVtYmVsaWFuIGRpYmF0YWxrYW4iKQogICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgZmFtaWx5X2RhdGEgPSBnZXRfZmFtaWx5KGFwaV9rZXksIHRva2VucywgZmFtaWx5X2NvZGUpCiAgICBpZiBub3QgZmFtaWx5X2RhdGE6CiAgICAgICAgcHJpbnRfcGFuZWwoIlBlcmluZ2F0YW4iLCBmIkdhZ2FsIG1lbmdhbWJpbCBkYXRhIGZhbWlseSB1bnR1ayBrb2RlOiB7ZmFtaWx5X2NvZGV9IikKICAgICAgICBwYXVzZSgpCiAgICAgICAgcmV0dXJuIE5vbmUKICAgIAogICAgZmFtaWx5X25hbWUgPSBmYW1pbHlfZGF0YVsicGFja2FnZV9mYW1pbHkiXVsibmFtZSJdCiAgICB2YXJpYW50cyA9IGZhbWlseV9kYXRhWyJwYWNrYWdlX3ZhcmlhbnRzIl0KICAgIAogICAgY29uc29sZS5ydWxlKCkKICAgIHN1Y2Nlc3NmdWxfcHVyY2hhc2VzID0gW10KICAgIGZhaWxlZF9wdXJjaGFzZXMgPSBbXSAgIyBUYW1iYWhrYW4gdW50dWsgbWVuY2F0YXQgeWFuZyBnYWdhbAogICAgcGFja2FnZXNfY291bnQgPSBzdW0obGVuKHZbInBhY2thZ2Vfb3B0aW9ucyJdKSBmb3IgdiBpbiB2YXJpYW50cykKICAgIAogICAgcHVyY2hhc2VfY291bnQgPSAwCiAgICBzdGFydF9idXlpbmcgPSBzdGFydF9mcm9tX29wdGlvbiA8PSAxCgogICAgZm9yIHZhcmlhbnQgaW4gdmFyaWFudHM6CiAgICAgICAgdmFyaWFudF9uYW1lID0gdmFyaWFudFsibmFtZSJdCiAgICAgICAgZm9yIG9wdGlvbiBpbiB2YXJpYW50WyJwYWNrYWdlX29wdGlvbnMiXToKICAgICAgICAgICAgdG9rZW5zID0gQXV0aEluc3RhbmNlLmdldF9hY3RpdmVfdG9rZW5zKCkKICAgICAgICAgICAgb3B0aW9uX29yZGVyID0gb3B0aW9uWyJvcmRlciJdCiAgICAgICAgICAgIGlmIG5vdCBzdGFydF9idXlpbmcgYW5kIG9wdGlvbl9vcmRlciA9PSBzdGFydF9mcm9tX29wdGlvbjoKICAgICAgICAgICAgICAgIHN0YXJ0X2J1eWluZyA9IFRydWUKICAgICAgICAgICAgaWYgbm90IHN0YXJ0X2J1eWluZzoKICAgICAgICAgICAgICAgIGNvbnNvbGUucHJpbnQoZiJbe3RoZW1lWyd0ZXh0X3N1YiddfV1MZXdhdGkgb3B0aW9uIHtvcHRpb25fb3JkZXJ9LiB7b3B0aW9uWyduYW1lJ119Wy9dIikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICBvcHRpb25fbmFtZSA9IG9wdGlvblsibmFtZSJdCiAgICAgICAgICAgIG9wdGlvbl9wcmljZSA9IG9wdGlvblsicHJpY2UiXQogICAgICAgICAgICAKICAgICAgICAgICAgcHVyY2hhc2VfY291bnQgKz0gMQogICAgICAgICAgICBjb25zb2xlLnByaW50KGYiW3t0aGVtZVsndGV4dF90aXRsZSddfV1Qcm9zZXMgcGVtYmVsaWFuIHtwdXJjaGFzZV9jb3VudH0gZGFyaSB7cGFja2FnZXNfY291bnR9Wy9dIikKICAgICAgICAgICAgY29uc29sZS5wcmludChmIk1lbGFuanV0a2FuIHBlbWJlbGlhbjoge3ZhcmlhbnRfbmFtZX0gLSB7b3B0aW9uX29yZGVyfS4ge29wdGlvbl9uYW1lfSAtIFJwe29wdGlvbl9wcmljZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgcGF5bWVudF9pdGVtcyA9IFtdCiAgICAgICAgICAgIGVycm9yX21zZyA9ICIiCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiB1c2VfZGVjb3k6ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGRlY295ID0gRGVjb3lJbnN0YW5jZS5nZXRfZGVjb3koImJhbGFuY2UiKQogICAgICAgICAgICAgICAgICAgIGRlY295X3BhY2thZ2VfZGV0YWlsID0gZ2V0X3BhY2thZ2UoYXBpX2tleSwgdG9rZW5zLCBkZWNveVsib3B0aW9uX2NvZGUiXSkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgZGVjb3lfcGFja2FnZV9kZXRhaWw6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50X3BhbmVsKCJQZXJpbmdhdGFuIiwgIkdhZ2FsIG1lbXVhdCBkZXRhaWwgcGFrZXQgZGVjb3kiKQogICAgICAgICAgICAgICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0YXJnZXRfcGFja2FnZV9kZXRhaWwgPSBnZXRfcGFja2FnZV9kZXRhaWxzKAogICAgICAgICAgICAgICAgICAgIGFwaV9rZXksCiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICAgICAgICAgIGZhbWlseV9jb2RlLAogICAgICAgICAgICAgICAgICAgIHZhcmlhbnRbInBhY2thZ2VfdmFyaWFudF9jb2RlIl0sCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uWyJvcmRlciJdLAogICAgICAgICAgICAgICAgICAgIE5vbmUsCiAgICAgICAgICAgICAgICAgICAgTm9uZSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJFcnJvciBtZW5nYW1iaWwgZGV0YWlsIHBha2V0OiB7c3RyKGUpfSIKICAgICAgICAgICAgICAgIHByaW50X3BhbmVsKCJLZXNhbGFoYW4iLCBlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBmYWlsZWRfcHVyY2hhc2VzLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAgICAgInZhcmlhbnRfbmFtZSI6IHZhcmlhbnRfbmFtZSwKICAgICAgICAgICAgICAgICAgICAib3B0aW9uX29yZGVyIjogb3B0aW9uX29yZGVyLAogICAgICAgICAgICAgICAgICAgICJvcHRpb25fbmFtZSI6IG9wdGlvbl9uYW1lLAogICAgICAgICAgICAgICAgICAgICJwcmljZSI6IG9wdGlvbl9wcmljZSwKICAgICAgICAgICAgICAgICAgICAiZXJyb3IiOiBlcnJvcl9tc2csCiAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IGRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCgpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgY29uc29sZS5wcmludChmIkdhZ2FsIG1lbmdhbWJpbCBkZXRhaWwgdW50dWsge3ZhcmlhbnRfbmFtZX0gLSB7b3B0aW9uX25hbWV9LiBEaWxld2F0aSBzZW1lbnRhcmEuIikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBwYXltZW50X2l0ZW1zLmFwcGVuZCgKICAgICAgICAgICAgICAgIFBheW1lbnRJdGVtKAogICAgICAgICAgICAgICAgICAgIGl0ZW1fY29kZT10YXJnZXRfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInBhY2thZ2Vfb3B0aW9uX2NvZGUiXSwKICAgICAgICAgICAgICAgICAgICBwcm9kdWN0X3R5cGU9IiIsCiAgICAgICAgICAgICAgICAgICAgaXRlbV9wcmljZT10YXJnZXRfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInByaWNlIl0sCiAgICAgICAgICAgICAgICAgICAgaXRlbV9uYW1lPWYie3JhbmRpbnQoMTAwMCwgOTk5OSl9IHt0YXJnZXRfcGFja2FnZV9kZXRhaWxbJ3BhY2thZ2Vfb3B0aW9uJ11bJ25hbWUnXX0iLAogICAgICAgICAgICAgICAgICAgIHRheD0wLAogICAgICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbj10YXJnZXRfcGFja2FnZV9kZXRhaWxbInRva2VuX2NvbmZpcm1hdGlvbiJdLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICApCgogICAgICAgICAgICBpZiB1c2VfZGVjb3k6CiAgICAgICAgICAgICAgICBwYXltZW50X2l0ZW1zLmFwcGVuZCgKICAgICAgICAgICAgICAgICAgICBQYXltZW50SXRlbSgKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbV9jb2RlPWRlY295X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwYWNrYWdlX29wdGlvbl9jb2RlIl0sCiAgICAgICAgICAgICAgICAgICAgICAgIHByb2R1Y3RfdHlwZT0iIiwKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbV9wcmljZT1kZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicHJpY2UiXSwKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbV9uYW1lPWYie3JhbmRpbnQoMTAwMCwgOTk5OSl9IHtkZWNveV9wYWNrYWdlX2RldGFpbFsncGFja2FnZV9vcHRpb24nXVsnbmFtZSddfSIsCiAgICAgICAgICAgICAgICAgICAgICAgIHRheD0wLAogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb249ZGVjb3lfcGFja2FnZV9kZXRhaWxbInRva2VuX2NvbmZpcm1hdGlvbiJdLAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIG92ZXJ3cml0ZV9hbW91bnQgPSB0YXJnZXRfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInByaWNlIl0KICAgICAgICAgICAgaWYgdXNlX2RlY295IG9yIG92ZXJ3cml0ZV9hbW91bnQgPT0gMDoKICAgICAgICAgICAgICAgIG92ZXJ3cml0ZV9hbW91bnQgKz0gZGVjb3lfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInByaWNlIl0KCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlcyA9IHNldHRsZW1lbnRfYmFsYW5jZSgKICAgICAgICAgICAgICAgICAgICBhcGlfa2V5LAogICAgICAgICAgICAgICAgICAgIHRva2VucywKICAgICAgICAgICAgICAgICAgICBwYXltZW50X2l0ZW1zLAogICAgICAgICAgICAgICAgICAgICLwn6SRIiwKICAgICAgICAgICAgICAgICAgICBGYWxzZSwKICAgICAgICAgICAgICAgICAgICBvdmVyd3JpdGVfYW1vdW50PW92ZXJ3cml0ZV9hbW91bnQsCiAgICAgICAgICAgICAgICAgICAgdG9rZW5fY29uZmlybWF0aW9uX2lkeD0xCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHB1cmNoYXNlX3Jlc3VsdCA9IHsKICAgICAgICAgICAgICAgICAgICAidmFyaWFudF9uYW1lIjogdmFyaWFudF9uYW1lLAogICAgICAgICAgICAgICAgICAgICJvcHRpb25fb3JkZXIiOiBvcHRpb25fb3JkZXIsCiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbl9uYW1lIjogb3B0aW9uX25hbWUsCiAgICAgICAgICAgICAgICAgICAgInByaWNlIjogb3B0aW9uX3ByaWNlLAogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiIiwKICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6ICIiLAogICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiBkYXRldGltZS5ub3coKS5pc29mb3JtYXQoKSwKICAgICAgICAgICAgICAgICAgICAib3ZlcndyaXRlX2Ftb3VudCI6IG92ZXJ3cml0ZV9hbW91bnQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgIT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IHJlcy5nZXQoIm1lc3NhZ2UiLCAiIikKICAgICAgICAgICAgICAgICAgICBwdXJjaGFzZV9yZXN1bHRbInN0YXR1cyJdID0gIkZBSUxFRCIKICAgICAgICAgICAgICAgICAgICBwdXJjaGFzZV9yZXN1bHRbIm1lc3NhZ2UiXSA9IGVycm9yX21zZwogICAgICAgICAgICAgICAgICAgIGZhaWxlZF9wdXJjaGFzZXMuYXBwZW5kKHB1cmNoYXNlX3Jlc3VsdCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAiQml6ei1lcnIuQW1vdW50LlRvdGFsIiBpbiBlcnJvcl9tc2c6CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yX21zZ19hcnIgPSBlcnJvcl9tc2cuc3BsaXQoIj0iKQogICAgICAgICAgICAgICAgICAgICAgICB2YWxpZF9hbW91bnQgPSBpbnQoZXJyb3JfbXNnX2FyclsxXS5zdHJpcCgpKQogICAgICAgICAgICAgICAgICAgICAgICBwcmludF9wYW5lbCgiSW5mb3JtYXNpIiwgZiJUb3RhbCBhbW91bnQgZGlzZXN1YWlrYW4gbWVuamFkaToge3ZhbGlkX2Ftb3VudH0iKQogICAgICAgICAgICAgICAgICAgICAgICByZXMgPSBzZXR0bGVtZW50X2JhbGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcGlfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF5bWVudF9pdGVtcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJTSEFSRV9QQUNLQUdFIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcndyaXRlX2Ftb3VudD12YWxpZF9hbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb25faWR4PS0xCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgPT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVyY2hhc2VfcmVzdWx0WyJzdGF0dXMiXSA9ICJTVUNDRVNTIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVyY2hhc2VfcmVzdWx0WyJtZXNzYWdlIl0gPSAiUHVyY2hhc2Ugc3VjY2Vzc2Z1bCBhZnRlciBhbW91bnQgYWRqdXN0bWVudCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1cmNoYXNlX3Jlc3VsdFsiYWRqdXN0ZWRfYW1vdW50Il0gPSB2YWxpZF9hbW91bnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3NmdWxfcHVyY2hhc2VzLmFwcGVuZChwdXJjaGFzZV9yZXN1bHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludF9wYW5lbCgiU3Vrc2VzIiwgIlBlbWJlbGlhbiBiZXJoYXNpbCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXVzZV9vbl9zdWNjZXNzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IHJlcy5nZXQoIm1lc3NhZ2UiLCAiIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1cmNoYXNlX3Jlc3VsdFsic3RhdHVzIl0gPSAiRkFJTEVEIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVyY2hhc2VfcmVzdWx0WyJtZXNzYWdlIl0gPSBlcnJvcl9tc2cKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZF9wdXJjaGFzZXMuYXBwZW5kKHB1cmNoYXNlX3Jlc3VsdCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcHVyY2hhc2VfcmVzdWx0WyJzdGF0dXMiXSA9ICJTVUNDRVNTIgogICAgICAgICAgICAgICAgICAgIHB1cmNoYXNlX3Jlc3VsdFsibWVzc2FnZSJdID0gIlB1cmNoYXNlIHN1Y2Nlc3NmdWwiCiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc2Z1bF9wdXJjaGFzZXMuYXBwZW5kKHB1cmNoYXNlX3Jlc3VsdCkKICAgICAgICAgICAgICAgICAgICBwcmludF9wYW5lbCgiU3Vrc2VzIiwgIlBlbWJlbGlhbiBiZXJoYXNpbCIpCiAgICAgICAgICAgICAgICAgICAgaWYgcGF1c2Vfb25fc3VjY2VzczoKICAgICAgICAgICAgICAgICAgICAgICAgcGF1c2UoKQoKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJFcnJvciBtZW1idWF0IG9yZGVyOiB7c3RyKGUpfSIKICAgICAgICAgICAgICAgIHB1cmNoYXNlX3Jlc3VsdCA9IHsKICAgICAgICAgICAgICAgICAgICAidmFyaWFudF9uYW1lIjogdmFyaWFudF9uYW1lLAogICAgICAgICAgICAgICAgICAgICJvcHRpb25fb3JkZXIiOiBvcHRpb25fb3JkZXIsCiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbl9uYW1lIjogb3B0aW9uX25hbWUsCiAgICAgICAgICAgICAgICAgICAgInByaWNlIjogb3B0aW9uX3ByaWNlLAogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiRkFJTEVEIiwKICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IGVycm9yX21zZywKICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogZGF0ZXRpbWUubm93KCkuaXNvZm9ybWF0KCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZhaWxlZF9wdXJjaGFzZXMuYXBwZW5kKHB1cmNoYXNlX3Jlc3VsdCkKICAgICAgICAgICAgICAgIHByaW50X3BhbmVsKCJLZXNhbGFoYW4iLCBlcnJvcl9tc2cpCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLnJ1bGUoKQogICAgICAgICAgICBzaG91bGRfZGVsYXkgPSBlcnJvcl9tc2cgPT0gIiIgb3IgIkZhaWxlZCBjYWxsIGlwYWFzIHB1cmNoYXNlIiBpbiBlcnJvcl9tc2cKICAgICAgICAgICAgaWYgZGVsYXlfc2Vjb25kcyA+IDAgYW5kIHNob3VsZF9kZWxheToKICAgICAgICAgICAgICAgIGRlbGF5X2lubGluZShkZWxheV9zZWNvbmRzKQoKICAgICMgVGFtcGlsa2FuIGhhc2lsIGFraGlyCiAgICBjb25zb2xlLnByaW50KGYiW3t0aGVtZVsndGV4dF90aXRsZSddfV1GYW1pbHk6IHtmYW1pbHlfbmFtZX1bL10iKQogICAgY29uc29sZS5wcmludChmIlRvdGFsIGJlcmhhc2lsOiB7bGVuKHN1Y2Nlc3NmdWxfcHVyY2hhc2VzKX0iKQogICAgY29uc29sZS5wcmludChmIlRvdGFsIGdhZ2FsOiB7bGVuKGZhaWxlZF9wdXJjaGFzZXMpfSIpCiAgICAKICAgIGlmIHN1Y2Nlc3NmdWxfcHVyY2hhc2VzOgogICAgICAgIGNvbnNvbGUucnVsZSgpCiAgICAgICAgY29uc29sZS5wcmludCgiRGFmdGFyIHBlbWJlbGlhbiBzdWtzZXM6IikKICAgICAgICBmb3IgcHVyY2hhc2UgaW4gc3VjY2Vzc2Z1bF9wdXJjaGFzZXM6CiAgICAgICAgICAgIGNvbnNvbGUucHJpbnQoZiItIHtwdXJjaGFzZVsndmFyaWFudF9uYW1lJ119fHtwdXJjaGFzZVsnb3B0aW9uX29yZGVyJ119LiB7cHVyY2hhc2VbJ29wdGlvbl9uYW1lJ119IC0gUnB7cHVyY2hhc2VbJ3ByaWNlJ119IikKICAgIAogICAgaWYgZmFpbGVkX3B1cmNoYXNlczoKICAgICAgICBjb25zb2xlLnJ1bGUoKQogICAgICAgIGNvbnNvbGUucHJpbnQoIkRhZnRhciBwZW1iZWxpYW4gZ2FnYWw6IikKICAgICAgICBmb3IgcHVyY2hhc2UgaW4gZmFpbGVkX3B1cmNoYXNlczoKICAgICAgICAgICAgY29uc29sZS5wcmludChmIi0ge3B1cmNoYXNlWyd2YXJpYW50X25hbWUnXX18e3B1cmNoYXNlWydvcHRpb25fb3JkZXInXX0uIHtwdXJjaGFzZVsnb3B0aW9uX25hbWUnXX0gLSBScHtwdXJjaGFzZVsncHJpY2UnXX0iKQogICAgCiAgICAjIFNpbXBhbiBrZSBmaWxlIEpTT04gamlrYSBkaW1pbnRhCiAgICBpZiBzYXZlX3RvX2pzb246CiAgICAgICAgc2F2ZV9wdXJjaGFzZV9yZXN1bHRzX3RvX2pzb24oCiAgICAgICAgICAgIGZhbWlseV9jb2RlPWZhbWlseV9jb2RlLAogICAgICAgICAgICBmYW1pbHlfbmFtZT1mYW1pbHlfbmFtZSwKICAgICAgICAgICAgc3VjY2Vzc2Z1bF9wdXJjaGFzZXM9c3VjY2Vzc2Z1bF9wdXJjaGFzZXMsCiAgICAgICAgICAgIGZhaWxlZF9wdXJjaGFzZXM9ZmFpbGVkX3B1cmNoYXNlcywKICAgICAgICAgICAgdXNlX2RlY295PXVzZV9kZWNveSwKICAgICAgICAgICAgc3RhcnRfZnJvbV9vcHRpb249c3RhcnRfZnJvbV9vcHRpb24KICAgICAgICApCiAgICAKICAgIGNvbnNvbGUucnVsZSgpCiAgICBwYXVzZSgpCiAgICByZXR1cm4gTm9uZQoKCmRlZiBzYXZlX3B1cmNoYXNlX3Jlc3VsdHNfdG9fanNvbigKICAgIGZhbWlseV9jb2RlOiBzdHIsCiAgICBmYW1pbHlfbmFtZTogc3RyLAogICAgc3VjY2Vzc2Z1bF9wdXJjaGFzZXM6IGxpc3QsCiAgICBmYWlsZWRfcHVyY2hhc2VzOiBsaXN0LAogICAgdXNlX2RlY295OiBib29sLAogICAgc3RhcnRfZnJvbV9vcHRpb246IGludAopOgogICAgIiIiTWVueWltcGFuIGhhc2lsIHBlbWJlbGlhbiBrZSBmaWxlIEpTT04iIiIKICAgIAogICAgIyBCdWF0IGRpcmVrdG9yaSByZXN1bHRzIGppa2EgYmVsdW0gYWRhCiAgICByZXN1bHRzX2RpciA9ICJwdXJjaGFzZV9yZXN1bHRzIgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKHJlc3VsdHNfZGlyKToKICAgICAgICBvcy5tYWtlZGlycyhyZXN1bHRzX2RpcikKICAgIAogICAgIyBGb3JtYXQgbmFtYSBmaWxlCiAgICB0aW1lc3RhbXAgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJVklbSVkXyVIJU0lUyIpCiAgICBmaWxlbmFtZSA9IGYie2ZhbWlseV9jb2RlfV97dGltZXN0YW1wfS5qc29uIgogICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4ocmVzdWx0c19kaXIsIGZpbGVuYW1lKQogICAgCiAgICAjIFN0cnVrdHVyIGRhdGEgdW50dWsgZGlzaW1wYW4KICAgIHJlc3VsdF9kYXRhID0gewogICAgICAgICJtZXRhZGF0YSI6IHsKICAgICAgICAgICAgImZhbWlseV9jb2RlIjogZmFtaWx5X2NvZGUsCiAgICAgICAgICAgICJmYW1pbHlfbmFtZSI6IGZhbWlseV9uYW1lLAogICAgICAgICAgICAidGltZXN0YW1wIjogZGF0ZXRpbWUubm93KCkuaXNvZm9ybWF0KCksCiAgICAgICAgICAgICJ1c2VfZGVjb3kiOiB1c2VfZGVjb3ksCiAgICAgICAgICAgICJzdGFydF9mcm9tX29wdGlvbiI6IHN0YXJ0X2Zyb21fb3B0aW9uLAogICAgICAgICAgICAidG90YWxfc3VjY2Vzc2Z1bCI6IGxlbihzdWNjZXNzZnVsX3B1cmNoYXNlcyksCiAgICAgICAgICAgICJ0b3RhbF9mYWlsZWQiOiBsZW4oZmFpbGVkX3B1cmNoYXNlcykKICAgICAgICB9LAogICAgICAgICJzdWNjZXNzZnVsX3B1cmNoYXNlcyI6IHN1Y2Nlc3NmdWxfcHVyY2hhc2VzLAogICAgICAgICJmYWlsZWRfcHVyY2hhc2VzIjogZmFpbGVkX3B1cmNoYXNlcywKICAgICAgICAic3VtbWFyeSI6IHsKICAgICAgICAgICAgInN1Y2Nlc3NfcmF0ZSI6IGYie2xlbihzdWNjZXNzZnVsX3B1cmNoYXNlcyl9L3tsZW4oc3VjY2Vzc2Z1bF9wdXJjaGFzZXMpICsgbGVuKGZhaWxlZF9wdXJjaGFzZXMpfSIsCiAgICAgICAgICAgICJ0b3RhbF9hbW91bnRfc3VjY2Vzc2Z1bCI6IHN1bShwLmdldCgicHJpY2UiLCAwKSBmb3IgcCBpbiBzdWNjZXNzZnVsX3B1cmNoYXNlcyksCiAgICAgICAgICAgICJ0b3RhbF9hbW91bnRfZmFpbGVkIjogc3VtKHAuZ2V0KCJwcmljZSIsIDApIGZvciBwIGluIGZhaWxlZF9wdXJjaGFzZXMpCiAgICAgICAgfQogICAgfQogICAgCiAgICAjIFNpbXBhbiBrZSBmaWxlIEpTT04KICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAganNvbi5kdW1wKHJlc3VsdF9kYXRhLCBmLCBlbnN1cmVfYXNjaWk9RmFsc2UsIGluZGVudD0yKQogICAgICAgIAogICAgICAgIGNvbnNvbGUucHJpbnQoZiJbZ3JlZW5d4pyTIEhhc2lsIHBlbWJlbGlhbiBkaXNpbXBhbiBrZToge2ZpbGVwYXRofVsvZ3JlZW5dIikKICAgICAgICAKICAgICAgICAjIEp1Z2Egc2ltcGFuIGRlbmdhbiBuYW1hIGZhbWlseV9jb2RlIHNhamEgKG92ZXJ3cml0ZSB5YW5nIHRlcmJhcnUpCiAgICAgICAgbGF0ZXN0X2ZpbGVwYXRoID0gb3MucGF0aC5qb2luKHJlc3VsdHNfZGlyLCBmIntmYW1pbHlfY29kZX1fbGF0ZXN0Lmpzb24iKQogICAgICAgIHdpdGggb3BlbihsYXRlc3RfZmlsZXBhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAganNvbi5kdW1wKHJlc3VsdF9kYXRhLCBmLCBlbnN1cmVfYXNjaWk9RmFsc2UsIGluZGVudD0yKQogICAgICAgIAogICAgICAgIGNvbnNvbGUucHJpbnQoZiJbZ3JlZW5d4pyTIFNhbGluYW4gdGVyYmFydSBkaXNpbXBhbiBrZToge2xhdGVzdF9maWxlcGF0aH1bL2dyZWVuXSIpCiAgICAgICAgCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgY29uc29sZS5wcmludChmIltyZWRd4pyXIEdhZ2FsIG1lbnlpbXBhbiBoYXNpbCBrZSBKU09OOiB7ZX1bL3JlZF0iKQogICAgCiAgICByZXR1cm4gZmlsZXBhdGgKCgpkZWYgcHVyY2hhc2Vfbl90aW1lcygKICAgIG46IGludCwKICAgIGZhbWlseV9jb2RlOiBzdHIsCiAgICB2YXJpYW50X2NvZGU6IHN0ciwKICAgIG9wdGlvbl9vcmRlcjogaW50LAogICAgdXNlX2RlY295OiBib29sLAogICAgZGVsYXlfc2Vjb25kczogaW50ID0gMCwKICAgIHBhdXNlX29uX3N1Y2Nlc3M6IGJvb2wgPSBGYWxzZSwKICAgIHRva2VuX2NvbmZpcm1hdGlvbl9pZHg6IGludCA9IDAsCik6CiAgICB0aGVtZSA9IGdldF90aGVtZSgpCiAgICBlbnN1cmVfZ2l0KCkKICAgIGFjdGl2ZV91c2VyID0gQXV0aEluc3RhbmNlLmdldF9hY3RpdmVfdXNlcigpCiAgICBzdWJzY3JpcHRpb25fdHlwZSA9IGFjdGl2ZV91c2VyLmdldCgic3Vic2NyaXB0aW9uX3R5cGUiLCAiIikKICAgIAogICAgYXBpX2tleSA9IEF1dGhJbnN0YW5jZS5hcGlfa2V5CiAgICB0b2tlbnM6IGRpY3QgPSBBdXRoSW5zdGFuY2UuZ2V0X2FjdGl2ZV90b2tlbnMoKSBvciB7fQoKICAgIGlmIHVzZV9kZWNveToKICAgICAgICBkZWNveSA9IERlY295SW5zdGFuY2UuZ2V0X2RlY295KCJiYWxhbmNlIikKICAgICAgICBkZWNveV9wYWNrYWdlX2RldGFpbCA9IGdldF9wYWNrYWdlKGFwaV9rZXksIHRva2VucywgZGVjb3lbIm9wdGlvbl9jb2RlIl0pCiAgICAgICAgaWYgbm90IGRlY295X3BhY2thZ2VfZGV0YWlsOgogICAgICAgICAgICBwcmludF9wYW5lbCgiUGVyaW5nYXRhbiIsICJHYWdhbCBtZW11YXQgZGV0YWlsIHBha2V0IGRlY295IikKICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICBiYWxhbmNlX3RocmVzaG9sZCA9IGRlY295X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdCiAgICAgICAgY29uc29sZS5wcmludChmIlt7dGhlbWVbJ3RleHRfd2FybiddfV1QYXN0aWthbiBzaXNhIHNhbGRvIEtVUkFORyBEQVJJIFJwe2JhbGFuY2VfdGhyZXNob2xkfVsvXSIpCiAgICAgICAgYmFsYW5jZV9hbnN3ZXIgPSBjb25zb2xlLmlucHV0KCJBcGFrYWggaW5naW4gbWVsYW5qdXRrYW4gcGVtYmVsaWFuPyAoeS9uKTogIikuc3RyaXAoKS5sb3dlcigpCiAgICAgICAgaWYgYmFsYW5jZV9hbnN3ZXIgIT0gInkiOgogICAgICAgICAgICBwcmludF9wYW5lbCgiSW5mb3JtYXNpIiwgIlBlbWJlbGlhbiBkaWJhdGFsa2FuIikKICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgIGZhbWlseV9kYXRhID0gZ2V0X2ZhbWlseShhcGlfa2V5LCB0b2tlbnMsIGZhbWlseV9jb2RlKQogICAgaWYgbm90IGZhbWlseV9kYXRhOgogICAgICAgIHByaW50X3BhbmVsKCJQZXJpbmdhdGFuIiwgZiJHYWdhbCBtZW5nYW1iaWwgZGF0YSBmYW1pbHkgdW50dWsga29kZToge2ZhbWlseV9jb2RlfSIpCiAgICAgICAgcGF1c2UoKQogICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGZhbWlseV9uYW1lID0gZmFtaWx5X2RhdGFbInBhY2thZ2VfZmFtaWx5Il1bIm5hbWUiXQogICAgdmFyaWFudHMgPSBmYW1pbHlfZGF0YVsicGFja2FnZV92YXJpYW50cyJdCiAgICB0YXJnZXRfdmFyaWFudCA9IG5leHQoKHYgZm9yIHYgaW4gdmFyaWFudHMgaWYgdlsicGFja2FnZV92YXJpYW50X2NvZGUiXSA9PSB2YXJpYW50X2NvZGUpLCBOb25lKQogICAgaWYgbm90IHRhcmdldF92YXJpYW50OgogICAgICAgIHByaW50X3BhbmVsKCJQZXJpbmdhdGFuIiwgZiJWYXJpYW50IGNvZGUge3ZhcmlhbnRfY29kZX0gdGlkYWsgZGl0ZW11a2FuIHBhZGEgZmFtaWx5IHtmYW1pbHlfbmFtZX0iKQogICAgICAgIHBhdXNlKCkKICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICB0YXJnZXRfb3B0aW9uID0gbmV4dCgobyBmb3IgbyBpbiB0YXJnZXRfdmFyaWFudFsicGFja2FnZV9vcHRpb25zIl0gaWYgb1sib3JkZXIiXSA9PSBvcHRpb25fb3JkZXIpLCBOb25lKQogICAgaWYgbm90IHRhcmdldF9vcHRpb246CiAgICAgICAgcHJpbnRfcGFuZWwoIlBlcmluZ2F0YW4iLCBmIk9wdGlvbiBvcmRlciB7b3B0aW9uX29yZGVyfSB0aWRhayBkaXRlbXVrYW4gcGFkYSB2YXJpYW50IHt0YXJnZXRfdmFyaWFudFsnbmFtZSddfSIpCiAgICAgICAgcGF1c2UoKQogICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIG9wdGlvbl9uYW1lID0gdGFyZ2V0X29wdGlvblsibmFtZSJdCiAgICBvcHRpb25fcHJpY2UgPSB0YXJnZXRfb3B0aW9uWyJwcmljZSJdCiAgICBjb25zb2xlLnJ1bGUoKQogICAgc3VjY2Vzc2Z1bF9wdXJjaGFzZXMgPSBbXQogICAgCiAgICBmb3IgaSBpbiByYW5nZShuKToKICAgICAgICBjb25zb2xlLnByaW50KGYiW3t0aGVtZVsndGV4dF90aXRsZSddfV1Qcm9zZXMgcGVtYmVsaWFuIHtpICsgMX0gZGFyaSB7bn1bL10iKQogICAgICAgIGNvbnNvbGUucHJpbnQoZiJNZWxhbmp1dGthbiBwZW1iZWxpYW46IHt0YXJnZXRfdmFyaWFudFsnbmFtZSddfSAtIHtvcHRpb25fb3JkZXJ9LiB7b3B0aW9uX25hbWV9IC0gUnB7b3B0aW9uX3ByaWNlfSIpCiAgICAgICAgCiAgICAgICAgYXBpX2tleSA9IEF1dGhJbnN0YW5jZS5hcGlfa2V5CiAgICAgICAgdG9rZW5zOiBkaWN0ID0gQXV0aEluc3RhbmNlLmdldF9hY3RpdmVfdG9rZW5zKCkgb3Ige30KICAgICAgICBwYXltZW50X2l0ZW1zID0gW10KICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHVzZV9kZWNveToKICAgICAgICAgICAgICAgIGRlY295ID0gRGVjb3lJbnN0YW5jZS5nZXRfZGVjb3koImJhbGFuY2UiKQogICAgICAgICAgICAgICAgZGVjb3lfcGFja2FnZV9kZXRhaWwgPSBnZXRfcGFja2FnZShhcGlfa2V5LCB0b2tlbnMsIGRlY295WyJvcHRpb25fY29kZSJdKQogICAgICAgICAgICAgICAgaWYgbm90IGRlY295X3BhY2thZ2VfZGV0YWlsOgogICAgICAgICAgICAgICAgICAgIHByaW50X3BhbmVsKCJQZXJpbmdhdGFuIiwgIkdhZ2FsIG1lbXVhdCBkZXRhaWwgcGFrZXQgZGVjb3kiKQogICAgICAgICAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHRhcmdldF9wYWNrYWdlX2RldGFpbCA9IGdldF9wYWNrYWdlX2RldGFpbHMoCiAgICAgICAgICAgICAgICBhcGlfa2V5LAogICAgICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICAgICAgZmFtaWx5X2NvZGUsCiAgICAgICAgICAgICAgICB0YXJnZXRfdmFyaWFudFsicGFja2FnZV92YXJpYW50X2NvZGUiXSwKICAgICAgICAgICAgICAgIHRhcmdldF9vcHRpb25bIm9yZGVyIl0sCiAgICAgICAgICAgICAgICBOb25lLAogICAgICAgICAgICAgICAgTm9uZSwKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnRfcGFuZWwoIktlc2FsYWhhbiIsIGYiVGVyamFkaSBlcnJvciBzYWF0IG1lbmdhbWJpbCBkZXRhaWwgcGFrZXQ6IHtlfSIpCiAgICAgICAgICAgIGNvbnNvbGUucHJpbnQoZiJHYWdhbCBtZW5nYW1iaWwgZGV0YWlsIHVudHVrIHt0YXJnZXRfdmFyaWFudFsnbmFtZSddfSAtIHtvcHRpb25fbmFtZX0uIERpbGV3YXRpIHNlbWVudGFyYS4iKQogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBwYXltZW50X2l0ZW1zLmFwcGVuZCgKICAgICAgICAgICAgUGF5bWVudEl0ZW0oCiAgICAgICAgICAgICAgICBpdGVtX2NvZGU9dGFyZ2V0X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwYWNrYWdlX29wdGlvbl9jb2RlIl0sCiAgICAgICAgICAgICAgICBwcm9kdWN0X3R5cGU9IiIsCiAgICAgICAgICAgICAgICBpdGVtX3ByaWNlPXRhcmdldF9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicHJpY2UiXSwKICAgICAgICAgICAgICAgIGl0ZW1fbmFtZT1mIntyYW5kaW50KDEwMDAsIDk5OTkpfSB7dGFyZ2V0X3BhY2thZ2VfZGV0YWlsWydwYWNrYWdlX29wdGlvbiddWyduYW1lJ119IiwKICAgICAgICAgICAgICAgIHRheD0wLAogICAgICAgICAgICAgICAgdG9rZW5fY29uZmlybWF0aW9uPXRhcmdldF9wYWNrYWdlX2RldGFpbFsidG9rZW5fY29uZmlybWF0aW9uIl0sCiAgICAgICAgICAgICkKICAgICAgICApCgogICAgICAgIGlmIHVzZV9kZWNveToKICAgICAgICAgICAgcGF5bWVudF9pdGVtcy5hcHBlbmQoCiAgICAgICAgICAgICAgICBQYXltZW50SXRlbSgKICAgICAgICAgICAgICAgICAgICBpdGVtX2NvZGU9ZGVjb3lfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInBhY2thZ2Vfb3B0aW9uX2NvZGUiXSwKICAgICAgICAgICAgICAgICAgICBwcm9kdWN0X3R5cGU9IiIsCiAgICAgICAgICAgICAgICAgICAgaXRlbV9wcmljZT1kZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicHJpY2UiXSwKICAgICAgICAgICAgICAgICAgICBpdGVtX25hbWU9ZiJ7cmFuZGludCgxMDAwLCA5OTk5KX0ge2RlY295X3BhY2thZ2VfZGV0YWlsWydwYWNrYWdlX29wdGlvbiddWyduYW1lJ119IiwKICAgICAgICAgICAgICAgICAgICB0YXg9MCwKICAgICAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb249ZGVjb3lfcGFja2FnZV9kZXRhaWxbInRva2VuX2NvbmZpcm1hdGlvbiJdLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICApCiAgICAgICAgCiAgICAgICAgb3ZlcndyaXRlX2Ftb3VudCA9IHRhcmdldF9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicHJpY2UiXQogICAgICAgIGlmIHVzZV9kZWNveToKICAgICAgICAgICAgb3ZlcndyaXRlX2Ftb3VudCArPSBkZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicHJpY2UiXQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlcyA9IHNldHRsZW1lbnRfYmFsYW5jZSgKICAgICAgICAgICAgICAgIGFwaV9rZXksCiAgICAgICAgICAgICAgICB0b2tlbnMsCiAgICAgICAgICAgICAgICBwYXltZW50X2l0ZW1zLAogICAgICAgICAgICAgICAgIvCfpKsiLAogICAgICAgICAgICAgICAgRmFsc2UsCiAgICAgICAgICAgICAgICBvdmVyd3JpdGVfYW1vdW50PW92ZXJ3cml0ZV9hbW91bnQsCiAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb25faWR4PXRva2VuX2NvbmZpcm1hdGlvbl9pZHgKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgIT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gcmVzLmdldCgibWVzc2FnZSIsICJVbmtub3duIGVycm9yIikKICAgICAgICAgICAgICAgIGlmICJCaXp6LWVyci5BbW91bnQuVG90YWwiIGluIGVycm9yX21zZzoKICAgICAgICAgICAgICAgICAgICBlcnJvcl9tc2dfYXJyID0gZXJyb3JfbXNnLnNwbGl0KCI9IikKICAgICAgICAgICAgICAgICAgICB2YWxpZF9hbW91bnQgPSBpbnQoZXJyb3JfbXNnX2FyclsxXS5zdHJpcCgpKQogICAgICAgICAgICAgICAgICAgIHByaW50X3BhbmVsKCJJbmZvcm1hc2kiLCBmIlRvdGFsIGFtb3VudCBkaXNlc3VhaWthbiBtZW5qYWRpOiB7dmFsaWRfYW1vdW50fSIpCiAgICAgICAgICAgICAgICAgICAgcmVzID0gc2V0dGxlbWVudF9iYWxhbmNlKAogICAgICAgICAgICAgICAgICAgICAgICBhcGlfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMsCiAgICAgICAgICAgICAgICAgICAgICAgIHBheW1lbnRfaXRlbXMsCiAgICAgICAgICAgICAgICAgICAgICAgICLwn6SrIiwKICAgICAgICAgICAgICAgICAgICAgICAgRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJ3cml0ZV9hbW91bnQ9dmFsaWRfYW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb25faWR4PXRva2VuX2NvbmZpcm1hdGlvbl9pZHgKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgPT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzZnVsX3B1cmNoYXNlcy5hcHBlbmQoZiJ7dGFyZ2V0X3ZhcmlhbnRbJ25hbWUnXX18e29wdGlvbl9vcmRlcn0uIHtvcHRpb25fbmFtZX0gLSBScHtvcHRpb25fcHJpY2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRfcGFuZWwoIlN1a3NlcyIsICJQZW1iZWxpYW4gYmVyaGFzaWwiKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXVzZV9vbl9zdWNjZXNzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc3VjY2Vzc2Z1bF9wdXJjaGFzZXMuYXBwZW5kKGYie3RhcmdldF92YXJpYW50WyduYW1lJ119fHtvcHRpb25fb3JkZXJ9LiB7b3B0aW9uX25hbWV9IC0gUnB7b3B0aW9uX3ByaWNlfSIpCiAgICAgICAgICAgICAgICBwcmludF9wYW5lbCgiU3Vrc2VzIiwgIlBlbWJlbGlhbiBiZXJoYXNpbCIpCiAgICAgICAgICAgICAgICBpZiBwYXVzZV9vbl9zdWNjZXNzOgogICAgICAgICAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50X3BhbmVsKCJLZXNhbGFoYW4iLCBmIlRlcmphZGkgZXJyb3Igc2FhdCBtZW1idWF0IG9yZGVyOiB7ZX0iKQogICAgICAgIAogICAgICAgIGNvbnNvbGUucnVsZSgpCgogICAgICAgIGlmIGRlbGF5X3NlY29uZHMgPiAwIGFuZCBpIDwgbiAtIDE6CiAgICAgICAgICAgIGRlbGF5X2lubGluZShkZWxheV9zZWNvbmRzKQoKICAgIGNvbnNvbGUucHJpbnQoZiJbe3RoZW1lWyd0ZXh0X3RpdGxlJ119XVRvdGFsIHBlbWJlbGlhbiBzdWtzZXMge2xlbihzdWNjZXNzZnVsX3B1cmNoYXNlcyl9L3tufVsvXSIpCiAgICBjb25zb2xlLnByaW50KGYiRmFtaWx5OiB7ZmFtaWx5X25hbWV9XG5WYXJpYW50OiB7dGFyZ2V0X3ZhcmlhbnRbJ25hbWUnXX1cbk9wdGlvbjoge29wdGlvbl9vcmRlcn0uIHtvcHRpb25fbmFtZX0gLSBScHtvcHRpb25fcHJpY2V9IikKICAgIGlmIHN1Y2Nlc3NmdWxfcHVyY2hhc2VzOgogICAgICAgIGNvbnNvbGUucnVsZSgpCiAgICAgICAgY29uc29sZS5wcmludCgiRGFmdGFyIHBlbWJlbGlhbiBzdWtzZXM6IikKICAgICAgICBmb3IgaWR4LCBwdXJjaGFzZSBpbiBlbnVtZXJhdGUoc3VjY2Vzc2Z1bF9wdXJjaGFzZXMsIHN0YXJ0PTEpOgogICAgICAgICAgICBjb25zb2xlLnByaW50KGYie2lkeH0uIHtwdXJjaGFzZX0iKQogICAgY29uc29sZS5ydWxlKCkKICAgIHBhdXNlKCkKICAgIHJldHVybiBUcnVlCgoKZGVmIHB1cmNoYXNlX25fdGltZXNfYnlfb3B0aW9uX2NvZGUoCiAgICBuOiBpbnQsCiAgICBvcHRpb25fY29kZTogc3RyLAogICAgdXNlX2RlY295OiBib29sLAogICAgZGVsYXlfc2Vjb25kczogaW50ID0gMCwKICAgIHBhdXNlX29uX3N1Y2Nlc3M6IGJvb2wgPSBGYWxzZSwKICAgIHRva2VuX2NvbmZpcm1hdGlvbl9pZHg6IGludCA9IDAsCik6CiAgICB0aGVtZSA9IGdldF90aGVtZSgpCiAgICBlbnN1cmVfZ2l0KCkKICAgIGFjdGl2ZV91c2VyID0gQXV0aEluc3RhbmNlLmdldF9hY3RpdmVfdXNlcigpCiAgICBzdWJzY3JpcHRpb25fdHlwZSA9IGFjdGl2ZV91c2VyLmdldCgic3Vic2NyaXB0aW9uX3R5cGUiLCAiIikKICAgIAogICAgYXBpX2tleSA9IEF1dGhJbnN0YW5jZS5hcGlfa2V5CiAgICB0b2tlbnM6IGRpY3QgPSBBdXRoSW5zdGFuY2UuZ2V0X2FjdGl2ZV90b2tlbnMoKSBvciB7fQoKICAgIGlmIHVzZV9kZWNveToKICAgICAgICBkZWNveSA9IERlY295SW5zdGFuY2UuZ2V0X2RlY295KCJiYWxhbmNlIikKICAgICAgICBkZWNveV9wYWNrYWdlX2RldGFpbCA9IGdldF9wYWNrYWdlKGFwaV9rZXksIHRva2VucywgZGVjb3lbIm9wdGlvbl9jb2RlIl0pCiAgICAgICAgaWYgbm90IGRlY295X3BhY2thZ2VfZGV0YWlsOgogICAgICAgICAgICBwcmludF9wYW5lbCgiUGVyaW5nYXRhbiIsICJHYWdhbCBtZW11YXQgZGV0YWlsIHBha2V0IGRlY295IikKICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICBiYWxhbmNlX3RocmVzaG9sZCA9IGRlY295X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdCiAgICAgICAgY29uc29sZS5wcmludChmIlt7dGhlbWVbJ3RleHRfd2FybiddfV1QYXN0aWthbiBzaXNhIHNhbGRvIEtVUkFORyBEQVJJIFJwe2JhbGFuY2VfdGhyZXNob2xkfVsvXSIpCiAgICAgICAgYmFsYW5jZV9hbnN3ZXIgPSBjb25zb2xlLmlucHV0KCJBcGFrYWggaW5naW4gbWVsYW5qdXRrYW4gcGVtYmVsaWFuPyAoeS9uKTogIikuc3RyaXAoKS5sb3dlcigpCiAgICAgICAgaWYgYmFsYW5jZV9hbnN3ZXIgIT0gInkiOgogICAgICAgICAgICBwcmludF9wYW5lbCgiSW5mb3JtYXNpIiwgIlBlbWJlbGlhbiBkaWJhdGFsa2FuIikKICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICBjb25zb2xlLnJ1bGUoKQogICAgc3VjY2Vzc2Z1bF9wdXJjaGFzZXMgPSBbXQogICAgCiAgICBmb3IgaSBpbiByYW5nZShuKToKICAgICAgICBjb25zb2xlLnByaW50KGYiW3t0aGVtZVsndGV4dF90aXRsZSddfV1Qcm9zZXMgcGVtYmVsaWFuIHtpICsgMX0gZGFyaSB7bn1bL10iKQogICAgICAgIAogICAgICAgIGFwaV9rZXkgPSBBdXRoSW5zdGFuY2UuYXBpX2tleQogICAgICAgIHRva2VuczogZGljdCA9IEF1dGhJbnN0YW5jZS5nZXRfYWN0aXZlX3Rva2VucygpIG9yIHt9CiAgICAgICAgcGF5bWVudF9pdGVtcyA9IFtdCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiB1c2VfZGVjb3k6CiAgICAgICAgICAgICAgICBkZWNveSA9IERlY295SW5zdGFuY2UuZ2V0X2RlY295KCJiYWxhbmNlIikKICAgICAgICAgICAgICAgIGRlY295X3BhY2thZ2VfZGV0YWlsID0gZ2V0X3BhY2thZ2UoYXBpX2tleSwgdG9rZW5zLCBkZWNveVsib3B0aW9uX2NvZGUiXSkKICAgICAgICAgICAgICAgIGlmIG5vdCBkZWNveV9wYWNrYWdlX2RldGFpbDoKICAgICAgICAgICAgICAgICAgICBwcmludF9wYW5lbCgiUGVyaW5nYXRhbiIsICJHYWdhbCBtZW11YXQgZGV0YWlsIHBha2V0IGRlY295IikKICAgICAgICAgICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICB0YXJnZXRfcGFja2FnZV9kZXRhaWwgPSBnZXRfcGFja2FnZShhcGlfa2V5LCB0b2tlbnMsIG9wdGlvbl9jb2RlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnRfcGFuZWwoIktlc2FsYWhhbiIsIGYiVGVyamFkaSBlcnJvciBzYWF0IG1lbmdhbWJpbCBkZXRhaWwgcGFrZXQ6IHtlfSIpCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHBheW1lbnRfaXRlbXMuYXBwZW5kKAogICAgICAgICAgICBQYXltZW50SXRlbSgKICAgICAgICAgICAgICAgIGl0ZW1fY29kZT10YXJnZXRfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInBhY2thZ2Vfb3B0aW9uX2NvZGUiXSwKICAgICAgICAgICAgICAgIHByb2R1Y3RfdHlwZT0iIiwKICAgICAgICAgICAgICAgIGl0ZW1fcHJpY2U9dGFyZ2V0X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdLAogICAgICAgICAgICAgICAgaXRlbV9uYW1lPWYie3JhbmRpbnQoMTAwMCwgOTk5OSl9IHt0YXJnZXRfcGFja2FnZV9kZXRhaWxbJ3BhY2thZ2Vfb3B0aW9uJ11bJ25hbWUnXX0iLAogICAgICAgICAgICAgICAgdGF4PTAsCiAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb249dGFyZ2V0X3BhY2thZ2VfZGV0YWlsWyJ0b2tlbl9jb25maXJtYXRpb24iXSwKICAgICAgICAgICAgKQogICAgICAgICkKCiAgICAgICAgaWYgdXNlX2RlY295OgogICAgICAgICAgICBwYXltZW50X2l0ZW1zLmFwcGVuZCgKICAgICAgICAgICAgICAgIFBheW1lbnRJdGVtKAogICAgICAgICAgICAgICAgICAgIGl0ZW1fY29kZT1kZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicGFja2FnZV9vcHRpb25fY29kZSJdLAogICAgICAgICAgICAgICAgICAgIHByb2R1Y3RfdHlwZT0iIiwKICAgICAgICAgICAgICAgICAgICBpdGVtX3ByaWNlPWRlY295X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdLAogICAgICAgICAgICAgICAgICAgIGl0ZW1fbmFtZT1mIntyYW5kaW50KDEwMDAsIDk5OTkpfSB7ZGVjb3lfcGFja2FnZV9kZXRhaWxbJ3BhY2thZ2Vfb3B0aW9uJ11bJ25hbWUnXX0iLAogICAgICAgICAgICAgICAgICAgIHRheD0wLAogICAgICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbj1kZWNveV9wYWNrYWdlX2RldGFpbFsidG9rZW5fY29uZmlybWF0aW9uIl0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICBvdmVyd3JpdGVfYW1vdW50ID0gdGFyZ2V0X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdCiAgICAgICAgaWYgdXNlX2RlY295OgogICAgICAgICAgICBvdmVyd3JpdGVfYW1vdW50ICs9IGRlY295X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdCgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzID0gc2V0dGxlbWVudF9iYWxhbmNlKAogICAgICAgICAgICAgICAgYXBpX2tleSwKICAgICAgICAgICAgICAgIHRva2VucywKICAgICAgICAgICAgICAgIHBheW1lbnRfaXRlbXMsCiAgICAgICAgICAgICAgICAi8J+kqyIsCiAgICAgICAgICAgICAgICBGYWxzZSwKICAgICAgICAgICAgICAgIG92ZXJ3cml0ZV9hbW91bnQ9b3ZlcndyaXRlX2Ftb3VudCwKICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbl9pZHg9dG9rZW5fY29uZmlybWF0aW9uX2lkeAogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXMgYW5kIHJlcy5nZXQoInN0YXR1cyIsICIiKSAhPSAiU1VDQ0VTUyI6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXMuZ2V0KCJtZXNzYWdlIiwgIlVua25vd24gZXJyb3IiKQogICAgICAgICAgICAgICAgaWYgIkJpenotZXJyLkFtb3VudC5Ub3RhbCIgaW4gZXJyb3JfbXNnOgogICAgICAgICAgICAgICAgICAgIGVycm9yX21zZ19hcnIgPSBlcnJvcl9tc2cuc3BsaXQoIj0iKQogICAgICAgICAgICAgICAgICAgIHZhbGlkX2Ftb3VudCA9IGludChlcnJvcl9tc2dfYXJyWzFdLnN0cmlwKCkpCiAgICAgICAgICAgICAgICAgICAgcHJpbnRfcGFuZWwoIkluZm9ybWFzaSIsIGYiVG90YWwgYW1vdW50IGRpc2VzdWFpa2FuIG1lbmphZGk6IHt2YWxpZF9hbW91bnR9IikKICAgICAgICAgICAgICAgICAgICByZXMgPSBzZXR0bGVtZW50X2JhbGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICAgIGFwaV9rZXksCiAgICAgICAgICAgICAgICAgICAgICAgIHRva2VucywKICAgICAgICAgICAgICAgICAgICAgICAgcGF5bWVudF9pdGVtcywKICAgICAgICAgICAgICAgICAgICAgICAgIvCfpKsiLAogICAgICAgICAgICAgICAgICAgICAgICBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcndyaXRlX2Ftb3VudD12YWxpZF9hbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbl9pZHg9dG9rZW5fY29uZmlybWF0aW9uX2lkeAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBpZiByZXMgYW5kIHJlcy5nZXQoInN0YXR1cyIsICIiKSA9PSAiU1VDQ0VTUyI6CiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3NmdWxfcHVyY2hhc2VzLmFwcGVuZChmIlB1cmNoYXNlIHtpICsgMX0iKQogICAgICAgICAgICAgICAgICAgICAgICBwcmludF9wYW5lbCgiU3Vrc2VzIiwgIlBlbWJlbGlhbiBiZXJoYXNpbCIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHBhdXNlX29uX3N1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzdWNjZXNzZnVsX3B1cmNoYXNlcy5hcHBlbmQoZiJQdXJjaGFzZSB7aSArIDF9IikKICAgICAgICAgICAgICAgIHByaW50X3BhbmVsKCJTdWtzZXMiLCAiUGVtYmVsaWFuIGJlcmhhc2lsIikKICAgICAgICAgICAgICAgIGlmIHBhdXNlX29uX3N1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgcGF1c2UoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnRfcGFuZWwoIktlc2FsYWhhbiIsIGYiVGVyamFkaSBlcnJvciBzYWF0IG1lbWJ1YXQgb3JkZXI6IHtlfSIpCiAgICAgICAgCiAgICAgICAgY29uc29sZS5ydWxlKCkKCiAgICAgICAgaWYgZGVsYXlfc2Vjb25kcyA+IDAgYW5kIGkgPCBuIC0gMToKICAgICAgICAgICAgZGVsYXlfaW5saW5lKGRlbGF5X3NlY29uZHMpCgogICAgY29uc29sZS5wcmludChmIlt7dGhlbWVbJ3RleHRfdGl0bGUnXX1dVG90YWwgcGVtYmVsaWFuIHN1a3NlcyB7bGVuKHN1Y2Nlc3NmdWxfcHVyY2hhc2VzKX0ve259Wy9dIikKICAgIGlmIHN1Y2Nlc3NmdWxfcHVyY2hhc2VzOgogICAgICAgIGNvbnNvbGUucnVsZSgpCiAgICAgICAgY29uc29sZS5wcmludCgiRGFmdGFyIHBlbWJlbGlhbiBzdWtzZXM6IikKICAgICAgICBmb3IgaWR4LCBwdXJjaGFzZSBpbiBlbnVtZXJhdGUoc3VjY2Vzc2Z1bF9wdXJjaGFzZXMsIHN0YXJ0PTEpOgogICAgICAgICAgICBjb25zb2xlLnByaW50KGYie2lkeH0uIHtwdXJjaGFzZX0iKQogICAgY29uc29sZS5ydWxlKCkKICAgIHJldHVybiBUcnVlCgo=').decode())
