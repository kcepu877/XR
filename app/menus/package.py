#!/usr/bin/env python3
import base64
exec(base64.b64decode('aW1wb3J0IGpzb24KaW1wb3J0IHN5cwoKaW1wb3J0IHJlcXVlc3RzCmZyb20gYXBwLnNlcnZpY2UuYXV0aCBpbXBvcnQgQXV0aEluc3RhbmNlCmZyb20gYXBwLmNsaWVudC5lbmdzZWwgaW1wb3J0IGdldF9mYW1pbHksIGdldF9wYWNrYWdlLCBnZXRfYWRkb25zLCBnZXRfcGFja2FnZV9kZXRhaWxzLCBzZW5kX2FwaV9yZXF1ZXN0LCB1bnN1YnNjcmliZQpmcm9tIGFwcC5jbGllbnQuY2lhbSBpbXBvcnQgZ2V0X2F1dGhfY29kZQpmcm9tIGFwcC5zZXJ2aWNlLmJvb2ttYXJrIGltcG9ydCBCb29rbWFya0luc3RhbmNlCmZyb20gYXBwLmNsaWVudC5wdXJjaGFzZS5yZWRlZW0gaW1wb3J0IHNldHRsZW1lbnRfYm91bnR5LCBzZXR0bGVtZW50X2xveWFsdHksIGJvdW50eV9hbGxvdG1lbnQKZnJvbSBhcHAubWVudXMudXRpbCBpbXBvcnQgY2xlYXJfc2NyZWVuLCBwYXVzZSwgZGlzcGxheV9odG1sCmZyb20gYXBwLmNsaWVudC5wdXJjaGFzZS5xcmlzIGltcG9ydCBzaG93X3FyaXNfcGF5bWVudApmcm9tIGFwcC5jbGllbnQucHVyY2hhc2UuZXdhbGxldCBpbXBvcnQgc2hvd19tdWx0aXBheW1lbnQKZnJvbSBhcHAuY2xpZW50LnB1cmNoYXNlLmJhbGFuY2UgaW1wb3J0IHNldHRsZW1lbnRfYmFsYW5jZQpmcm9tIGFwcC50eXBlX2RpY3QgaW1wb3J0IFBheW1lbnRJdGVtCmZyb20gYXBwLm1lbnVzLnB1cmNoYXNlIGltcG9ydCBwdXJjaGFzZV9uX3RpbWVzLCBwdXJjaGFzZV9uX3RpbWVzX2J5X29wdGlvbl9jb2RlCmZyb20gYXBwLm1lbnVzLnV0aWwgaW1wb3J0IGZvcm1hdF9xdW90YV9ieXRlCmZyb20gYXBwLnNlcnZpY2UuZGVjb3kgaW1wb3J0IERlY295SW5zdGFuY2UKCmRlZiBzaG93X3BhY2thZ2VfZGV0YWlscyhhcGlfa2V5LCB0b2tlbnMsIHBhY2thZ2Vfb3B0aW9uX2NvZGUsIGlzX2VudGVycHJpc2UsIG9wdGlvbl9vcmRlcj0tMSk6CiAgICBhY3RpdmVfdXNlciA9IEF1dGhJbnN0YW5jZS5hY3RpdmVfdXNlcgogICAgc3Vic2NyaXB0aW9uX3R5cGUgPSBhY3RpdmVfdXNlci5nZXQoInN1YnNjcmlwdGlvbl90eXBlIiwgIiIpCgogICAgY2xlYXJfc2NyZWVuKCkKICAgIHByaW50KCI9IiAqIDU1KQogICAgcHJpbnQoIvCfk6YgRGV0YWlsIFBha2V0Ii5jZW50ZXIoNTUpKQogICAgcHJpbnQoIj0iICogNTUpCgogICAgcGFja2FnZSA9IGdldF9wYWNrYWdlKGFwaV9rZXksIHRva2VucywgcGFja2FnZV9vcHRpb25fY29kZSkKICAgIGlmIG5vdCBwYWNrYWdlOgogICAgICAgIHByaW50KCLwn5KlIEdhZ2FsIGxvYWQgZGV0YWlsIHBha2V0IGJyby4iKQogICAgICAgIHBhdXNlKCkKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBwcmljZSA9IHBhY2thZ2VbInBhY2thZ2Vfb3B0aW9uIl1bInByaWNlIl0KICAgIGRldGFpbCA9IGRpc3BsYXlfaHRtbChwYWNrYWdlWyJwYWNrYWdlX29wdGlvbiJdWyJ0bmMiXSkKICAgIHZhbGlkaXR5ID0gcGFja2FnZVsicGFja2FnZV9vcHRpb24iXVsidmFsaWRpdHkiXQoKICAgIG9wdGlvbl9uYW1lID0gcGFja2FnZS5nZXQoInBhY2thZ2Vfb3B0aW9uIiwge30pLmdldCgibmFtZSIsICIiKQogICAgZmFtaWx5X25hbWUgPSBwYWNrYWdlLmdldCgicGFja2FnZV9mYW1pbHkiLCB7fSkuZ2V0KCJuYW1lIiwgIiIpCiAgICB2YXJpYW50X25hbWUgPSBwYWNrYWdlLmdldCgicGFja2FnZV9kZXRhaWxfdmFyaWFudCIsIHt9KS5nZXQoIm5hbWUiLCAiIikKICAgIHRpdGxlID0gZiJ7ZmFtaWx5X25hbWV9IC0ge3ZhcmlhbnRfbmFtZX0gLSB7b3B0aW9uX25hbWV9Ii5zdHJpcCgpCgogICAgZmFtaWx5X2NvZGUgPSBwYWNrYWdlLmdldCgicGFja2FnZV9mYW1pbHkiLCB7fSkuZ2V0KCJwYWNrYWdlX2ZhbWlseV9jb2RlIiwgIiIpCiAgICBwYXJlbnRfY29kZSA9IHBhY2thZ2UuZ2V0KCJwYWNrYWdlX2FkZG9uIiwge30pLmdldCgicGFyZW50X2NvZGUiLCAiIikgb3IgIk4vQSIKCiAgICB0b2tlbl9jb25maXJtYXRpb24gPSBwYWNrYWdlWyJ0b2tlbl9jb25maXJtYXRpb24iXQogICAgdHNfdG9fc2lnbiA9IHBhY2thZ2VbInRpbWVzdGFtcCJdCiAgICBwYXltZW50X2ZvciA9IHBhY2thZ2VbInBhY2thZ2VfZmFtaWx5Il1bInBheW1lbnRfZm9yIl0gb3IgIkJVWV9QQUNLQUdFIgoKICAgIHBheW1lbnRfaXRlbXMgPSBbCiAgICAgICAgUGF5bWVudEl0ZW0oCiAgICAgICAgICAgIGl0ZW1fY29kZT1wYWNrYWdlX29wdGlvbl9jb2RlLAogICAgICAgICAgICBwcm9kdWN0X3R5cGU9IiIsCiAgICAgICAgICAgIGl0ZW1fcHJpY2U9cHJpY2UsCiAgICAgICAgICAgIGl0ZW1fbmFtZT1mInt2YXJpYW50X25hbWV9IHtvcHRpb25fbmFtZX0iLnN0cmlwKCksCiAgICAgICAgICAgIHRheD0wLAogICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb249dG9rZW5fY29uZmlybWF0aW9uLAogICAgICAgICkKICAgIF0KCiAgICBwcmludCgiLSIgKiA1NSkKICAgIHByaW50KGYiTmFtYToge3RpdGxlfSIpCiAgICBwcmludChmIkhhcmdhOiBScCB7cHJpY2V9IikKICAgIHByaW50KGYiUGF5bWVudCBGb3I6IHtwYXltZW50X2Zvcn0iKQogICAgcHJpbnQoZiJNYXNhIEFrdGlmOiB7dmFsaWRpdHl9IikKICAgIHByaW50KGYiUG9pbnQ6IHtwYWNrYWdlWydwYWNrYWdlX29wdGlvbiddWydwb2ludCddfSIpCiAgICBwcmludChmIlBsYW4gVHlwZToge3BhY2thZ2VbJ3BhY2thZ2VfZmFtaWx5J11bJ3BsYW5fdHlwZSddfSIpCiAgICBwcmludCgiLSIgKiA1NSkKICAgIHByaW50KGYiRmFtaWx5IENvZGU6IHtmYW1pbHlfY29kZX0iKQogICAgcHJpbnQoZiJQYXJlbnQgQ29kZToge3BhcmVudF9jb2RlfSIpCiAgICBwcmludCgiLSIgKiA1NSkKCiAgICBiZW5lZml0cyA9IHBhY2thZ2VbInBhY2thZ2Vfb3B0aW9uIl1bImJlbmVmaXRzIl0KICAgIGlmIGJlbmVmaXRzIGFuZCBpc2luc3RhbmNlKGJlbmVmaXRzLCBsaXN0KToKICAgICAgICBwcmludCgi4pyoIEJlbmVmaXRzOiIpCiAgICAgICAgZm9yIGJlbmVmaXQgaW4gYmVuZWZpdHM6CiAgICAgICAgICAgIHByaW50KCItIiAqIDU1KQogICAgICAgICAgICBwcmludChmIiBOYW1lOiB7YmVuZWZpdFsnbmFtZSddfSIpCiAgICAgICAgICAgIHByaW50KGYiICBJdGVtIGlkOiB7YmVuZWZpdFsnaXRlbV9pZCddfSIpCiAgICAgICAgICAgIGRhdGFfdHlwZSA9IGJlbmVmaXRbJ2RhdGFfdHlwZSddCiAgICAgICAgICAgIGlmIGRhdGFfdHlwZSA9PSAiVk9JQ0UiIGFuZCBiZW5lZml0Wyd0b3RhbCddID4gMDoKICAgICAgICAgICAgICAgIHByaW50KGYiICBUb3RhbDoge2JlbmVmaXRbJ3RvdGFsJ10vNjB9IG1lbml0IikKICAgICAgICAgICAgZWxpZiBkYXRhX3R5cGUgPT0gIlRFWFQiIGFuZCBiZW5lZml0Wyd0b3RhbCddID4gMDoKICAgICAgICAgICAgICAgIHByaW50KGYiICBUb3RhbDoge2JlbmVmaXRbJ3RvdGFsJ119IFNNUyIpCiAgICAgICAgICAgIGVsaWYgZGF0YV90eXBlID09ICJEQVRBIiBhbmQgYmVuZWZpdFsndG90YWwnXSA+IDA6CiAgICAgICAgICAgICAgICBxdW90YSA9IGludChiZW5lZml0Wyd0b3RhbCddKQogICAgICAgICAgICAgICAgcHJpbnQoZiIgIEt1b3RhOiB7Zm9ybWF0X3F1b3RhX2J5dGUocXVvdGEpfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludChmIiAgVG90YWw6IHtiZW5lZml0Wyd0b3RhbCddfSAoe2RhdGFfdHlwZX0pIikKCiAgICAgICAgICAgIGlmIGJlbmVmaXQuZ2V0KCJpc191bmxpbWl0ZWQiKToKICAgICAgICAgICAgICAgIHByaW50KCIgIFVubGltaXRlZDogWWVzIikKCiAgICBwcmludCgiLSIgKiA1NSkKICAgIGFkZG9ucyA9IGdldF9hZGRvbnMoYXBpX2tleSwgdG9rZW5zLCBwYWNrYWdlX29wdGlvbl9jb2RlKQogICAgcHJpbnQoZiJBZGRvbnM6XG57anNvbi5kdW1wcyhhZGRvbnMsIGluZGVudD0yKX0iKQogICAgcHJpbnQoIi0iICogNTUpCiAgICBwcmludChmIlNuSyBNeVhMOlxue2RldGFpbH0iKQogICAgcHJpbnQoIj0iICogNTUpCgogICAgaW5fcGFja2FnZV9kZXRhaWxfbWVudSA9IFRydWUKICAgIHdoaWxlIGluX3BhY2thZ2VfZGV0YWlsX21lbnU6CiAgICAgICAgcHJpbnQoIk9wdGlvbnM6IikKICAgICAgICBwcmludCgiIFsxLl0gQmVsaSBkZW5nYW4gUHVsc2Eg8J+SsCIpCiAgICAgICAgcHJpbnQoIiBbMi5dIEJlbGkgZGVuZ2FuIEUtV2FsbGV0IPCfk7EiKQogICAgICAgIHByaW50KCIgWzMuXSBCYXlhciBkZW5nYW4gUVJJUyDwn5SzIikKICAgICAgICBwcmludCgiIFs0Ll0gUHVsc2EgKyBEZWNveSDwn6SrIikKICAgICAgICBwcmludCgiIFs1Ll0gUHVsc2EgKyBEZWNveSBWMiDwn6SrIikKICAgICAgICBwcmludCgiIFs2Ll0gUVJJUyArIERlY295ICgrMUspIikKICAgICAgICBwcmludCgiIFs3Ll0gUVJJUyArIERlY295IFYyIikKICAgICAgICBwcmludCgiIFs4Ll0gUHVsc2EgTiBrYWxpIPCflIQiKQoKICAgICAgICBpZiBwYXltZW50X2ZvciA9PSAiUkVERUVNX1ZPVUNIRVIiOgogICAgICAgICAgICBwcmludCgiIFtCLl0gQW1iaWwgc2ViYWdhaSBib251cyDwn46BIikKICAgICAgICAgICAgcHJpbnQoIltCQS5dIEtpcmltIGJvbnVzIPCfjoEiKQogICAgICAgICAgICBwcmludCgiIFtMLl0gQmVsaSBkZW5nYW4gUG9pbiDirZAiKQoKICAgICAgICBpZiBvcHRpb25fb3JkZXIgIT0gLTE6CiAgICAgICAgICAgIHByaW50KCIgWzAuXSBUYW1iYWgga2UgQm9va21hcmsg8J+TjCIpCiAgICAgICAgcHJpbnQoIlswMC5dIEJhbGlrIGtlIGRhZnRhciBwYWtldCIpCiAgICAgICAgcHJpbnQoIj0iICogNTUpCgogICAgICAgIGNob2ljZSA9IGlucHV0KCJQaWxpaGFuOiAiKS5zdHJpcCgpCiAgICAgICAgaWYgY2hvaWNlID09ICIwMCI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGVsaWYgY2hvaWNlID09ICIwIiBhbmQgb3B0aW9uX29yZGVyICE9IC0xOgogICAgICAgICAgICAjIEFkZCB0byBib29rbWFyawogICAgICAgICAgICBzdWNjZXNzID0gQm9va21hcmtJbnN0YW5jZS5hZGRfYm9va21hcmsoCiAgICAgICAgICAgICAgICBmYW1pbHlfY29kZT1wYWNrYWdlLmdldCgicGFja2FnZV9mYW1pbHkiLCB7fSkuZ2V0KCJwYWNrYWdlX2ZhbWlseV9jb2RlIiwiIiksCiAgICAgICAgICAgICAgICBmYW1pbHlfbmFtZT1wYWNrYWdlLmdldCgicGFja2FnZV9mYW1pbHkiLCB7fSkuZ2V0KCJuYW1lIiwiIiksCiAgICAgICAgICAgICAgICBpc19lbnRlcnByaXNlPWlzX2VudGVycHJpc2UsCiAgICAgICAgICAgICAgICB2YXJpYW50X25hbWU9dmFyaWFudF9uYW1lLAogICAgICAgICAgICAgICAgb3B0aW9uX25hbWU9b3B0aW9uX25hbWUsCiAgICAgICAgICAgICAgICBvcmRlcj1vcHRpb25fb3JkZXIsCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIHByaW50KCLinIUgUGFrZXQgZGl0YW1iYWgga2UgYm9va21hcmsgYnJvLiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludCgi4pqg77iPIFBha2V0IHVkYWggYWRhIGRpIGJvb2ttYXJrIGJyby4iKQogICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGVsaWYgY2hvaWNlID09ICcxJzoKICAgICAgICAgICAgcmVzID0gc2V0dGxlbWVudF9iYWxhbmNlKAogICAgICAgICAgICAgICAgYXBpX2tleSwKICAgICAgICAgICAgICAgIHRva2VucywKICAgICAgICAgICAgICAgIHBheW1lbnRfaXRlbXMsCiAgICAgICAgICAgICAgICBwYXltZW50X2ZvciwKICAgICAgICAgICAgICAgIFRydWUKICAgICAgICAgICAgKQogICAgICAgICAgICBpZiByZXMgYW5kIHJlcy5nZXQoInN0YXR1cyIsICIiKSA9PSAiU1VDQ0VTUyI6CiAgICAgICAgICAgICAgICBwcmludCgi4pyFIFNpbGFoa2FuIGNlayBoYXNpbCBwZW1iZWxpYW4gZGkgYXBsaWthc2kgTXlYTC4iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gcmVzLmdldCgibWVzc2FnZSIsICJVbmtub3duIGVycm9yIikgaWYgcmVzIGVsc2UgIk5vIHJlc3BvbnNlIgogICAgICAgICAgICAgICAgcHJpbnQoZiLimqDvuI8gUGVtYmVsaWFuIHB1bHNhIGdhZ2FsIGJybzoge2Vycm9yX21zZ30iKQogICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICAgICAgZWxpZiBjaG9pY2UgPT0gJzInOgogICAgICAgICAgICByZXMgPSBzaG93X211bHRpcGF5bWVudCgKICAgICAgICAgICAgICAgIGFwaV9rZXksCiAgICAgICAgICAgICAgICB0b2tlbnMsCiAgICAgICAgICAgICAgICBwYXltZW50X2l0ZW1zLAogICAgICAgICAgICAgICAgcGF5bWVudF9mb3IsCiAgICAgICAgICAgICAgICBUcnVlLAogICAgICAgICAgICApCiAgICAgICAgICAgIGlmIHJlcyBhbmQgcmVzLmdldCgic3RhdHVzIiwgIiIpID09ICJTVUNDRVNTIjoKICAgICAgICAgICAgICAgIHByaW50KCLinIUgU2lsYWhrYW4gbGFrdWthbiBwZW1iYXlhcmFuICYgY2VrIGhhc2lsIHBlbWJlbGlhbiBkaSBhcGxpa2FzaSBNeVhMLiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXMuZ2V0KCJtZXNzYWdlIiwgIlVua25vd24gZXJyb3IiKSBpZiByZXMgZWxzZSAiTm8gcmVzcG9uc2UiCiAgICAgICAgICAgICAgICBwcmludChmIuKaoO+4jyBQZW1iYXlhcmFuIHZpYSBFLVdhbGxldCBnYWdhbCBicm86IHtlcnJvcl9tc2d9IikKICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgICAgIGVsaWYgY2hvaWNlID09ICczJzoKICAgICAgICAgICAgcmVzID0gc2hvd19xcmlzX3BheW1lbnQoCiAgICAgICAgICAgICAgICBhcGlfa2V5LAogICAgICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICAgICAgcGF5bWVudF9pdGVtcywKICAgICAgICAgICAgICAgIHBheW1lbnRfZm9yLAogICAgICAgICAgICAgICAgVHJ1ZSwKICAgICAgICAgICAgKQogICAgICAgICAgICBpZiByZXMgYW5kIHJlcy5nZXQoInN0YXR1cyIsICIiKSA9PSAiU1VDQ0VTUyI6CiAgICAgICAgICAgICAgICBwcmludCgi4pyFIFNpbGFoa2FuIGxha3VrYW4gcGVtYmF5YXJhbiAmIGNlayBoYXNpbCBwZW1iZWxpYW4gZGkgYXBsaWthc2kgTXlYTC4iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gcmVzLmdldCgibWVzc2FnZSIsICJVbmtub3duIGVycm9yIikgaWYgcmVzIGVsc2UgIk5vIHJlc3BvbnNlIgogICAgICAgICAgICAgICAgcHJpbnQoZiLimqDvuI8gUGVtYmF5YXJhbiB2aWEgUVJJUyBnYWdhbCBicm86IHtlcnJvcl9tc2d9IikKICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICBlbGlmIGNob2ljZSA9PSAnNCc6CiAgICAgICAgICAgICMgQmFsYW5jZSB3aXRoIERlY295IPCfpKsKICAgICAgICAgICAgZGVjb3kgPSBEZWNveUluc3RhbmNlLmdldF9kZWNveSgiYmFsYW5jZSIpCiAgICAgICAgICAgIGRlY295X3BhY2thZ2VfZGV0YWlsID0gZ2V0X3BhY2thZ2UoYXBpX2tleSwgdG9rZW5zLCBkZWNveVsib3B0aW9uX2NvZGUiXSkKCiAgICAgICAgICAgIGlmIG5vdCBkZWNveV9wYWNrYWdlX2RldGFpbDoKICAgICAgICAgICAgICAgIHByaW50KCLwn5KlIEdhZ2FsIGxvYWQgZGV0YWlsIHBha2V0IGRlY295IGJyby4iKQogICAgICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBwYXltZW50X2l0ZW1zLmFwcGVuZCgKICAgICAgICAgICAgICAgIFBheW1lbnRJdGVtKAogICAgICAgICAgICAgICAgICAgIGl0ZW1fY29kZT1kZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicGFja2FnZV9vcHRpb25fY29kZSJdLAogICAgICAgICAgICAgICAgICAgIHByb2R1Y3RfdHlwZT0iIiwKICAgICAgICAgICAgICAgICAgICBpdGVtX3ByaWNlPWRlY295X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdLAogICAgICAgICAgICAgICAgICAgIGl0ZW1fbmFtZT1kZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsibmFtZSJdLAogICAgICAgICAgICAgICAgICAgIHRheD0wLAogICAgICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbj1kZWNveV9wYWNrYWdlX2RldGFpbFsidG9rZW5fY29uZmlybWF0aW9uIl0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIG92ZXJ3cml0ZV9hbW91bnQgPSBwcmljZSArIGRlY295X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdCiAgICAgICAgICAgIHJlcyA9IHNldHRsZW1lbnRfYmFsYW5jZSgKICAgICAgICAgICAgICAgIGFwaV9rZXksCiAgICAgICAgICAgICAgICB0b2tlbnMsCiAgICAgICAgICAgICAgICBwYXltZW50X2l0ZW1zLAogICAgICAgICAgICAgICAgcGF5bWVudF9mb3IsCiAgICAgICAgICAgICAgICBGYWxzZSwKICAgICAgICAgICAgICAgIG92ZXJ3cml0ZV9hbW91bnQ9b3ZlcndyaXRlX2Ftb3VudCwKICAgICAgICAgICAgKQoKICAgICAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgIT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gcmVzLmdldCgibWVzc2FnZSIsICJVbmtub3duIGVycm9yIikKICAgICAgICAgICAgICAgIGlmICJCaXp6LWVyci5BbW91bnQuVG90YWwiIGluIGVycm9yX21zZzoKICAgICAgICAgICAgICAgICAgICBlcnJvcl9tc2dfYXJyID0gZXJyb3JfbXNnLnNwbGl0KCI9IikKICAgICAgICAgICAgICAgICAgICB2YWxpZF9hbW91bnQgPSBpbnQoZXJyb3JfbXNnX2FyclsxXS5zdHJpcCgpKQoKICAgICAgICAgICAgICAgICAgICBwcmludChmIkFkanVzdGVkIHRvdGFsIGFtb3VudCB0bzoge3ZhbGlkX2Ftb3VudH0iKQogICAgICAgICAgICAgICAgICAgIHJlcyA9IHNldHRsZW1lbnRfYmFsYW5jZSgKICAgICAgICAgICAgICAgICAgICAgICAgYXBpX2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICAgICAgICAgICAgICBwYXltZW50X2l0ZW1zLAogICAgICAgICAgICAgICAgICAgICAgICBwYXltZW50X2ZvciwKICAgICAgICAgICAgICAgICAgICAgICAgRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJ3cml0ZV9hbW91bnQ9dmFsaWRfYW1vdW50LAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBpZiByZXMgYW5kIHJlcy5nZXQoInN0YXR1cyIsICIiKSA9PSAiU1VDQ0VTUyI6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KCLinIUgUGVtYmVsaWFuIGJlcmhhc2lsIGJyby4iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IHJlcy5nZXQoIm1lc3NhZ2UiLCAiVW5rbm93biBlcnJvciIpIGlmIHJlcyBlbHNlICJObyByZXNwb25zZSIKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiLimqDvuI8gUGVtYmVsaWFuIHB1bHNhICsgZGVjb3kgZ2FnYWwgYnJvOiB7ZXJyb3JfbXNnfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHByaW50KGYi4pqg77iPIFBlbWJlbGlhbiBwdWxzYSArIGRlY295IGdhZ2FsIGJybzoge2Vycm9yX21zZ30iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQoIuKchSBQZW1iZWxpYW4gYmVyaGFzaWwgYnJvLiIpCiAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgZWxpZiBjaG9pY2UgPT0gJzUnOgogICAgICAgICAgICAjIEJhbGFuY2Ugd2l0aCBEZWNveSB2MiDwn6SrIChwYWthaSB0b2tlbiBjb25maXJtYXRpb24gZGVjb3kpCiAgICAgICAgICAgIGRlY295ID0gRGVjb3lJbnN0YW5jZS5nZXRfZGVjb3koImJhbGFuY2UiKQogICAgICAgICAgICBkZWNveV9wYWNrYWdlX2RldGFpbCA9IGdldF9wYWNrYWdlKGFwaV9rZXksIHRva2VucywgZGVjb3lbIm9wdGlvbl9jb2RlIl0pCgogICAgICAgICAgICBpZiBub3QgZGVjb3lfcGFja2FnZV9kZXRhaWw6CiAgICAgICAgICAgICAgICBwcmludCgi8J+SpSBHYWdhbCBsb2FkIGRldGFpbCBwYWtldCBkZWNveSBicm8uIikKICAgICAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgcGF5bWVudF9pdGVtcy5hcHBlbmQoCiAgICAgICAgICAgICAgICBQYXltZW50SXRlbSgKICAgICAgICAgICAgICAgICAgICBpdGVtX2NvZGU9ZGVjb3lfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInBhY2thZ2Vfb3B0aW9uX2NvZGUiXSwKICAgICAgICAgICAgICAgICAgICBwcm9kdWN0X3R5cGU9IiIsCiAgICAgICAgICAgICAgICAgICAgaXRlbV9wcmljZT1kZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicHJpY2UiXSwKICAgICAgICAgICAgICAgICAgICBpdGVtX25hbWU9ZGVjb3lfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bIm5hbWUiXSwKICAgICAgICAgICAgICAgICAgICB0YXg9MCwKICAgICAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb249ZGVjb3lfcGFja2FnZV9kZXRhaWxbInRva2VuX2NvbmZpcm1hdGlvbiJdLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICApCgogICAgICAgICAgICBvdmVyd3JpdGVfYW1vdW50ID0gcHJpY2UgKyBkZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicHJpY2UiXQogICAgICAgICAgICByZXMgPSBzZXR0bGVtZW50X2JhbGFuY2UoCiAgICAgICAgICAgICAgICBhcGlfa2V5LAogICAgICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICAgICAgcGF5bWVudF9pdGVtcywKICAgICAgICAgICAgICAgICLwn6SrIiwKICAgICAgICAgICAgICAgIEZhbHNlLAogICAgICAgICAgICAgICAgb3ZlcndyaXRlX2Ftb3VudD1vdmVyd3JpdGVfYW1vdW50LAogICAgICAgICAgICAgICAgdG9rZW5fY29uZmlybWF0aW9uX2lkeD0xCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGlmIHJlcyBhbmQgcmVzLmdldCgic3RhdHVzIiwgIiIpICE9ICJTVUNDRVNTIjoKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IHJlcy5nZXQoIm1lc3NhZ2UiLCAiVW5rbm93biBlcnJvciIpCiAgICAgICAgICAgICAgICBpZiAiQml6ei1lcnIuQW1vdW50LlRvdGFsIiBpbiBlcnJvcl9tc2c6CiAgICAgICAgICAgICAgICAgICAgZXJyb3JfbXNnX2FyciA9IGVycm9yX21zZy5zcGxpdCgiPSIpCiAgICAgICAgICAgICAgICAgICAgdmFsaWRfYW1vdW50ID0gaW50KGVycm9yX21zZ19hcnJbMV0uc3RyaXAoKSkKCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJBZGp1c3RlZCB0b3RhbCBhbW91bnQgdG86IHt2YWxpZF9hbW91bnR9IikKICAgICAgICAgICAgICAgICAgICByZXMgPSBzZXR0bGVtZW50X2JhbGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICAgIGFwaV9rZXksCiAgICAgICAgICAgICAgICAgICAgICAgIHRva2VucywKICAgICAgICAgICAgICAgICAgICAgICAgcGF5bWVudF9pdGVtcywKICAgICAgICAgICAgICAgICAgICAgICAgIvCfpKsiLAogICAgICAgICAgICAgICAgICAgICAgICBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcndyaXRlX2Ftb3VudD12YWxpZF9hbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbl9pZHg9LTEKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgPT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCgi4pyFIFBlbWJlbGlhbiBiZXJoYXNpbCBicm8uIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXMuZ2V0KCJtZXNzYWdlIiwgIlVua25vd24gZXJyb3IiKSBpZiByZXMgZWxzZSAiTm8gcmVzcG9uc2UiCiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYi4pqg77iPIFBlbWJlbGlhbiBwdWxzYSArIGRlY295IHYyIGdhZ2FsIGJybzoge2Vycm9yX21zZ30iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBwcmludChmIuKaoO+4jyBQZW1iZWxpYW4gcHVsc2EgKyBkZWNveSB2MiBnYWdhbCBicm86IHtlcnJvcl9tc2d9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByaW50KCLinIUgUGVtYmVsaWFuIGJlcmhhc2lsIGJyby4iKQogICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIGVsaWYgY2hvaWNlID09ICc2JzoKICAgICAgICAgICAgIyBRUklTIGRlY295ICsgUnB4IPCflLPwn6SrCiAgICAgICAgICAgIGRlY295ID0gRGVjb3lJbnN0YW5jZS5nZXRfZGVjb3koInFyaXMiKQogICAgICAgICAgICBkZWNveV9wYWNrYWdlX2RldGFpbCA9IGdldF9wYWNrYWdlKGFwaV9rZXksIHRva2VucywgZGVjb3lbIm9wdGlvbl9jb2RlIl0pCgogICAgICAgICAgICBpZiBub3QgZGVjb3lfcGFja2FnZV9kZXRhaWw6CiAgICAgICAgICAgICAgICBwcmludCgi8J+SpSBHYWdhbCBsb2FkIGRldGFpbCBwYWtldCBkZWNveSBicm8uIikKICAgICAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgcGF5bWVudF9pdGVtcy5hcHBlbmQoCiAgICAgICAgICAgICAgICBQYXltZW50SXRlbSgKICAgICAgICAgICAgICAgICAgICBpdGVtX2NvZGU9ZGVjb3lfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bInBhY2thZ2Vfb3B0aW9uX2NvZGUiXSwKICAgICAgICAgICAgICAgICAgICBwcm9kdWN0X3R5cGU9IiIsCiAgICAgICAgICAgICAgICAgICAgaXRlbV9wcmljZT1kZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicHJpY2UiXSwKICAgICAgICAgICAgICAgICAgICBpdGVtX25hbWU9ZGVjb3lfcGFja2FnZV9kZXRhaWxbInBhY2thZ2Vfb3B0aW9uIl1bIm5hbWUiXSwKICAgICAgICAgICAgICAgICAgICB0YXg9MCwKICAgICAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb249ZGVjb3lfcGFja2FnZV9kZXRhaWxbInRva2VuX2NvbmZpcm1hdGlvbiJdLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICApCgogICAgICAgICAgICBwcmludCgiLSIgKiA1NSkKICAgICAgICAgICAgcHJpbnQoZiJIYXJnYSBQYWtldCBVdGFtYTogUnAge3ByaWNlfSIpCiAgICAgICAgICAgIHByaW50KGYiSGFyZ2EgUGFrZXQgRGVjb3k6IFJwIHtkZWNveV9wYWNrYWdlX2RldGFpbFsncGFja2FnZV9vcHRpb24nXVsncHJpY2UnXX0iKQogICAgICAgICAgICBwcmludCgi4pqg77iPIFNpbGFrYW4gc2VzdWFpa2FuIGFtb3VudCAodHJpYWwgJiBlcnJvciwgMCA9IG1hbGZvcm1lZCkiKQogICAgICAgICAgICBwcmludCgiLSIgKiA1NSkKCiAgICAgICAgICAgIHJlcyA9IHNob3dfcXJpc19wYXltZW50KAogICAgICAgICAgICAgICAgYXBpX2tleSwKICAgICAgICAgICAgICAgIHRva2VucywKICAgICAgICAgICAgICAgIHBheW1lbnRfaXRlbXMsCiAgICAgICAgICAgICAgICAiU0hBUkVfUEFDS0FHRSIsCiAgICAgICAgICAgICAgICBUcnVlLAogICAgICAgICAgICAgICAgdG9rZW5fY29uZmlybWF0aW9uX2lkeD0xCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGlmIHJlcyBhbmQgcmVzLmdldCgic3RhdHVzIiwgIiIpID09ICJTVUNDRVNTIjoKICAgICAgICAgICAgICAgIHByaW50KCLinIUgU2lsYWhrYW4gbGFrdWthbiBwZW1iYXlhcmFuICYgY2VrIGhhc2lsIHBlbWJlbGlhbiBkaSBhcGxpa2FzaSBNeVhMLiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXMuZ2V0KCJtZXNzYWdlIiwgIlVua25vd24gZXJyb3IiKSBpZiByZXMgZWxzZSAiTm8gcmVzcG9uc2UiCiAgICAgICAgICAgICAgICBwcmludChmIuKaoO+4jyBQZW1iYXlhcmFuIFFSSVMgKyBEZWNveSAoKzFLKSBnYWdhbCBicm86IHtlcnJvcl9tc2d9IikKICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICBlbGlmIGNob2ljZSA9PSAnNyc6CiAgICAgICAgICAgICMgUVJJUyBkZWNveSArIFJwMCDwn5Sz8J+kqwogICAgICAgICAgICBkZWNveSA9IERlY295SW5zdGFuY2UuZ2V0X2RlY295KCJxcmlzMCIpCiAgICAgICAgICAgIGRlY295X3BhY2thZ2VfZGV0YWlsID0gZ2V0X3BhY2thZ2UoYXBpX2tleSwgdG9rZW5zLCBkZWNveVsib3B0aW9uX2NvZGUiXSkKCiAgICAgICAgICAgIGlmIG5vdCBkZWNveV9wYWNrYWdlX2RldGFpbDoKICAgICAgICAgICAgICAgIHByaW50KCLwn5KlIEdhZ2FsIGxvYWQgZGV0YWlsIHBha2V0IGRlY295IGJyby4iKQogICAgICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBwYXltZW50X2l0ZW1zLmFwcGVuZCgKICAgICAgICAgICAgICAgIFBheW1lbnRJdGVtKAogICAgICAgICAgICAgICAgICAgIGl0ZW1fY29kZT1kZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsicGFja2FnZV9vcHRpb25fY29kZSJdLAogICAgICAgICAgICAgICAgICAgIHByb2R1Y3RfdHlwZT0iIiwKICAgICAgICAgICAgICAgICAgICBpdGVtX3ByaWNlPWRlY295X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdLAogICAgICAgICAgICAgICAgICAgIGl0ZW1fbmFtZT1kZWNveV9wYWNrYWdlX2RldGFpbFsicGFja2FnZV9vcHRpb24iXVsibmFtZSJdLAogICAgICAgICAgICAgICAgICAgIHRheD0wLAogICAgICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbj1kZWNveV9wYWNrYWdlX2RldGFpbFsidG9rZW5fY29uZmlybWF0aW9uIl0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIHByaW50KCItIiAqIDU1KQogICAgICAgICAgICBwcmludChmIkhhcmdhIFBha2V0IFV0YW1hOiBScCB7cHJpY2V9IikKICAgICAgICAgICAgcHJpbnQoZiJIYXJnYSBQYWtldCBEZWNveTogUnAge2RlY295X3BhY2thZ2VfZGV0YWlsWydwYWNrYWdlX29wdGlvbiddWydwcmljZSddfSIpCiAgICAgICAgICAgIHByaW50KCLimqDvuI8gU2lsYWthbiBzZXN1YWlrYW4gYW1vdW50ICh0cmlhbCAmIGVycm9yLCAwID0gbWFsZm9ybWVkKSIpCiAgICAgICAgICAgIHByaW50KCItIiAqIDU1KQoKICAgICAgICAgICAgcmVzID0gc2hvd19xcmlzX3BheW1lbnQoCiAgICAgICAgICAgICAgICBhcGlfa2V5LAogICAgICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICAgICAgcGF5bWVudF9pdGVtcywKICAgICAgICAgICAgICAgICJTSEFSRV9QQUNLQUdFIiwKICAgICAgICAgICAgICAgIFRydWUsCiAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb25faWR4PTEKICAgICAgICAgICAgKQoKICAgICAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgPT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgcHJpbnQoIuKchSBTaWxhaGthbiBsYWt1a2FuIHBlbWJheWFyYW4gJiBjZWsgaGFzaWwgcGVtYmVsaWFuIGRpIGFwbGlrYXNpIE15WEwuIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IHJlcy5nZXQoIm1lc3NhZ2UiLCAiVW5rbm93biBlcnJvciIpIGlmIHJlcyBlbHNlICJObyByZXNwb25zZSIKICAgICAgICAgICAgICAgIHByaW50KGYi4pqg77iPIFBlbWJheWFyYW4gUVJJUyArIERlY295IFYyIGdhZ2FsIGJybzoge2Vycm9yX21zZ30iKQogICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIGVsaWYgY2hvaWNlID09ICc4JzoKICAgICAgICAgICAgIyBQdWxzYSBOIGthbGkg8J+UhAogICAgICAgICAgICB1c2VfZGVjb3lfZm9yX25fdGltZXMgPSBpbnB1dCgiTWF1IHBha2UgZGVjb3kgcGFja2FnZT8gKHkvbik6ICIpLnN0cmlwKCkubG93ZXIoKSA9PSAneScKICAgICAgICAgICAgbl90aW1lc19zdHIgPSBpbnB1dCgiTWFzdWtpbiBqdW1sYWggcGVtYmVsaWFuIChjb250b2ggMyk6ICIpLnN0cmlwKCkKICAgICAgICAgICAgZGVsYXlfc2Vjb25kc19zdHIgPSBpbnB1dCgiTWFzdWtpbiBqZWRhIGFudGFyIHBlbWJlbGlhbiAoZGV0aWssIGNvbnRvaCAyNSk6ICIpLnN0cmlwKCkKCiAgICAgICAgICAgIGlmIG5vdCBkZWxheV9zZWNvbmRzX3N0ci5pc2RpZ2l0KCk6CiAgICAgICAgICAgICAgICBkZWxheV9zZWNvbmRzX3N0ciA9ICIwIgoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbl90aW1lcyA9IGludChuX3RpbWVzX3N0cikKICAgICAgICAgICAgICAgIGlmIG5fdGltZXMgPCAxOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkp1bWxhaCBtaW5pbWFsIDEgYnJvLiIpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgcHJpbnQoIuKaoO+4jyBJbnB1dCBqdW1sYWggbmdnYWsgdmFsaWQgYnJvLiBNYXN1a2luIGFuZ2thIHlhbmcgYmVuZXIg4pyM77iPIikKICAgICAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICByZXMgPSBwdXJjaGFzZV9uX3RpbWVzX2J5X29wdGlvbl9jb2RlKAogICAgICAgICAgICAgICAgbl90aW1lcywKICAgICAgICAgICAgICAgIG9wdGlvbl9jb2RlPXBhY2thZ2Vfb3B0aW9uX2NvZGUsCiAgICAgICAgICAgICAgICB1c2VfZGVjb3k9dXNlX2RlY295X2Zvcl9uX3RpbWVzLAogICAgICAgICAgICAgICAgZGVsYXlfc2Vjb25kcz1pbnQoZGVsYXlfc2Vjb25kc19zdHIpLAogICAgICAgICAgICAgICAgcGF1c2Vfb25fc3VjY2Vzcz1GYWxzZSwKICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbl9pZHg9MQogICAgICAgICAgICApCgogICAgICAgICAgICBpZiByZXMgYW5kIHJlcy5nZXQoInN0YXR1cyIsICIiKSA9PSAiU1VDQ0VTUyI6CiAgICAgICAgICAgICAgICBwcmludChmIuKchSBQZW1iZWxpYW4gcHVsc2Ege25fdGltZXN9IGthbGkgYmVyaGFzaWwgYnJvLiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXMuZ2V0KCJtZXNzYWdlIiwgIlVua25vd24gZXJyb3IiKSBpZiByZXMgZWxzZSAiTm8gcmVzcG9uc2UiCiAgICAgICAgICAgICAgICBwcmludChmIuKaoO+4jyBQZW1iZWxpYW4gcHVsc2Ege25fdGltZXN9IGthbGkgZ2FnYWwgYnJvOiB7ZXJyb3JfbXNnfSIpCiAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgZWxpZiBjaG9pY2UgPT0gJzknOgogICAgICAgICAgICAjIERlYnVnIFNoYXJlIFBhY2thZ2Ug8J+QngogICAgICAgICAgICBwaW4gPSBpbnB1dCgiTWFzdWtpbiBQSU4gKDYgZGlnaXQpOiAiKS5zdHJpcCgpCiAgICAgICAgICAgIGlmIGxlbihwaW4pICE9IDY6CiAgICAgICAgICAgICAgICBwcmludCgi4pqg77iPIFBJTiB0ZXJsYWx1IHBlbmRlayBicm8uIikKICAgICAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBhdXRoX2NvZGUgPSBnZXRfYXV0aF9jb2RlKHRva2VucywgcGluLCBhY3RpdmVfdXNlclsibnVtYmVyIl0pCiAgICAgICAgICAgIGlmIG5vdCBhdXRoX2NvZGU6CiAgICAgICAgICAgICAgICBwcmludCgi8J+SpSBHYWdhbCBkYXBldGluIGF1dGhfY29kZSBicm8uIikKICAgICAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICB0YXJnZXRfbXNpc2RuID0gaW5wdXQoIk1hc3VraW4gbm9tb3IgdHVqdWFuICg2Mnh4eHgpOiAiKS5zdHJpcCgpCiAgICAgICAgICAgIHVybCA9ICJodHRwczovL21lLm1hc2h1LmxvbC9wZy1kZWNveS1lZHUuanNvbiIKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KHVybCwgdGltZW91dD0zMCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoZiLwn5KlIEVycm9yIGFtYmlsIGRhdGEgZGVjb3k6IHtlfSIpCiAgICAgICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgIT0gMjAwOgogICAgICAgICAgICAgICAgcHJpbnQoIuKaoO+4jyBHYWdhbCBhbWJpbCBkYXRhIGRlY295IHBhY2thZ2UgYnJvLiIpCiAgICAgICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAgICAgZGVjb3lfZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICBkZWNveV9wYWNrYWdlX2RldGFpbCA9IGdldF9wYWNrYWdlX2RldGFpbHMoCiAgICAgICAgICAgICAgICBhcGlfa2V5LAogICAgICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICAgICAgZGVjb3lfZGF0YVsiZmFtaWx5X2NvZGUiXSwKICAgICAgICAgICAgICAgIGRlY295X2RhdGFbInZhcmlhbnRfY29kZSJdLAogICAgICAgICAgICAgICAgZGVjb3lfZGF0YVsib3JkZXIiXSwKICAgICAgICAgICAgICAgIGRlY295X2RhdGFbImlzX2VudGVycHJpc2UiXSwKICAgICAgICAgICAgICAgIGRlY295X2RhdGFbIm1pZ3JhdGlvbl90eXBlIl0sCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIG92ZXJ3cml0ZV9hbW91bnQgPSBwcmljZSArIGRlY295X3BhY2thZ2VfZGV0YWlsWyJwYWNrYWdlX29wdGlvbiJdWyJwcmljZSJdCiAgICAgICAgICAgIHJlcyA9IHNob3dfcXJpc19wYXltZW50KAogICAgICAgICAgICAgICAgYXBpX2tleSwKICAgICAgICAgICAgICAgIHRva2VucywKICAgICAgICAgICAgICAgIHBheW1lbnRfaXRlbXMsCiAgICAgICAgICAgICAgICAiU0hBUkVfUEFDS0FHRSIsCiAgICAgICAgICAgICAgICBGYWxzZSwKICAgICAgICAgICAgICAgIG92ZXJ3cml0ZV9hbW91bnQ9b3ZlcndyaXRlX2Ftb3VudCwKICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbl9pZHg9MCwKICAgICAgICAgICAgICAgIHRvcHVwX251bWJlcj10YXJnZXRfbXNpc2RuLAogICAgICAgICAgICAgICAgc3RhZ2VfdG9rZW49YXV0aF9jb2RlLAogICAgICAgICAgICApCgogICAgICAgICAgICBpZiByZXMgYW5kIHJlcy5nZXQoInN0YXR1cyIsICIiKSAhPSAiU1VDQ0VTUyI6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXMuZ2V0KCJtZXNzYWdlIiwgIlVua25vd24gZXJyb3IiKQogICAgICAgICAgICAgICAgaWYgIkJpenotZXJyLkFtb3VudC5Ub3RhbCIgaW4gZXJyb3JfbXNnOgogICAgICAgICAgICAgICAgICAgIGVycm9yX21zZ19hcnIgPSBlcnJvcl9tc2cuc3BsaXQoIj0iKQogICAgICAgICAgICAgICAgICAgIHZhbGlkX2Ftb3VudCA9IGludChlcnJvcl9tc2dfYXJyWzFdLnN0cmlwKCkpCgogICAgICAgICAgICAgICAgICAgIHByaW50KGYi4pqg77iPIEFkanVzdGVkIHRvdGFsIGFtb3VudCBrZToge3ZhbGlkX2Ftb3VudH0iKQogICAgICAgICAgICAgICAgICAgIHJlcyA9IHNob3dfcXJpc19wYXltZW50KAogICAgICAgICAgICAgICAgICAgICAgICBhcGlfa2V5LAogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMsCiAgICAgICAgICAgICAgICAgICAgICAgIHBheW1lbnRfaXRlbXMsCiAgICAgICAgICAgICAgICAgICAgICAgICJTSEFSRV9QQUNLQUdFIiwKICAgICAgICAgICAgICAgICAgICAgICAgRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJ3cml0ZV9hbW91bnQ9dmFsaWRfYW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb25faWR4PTAsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcHVwX251bWJlcj10YXJnZXRfbXNpc2RuLAogICAgICAgICAgICAgICAgICAgICAgICBzdGFnZV90b2tlbj1hdXRoX2NvZGUsCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIGlmIHJlcyBhbmQgcmVzLmdldCgic3RhdHVzIiwgIiIpID09ICJTVUNDRVNTIjoKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoIuKchSBQdXJjaGFzZSBiZXJoYXNpbCBicm8uIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXMuZ2V0KCJtZXNzYWdlIiwgIlVua25vd24gZXJyb3IiKSBpZiByZXMgZWxzZSAiTm8gcmVzcG9uc2UiCiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYi4pqg77iPIFB1cmNoYXNlIGdhZ2FsIGJybzoge2Vycm9yX21zZ30iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBwcmludChmIuKaoO+4jyBQdXJjaGFzZSBnYWdhbCBicm86IHtlcnJvcl9tc2d9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByaW50KCLinIUgUHVyY2hhc2UgYmVyaGFzaWwgYnJvLiIpCgogICAgICAgICAgICAjIOKaoO+4jyBKYW5nYW4gcG9wIHBheW1lbnRfaXRlbXMga2FsYXUgbmdnYWsgYWRhIGFwcGVuZCBkaSBhdGFzCiAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgIAogICAgICAgIGVsaWYgY2hvaWNlLmxvd2VyKCkgPT0gJ2InOgogICAgICAgICAgICAjIEFtYmlsIHNlYmFnYWkgYm9udXMg8J+OgQogICAgICAgICAgICByZXMgPSBzZXR0bGVtZW50X2JvdW50eSgKICAgICAgICAgICAgICAgIGFwaV9rZXk9YXBpX2tleSwKICAgICAgICAgICAgICAgIHRva2Vucz10b2tlbnMsCiAgICAgICAgICAgICAgICB0b2tlbl9jb25maXJtYXRpb249dG9rZW5fY29uZmlybWF0aW9uLAogICAgICAgICAgICAgICAgdHNfdG9fc2lnbj10c190b19zaWduLAogICAgICAgICAgICAgICAgcGF5bWVudF90YXJnZXQ9cGFja2FnZV9vcHRpb25fY29kZSwKICAgICAgICAgICAgICAgIHByaWNlPXByaWNlLAogICAgICAgICAgICAgICAgaXRlbV9uYW1lPXZhcmlhbnRfbmFtZQogICAgICAgICAgICApCiAgICAgICAgICAgIGlmIHJlcyBhbmQgcmVzLmdldCgic3RhdHVzIiwgIiIpID09ICJTVUNDRVNTIjoKICAgICAgICAgICAgICAgIHByaW50KCLinIUgQm9udXMgYmVyaGFzaWwgZGlhbWJpbCBicm8uIFNpbGFrYW4gY2VrIGRpIGFwbGlrYXNpIE15WEwuIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IHJlcy5nZXQoIm1lc3NhZ2UiLCAiVW5rbm93biBlcnJvciIpIGlmIHJlcyBlbHNlICJObyByZXNwb25zZSIKICAgICAgICAgICAgICAgIHByaW50KGYi4pqg77iPIEJvbnVzIGdhZ2FsIGRpYW1iaWwgYnJvOiB7ZXJyb3JfbXNnfSIpCiAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgZWxpZiBjaG9pY2UubG93ZXIoKSA9PSAnYmEnOgogICAgICAgICAgICAjIEtpcmltIGJvbnVzIPCfjoHinqHvuI/wn5OxCiAgICAgICAgICAgIGRlc3RpbmF0aW9uX21zaXNkbiA9IGlucHV0KCJNYXN1a2luIG5vbW9yIHR1anVhbiBib251cyAoNjJ4eHh4KTogIikuc3RyaXAoKQogICAgICAgICAgICByZXMgPSBib3VudHlfYWxsb3RtZW50KAogICAgICAgICAgICAgICAgYXBpX2tleT1hcGlfa2V5LAogICAgICAgICAgICAgICAgdG9rZW5zPXRva2VucywKICAgICAgICAgICAgICAgIHRzX3RvX3NpZ249dHNfdG9fc2lnbiwKICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uX21zaXNkbj1kZXN0aW5hdGlvbl9tc2lzZG4sCiAgICAgICAgICAgICAgICBpdGVtX25hbWU9b3B0aW9uX25hbWUsCiAgICAgICAgICAgICAgICBpdGVtX2NvZGU9cGFja2FnZV9vcHRpb25fY29kZSwKICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbj10b2tlbl9jb25maXJtYXRpb24sCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgPT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgcHJpbnQoZiLinIUgQm9udXMgYmVyaGFzaWwgZGlraXJpbSBrZSB7ZGVzdGluYXRpb25fbXNpc2RufSBicm8uIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IHJlcy5nZXQoIm1lc3NhZ2UiLCAiVW5rbm93biBlcnJvciIpIGlmIHJlcyBlbHNlICJObyByZXNwb25zZSIKICAgICAgICAgICAgICAgIHByaW50KGYi4pqg77iPIEJvbnVzIGdhZ2FsIGRpa2lyaW0gYnJvOiB7ZXJyb3JfbXNnfSIpCiAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgZWxpZiBjaG9pY2UubG93ZXIoKSA9PSAnbCc6CiAgICAgICAgICAgICMgQmVsaSBkZW5nYW4gUG9pbiDirZAKICAgICAgICAgICAgcmVzID0gc2V0dGxlbWVudF9sb3lhbHR5KAogICAgICAgICAgICAgICAgYXBpX2tleT1hcGlfa2V5LAogICAgICAgICAgICAgICAgdG9rZW5zPXRva2VucywKICAgICAgICAgICAgICAgIHRva2VuX2NvbmZpcm1hdGlvbj10b2tlbl9jb25maXJtYXRpb24sCiAgICAgICAgICAgICAgICB0c190b19zaWduPXRzX3RvX3NpZ24sCiAgICAgICAgICAgICAgICBwYXltZW50X3RhcmdldD1wYWNrYWdlX29wdGlvbl9jb2RlLAogICAgICAgICAgICAgICAgcHJpY2U9cHJpY2UsCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgcmVzIGFuZCByZXMuZ2V0KCJzdGF0dXMiLCAiIikgPT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgcHJpbnQoIuKchSBQZW1iZWxpYW4gZGVuZ2FuIHBvaW4gYmVyaGFzaWwgYnJvLiBTaWxha2FuIGNlayBkaSBhcGxpa2FzaSBNeVhMLiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXMuZ2V0KCJtZXNzYWdlIiwgIlVua25vd24gZXJyb3IiKSBpZiByZXMgZWxzZSAiTm8gcmVzcG9uc2UiCiAgICAgICAgICAgICAgICBwcmludChmIuKaoO+4jyBQZW1iZWxpYW4gZGVuZ2FuIHBvaW4gZ2FnYWwgYnJvOiB7ZXJyb3JfbXNnfSIpCiAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoIlB1cmNoYXNlIGNhbmNlbGxlZC4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIHBhdXNlKCkKICAgIHN5cy5leGl0KDApCgoKZGVmIGdldF9wYWNrYWdlc19ieV9mYW1pbHkoCiAgICBmYW1pbHlfY29kZTogc3RyLAogICAgaXNfZW50ZXJwcmlzZTogYm9vbCB8IE5vbmUgPSBOb25lLAogICAgbWlncmF0aW9uX3R5cGU6IHN0ciB8IE5vbmUgPSBOb25lCik6CiAgICBhcGlfa2V5ID0gQXV0aEluc3RhbmNlLmFwaV9rZXkKICAgIHRva2VucyA9IEF1dGhJbnN0YW5jZS5nZXRfYWN0aXZlX3Rva2VucygpCiAgICBpZiBub3QgdG9rZW5zOgogICAgICAgIHByaW50KCLimqDvuI8gTmdnYWsgYWRhIHRva2VuIGFrdGlmIGJyby4gTG9naW4gZHVsdS4iKQogICAgICAgIHBhdXNlKCkKICAgICAgICByZXR1cm4gTm9uZQoKICAgIHBhY2thZ2VzID0gW10KCiAgICBkYXRhID0gZ2V0X2ZhbWlseSgKICAgICAgICBhcGlfa2V5LAogICAgICAgIHRva2VucywKICAgICAgICBmYW1pbHlfY29kZSwKICAgICAgICBpc19lbnRlcnByaXNlLAogICAgICAgIG1pZ3JhdGlvbl90eXBlCiAgICApCgogICAgaWYgbm90IGRhdGE6CiAgICAgICAgcHJpbnQoIvCfkqUgR2FnYWwgbG9hZCBkYXRhIGZhbWlseSBicm8uIikKICAgICAgICBwYXVzZSgpCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBwcmljZV9jdXJyZW5jeSA9ICJScCIKICAgIHJjX2JvbnVzX3R5cGUgPSBkYXRhWyJwYWNrYWdlX2ZhbWlseSJdLmdldCgicmNfYm9udXNfdHlwZSIsICIiKQogICAgaWYgcmNfYm9udXNfdHlwZSA9PSAiTVlSRVdBUkRTIjoKICAgICAgICBwcmljZV9jdXJyZW5jeSA9ICJQb2luIgoKICAgIGluX3BhY2thZ2VfbWVudSA9IFRydWUKICAgIHdoaWxlIGluX3BhY2thZ2VfbWVudToKICAgICAgICBjbGVhcl9zY3JlZW4oKQogICAgICAgIHByaW50KCI9IiAqIDU1KQogICAgICAgIHByaW50KGYi8J+RqOKAjfCfkanigI3wn5GnIEZhbWlseSBOYW1lOiB7ZGF0YVsncGFja2FnZV9mYW1pbHknXVsnbmFtZSddfSIpCiAgICAgICAgcHJpbnQoZiLwn5SRIEZhbWlseSBDb2RlOiB7ZmFtaWx5X2NvZGV9IikKICAgICAgICBwcmludChmIvCfk6YgRmFtaWx5IFR5cGU6IHtkYXRhWydwYWNrYWdlX2ZhbWlseSddWydwYWNrYWdlX2ZhbWlseV90eXBlJ119IikKICAgICAgICBwcmludChmIvCfk4ogVmFyaWFudCBDb3VudDoge2xlbihkYXRhWydwYWNrYWdlX3ZhcmlhbnRzJ10pfSIpCiAgICAgICAgcHJpbnQoIj0iICogNTUpCiAgICAgICAgcHJpbnQoIuKcqCBQYWtldCBUZXJzZWRpYSDinKgiKQogICAgICAgIHByaW50KCI9IiAqIDU1KQoKICAgICAgICBwYWNrYWdlX3ZhcmlhbnRzID0gZGF0YVsicGFja2FnZV92YXJpYW50cyJdCgogICAgICAgIG9wdGlvbl9udW1iZXIgPSAxCiAgICAgICAgdmFyaWFudF9udW1iZXIgPSAxCgogICAgICAgIGZvciB2YXJpYW50IGluIHBhY2thZ2VfdmFyaWFudHM6CiAgICAgICAgICAgIHZhcmlhbnRfbmFtZSA9IHZhcmlhbnRbIm5hbWUiXQogICAgICAgICAgICB2YXJpYW50X2NvZGUgPSB2YXJpYW50WyJwYWNrYWdlX3ZhcmlhbnRfY29kZSJdCiAgICAgICAgICAgIHByaW50KGYiIFZhcmlhbnQge3ZhcmlhbnRfbnVtYmVyfToge3ZhcmlhbnRfbmFtZX0iKQogICAgICAgICAgICBwcmludChmIiBDb2RlOiB7dmFyaWFudF9jb2RlfSIpCiAgICAgICAgICAgIGZvciBvcHRpb24gaW4gdmFyaWFudFsicGFja2FnZV9vcHRpb25zIl06CiAgICAgICAgICAgICAgICBvcHRpb25fbmFtZSA9IG9wdGlvblsibmFtZSJdCgogICAgICAgICAgICAgICAgcGFja2FnZXMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAibnVtYmVyIjogb3B0aW9uX251bWJlciwKICAgICAgICAgICAgICAgICAgICAidmFyaWFudF9uYW1lIjogdmFyaWFudF9uYW1lLAogICAgICAgICAgICAgICAgICAgICJvcHRpb25fbmFtZSI6IG9wdGlvbl9uYW1lLAogICAgICAgICAgICAgICAgICAgICJwcmljZSI6IG9wdGlvblsicHJpY2UiXSwKICAgICAgICAgICAgICAgICAgICAiY29kZSI6IG9wdGlvblsicGFja2FnZV9vcHRpb25fY29kZSJdLAogICAgICAgICAgICAgICAgICAgICJvcHRpb25fb3JkZXIiOiBvcHRpb25bIm9yZGVyIl0KICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgcHJpbnQoZiIgIFt7b3B0aW9uX251bWJlcn0uXSB7b3B0aW9uX25hbWV9IC0ge3ByaWNlX2N1cnJlbmN5fSB7b3B0aW9uWydwcmljZSddfSIpCiAgICAgICAgICAgICAgICBvcHRpb25fbnVtYmVyICs9IDEKCiAgICAgICAgICAgIGlmIHZhcmlhbnRfbnVtYmVyIDwgbGVuKHBhY2thZ2VfdmFyaWFudHMpOgogICAgICAgICAgICAgICAgcHJpbnQoIi0iICogNTUpCiAgICAgICAgICAgIHZhcmlhbnRfbnVtYmVyICs9IDEKICAgICAgICBwcmludCgiPSIgKiA1NSkKCiAgICAgICAgcHJpbnQoIlswMC5dIEJhbGlrIGtlIG1lbnUgdXRhbWEiKQogICAgICAgIHByaW50KCI9IiAqIDU1KQogICAgICAgIHBrZ19jaG9pY2UgPSBpbnB1dCgiUGlsaWggcGFrZXQgKG5vbW9yKTogIikuc3RyaXAoKQoKICAgICAgICBpZiBwa2dfY2hvaWNlID09ICIwMCI6CiAgICAgICAgICAgIGluX3BhY2thZ2VfbWVudSA9IEZhbHNlCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIGlmIG5vdCBwa2dfY2hvaWNlLmlzZGlnaXQoKToKICAgICAgICAgICAgcHJpbnQoIuKaoO+4jyBJbnB1dCBuZ2dhayB2YWxpZCBicm8uIE1hc3VraW4gbm9tb3IgcGFrZXQgeWFuZyBiZW5lciDinIzvuI8iKQogICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHNlbGVjdGVkX3BrZyA9IG5leHQoKHAgZm9yIHAgaW4gcGFja2FnZXMgaWYgcFsibnVtYmVyIl0gPT0gaW50KHBrZ19jaG9pY2UpKSwgTm9uZSkKCiAgICAgICAgaWYgbm90IHNlbGVjdGVkX3BrZzoKICAgICAgICAgICAgcHJpbnQoIuKdjCBQYWtldCBuZ2dhayBrZXRlbXUgYnJvLiBNYXN1a2luIG5vbW9yIHlhbmcgYmVuZXIuIikKICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBzaG93X3BhY2thZ2VfZGV0YWlscygKICAgICAgICAgICAgYXBpX2tleSwKICAgICAgICAgICAgdG9rZW5zLAogICAgICAgICAgICBzZWxlY3RlZF9wa2dbImNvZGUiXSwKICAgICAgICAgICAgaXNfZW50ZXJwcmlzZSwKICAgICAgICAgICAgb3B0aW9uX29yZGVyPXNlbGVjdGVkX3BrZ1sib3B0aW9uX29yZGVyIl0sCiAgICAgICAgKQoKICAgIHJldHVybiBwYWNrYWdlcwoKCmRlZiBmZXRjaF9teV9wYWNrYWdlcygpOgogICAgaW5fbXlfcGFja2FnZXNfbWVudSA9IFRydWUKICAgIHdoaWxlIGluX215X3BhY2thZ2VzX21lbnU6CiAgICAgICAgYXBpX2tleSA9IEF1dGhJbnN0YW5jZS5hcGlfa2V5CiAgICAgICAgdG9rZW5zID0gQXV0aEluc3RhbmNlLmdldF9hY3RpdmVfdG9rZW5zKCkKICAgICAgICBpZiBub3QgdG9rZW5zOgogICAgICAgICAgICBwcmludCgi4pqg77iPIE5nZ2FrIGFkYSB0b2tlbiBha3RpZiBicm8uIExvZ2luIGR1bHUuIikKICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICBpZF90b2tlbiA9IHRva2Vucy5nZXQoImlkX3Rva2VuIikKICAgICAgICBwYXRoID0gImFwaS92OC9wYWNrYWdlcy9xdW90YS1kZXRhaWxzIgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICJpc19lbnRlcnByaXNlIjogRmFsc2UsCiAgICAgICAgICAgICJsYW5nIjogImVuIiwKICAgICAgICAgICAgImZhbWlseV9tZW1iZXJfaWQiOiAiIgogICAgICAgIH0KCiAgICAgICAgcHJpbnQoIvCflI0gTGFnaSBhbWJpbCBwYWtldCBrYW11IGJyby4uLiIpCiAgICAgICAgcmVzID0gc2VuZF9hcGlfcmVxdWVzdChhcGlfa2V5LCBwYXRoLCBwYXlsb2FkLCBpZF90b2tlbiwgIlBPU1QiKQogICAgICAgIGlmIHJlcy5nZXQoInN0YXR1cyIpICE9ICJTVUNDRVNTIjoKICAgICAgICAgICAgcHJpbnQoIvCfkqUgR2FnYWwgYW1iaWwgcGFrZXQgYnJvLiIpCiAgICAgICAgICAgIHByaW50KCJSZXNwb25zZToiLCByZXMpCiAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgcXVvdGFzID0gcmVzWyJkYXRhIl1bInF1b3RhcyJdCgogICAgICAgIGNsZWFyX3NjcmVlbigpCiAgICAgICAgcHJpbnQoIj0iICogNTUpCiAgICAgICAgcHJpbnQoIvCfk6YgTXkgUGFja2FnZXMiLmNlbnRlcig1NSkpCiAgICAgICAgcHJpbnQoIj0iICogNTUpCgogICAgICAgIG15X3BhY2thZ2VzID0gW10KICAgICAgICBudW0gPSAxCiAgICAgICAgZm9yIHF1b3RhIGluIHF1b3RhczoKICAgICAgICAgICAgcXVvdGFfY29kZSA9IHF1b3RhWyJxdW90YV9jb2RlIl0KICAgICAgICAgICAgZ3JvdXBfY29kZSA9IHF1b3RhWyJncm91cF9jb2RlIl0KICAgICAgICAgICAgZ3JvdXBfbmFtZSA9IHF1b3RhWyJncm91cF9uYW1lIl0KICAgICAgICAgICAgcXVvdGFfbmFtZSA9IHF1b3RhWyJuYW1lIl0KICAgICAgICAgICAgZmFtaWx5X2NvZGUgPSAiTi9BIgoKICAgICAgICAgICAgcHJvZHVjdF9zdWJzY3JpcHRpb25fdHlwZSA9IHF1b3RhLmdldCgicHJvZHVjdF9zdWJzY3JpcHRpb25fdHlwZSIsICIiKQogICAgICAgICAgICBwcm9kdWN0X2RvbWFpbiA9IHF1b3RhLmdldCgicHJvZHVjdF9kb21haW4iLCAiIikKCiAgICAgICAgICAgIGJlbmVmaXRfaW5mb3MgPSBbXQogICAgICAgICAgICBmb3IgYmVuZWZpdCBpbiBxdW90YS5nZXQoImJlbmVmaXRzIiwgW10pOgogICAgICAgICAgICAgICAgYmVuZWZpdF9pZCA9IGJlbmVmaXQuZ2V0KCJpZCIsICIiKQogICAgICAgICAgICAgICAgbmFtZSA9IGJlbmVmaXQuZ2V0KCJuYW1lIiwgIiIpCiAgICAgICAgICAgICAgICBkYXRhX3R5cGUgPSBiZW5lZml0LmdldCgiZGF0YV90eXBlIiwgIk4vQSIpCiAgICAgICAgICAgICAgICBiZW5lZml0X2luZm8gPSAiICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuIgogICAgICAgICAgICAgICAgYmVuZWZpdF9pbmZvICs9IGYiICBJRCAgICA6IHtiZW5lZml0X2lkfVxuIgogICAgICAgICAgICAgICAgYmVuZWZpdF9pbmZvICs9IGYiICBOYW1lICA6IHtuYW1lfVxuIgogICAgICAgICAgICAgICAgYmVuZWZpdF9pbmZvICs9IGYiICBUeXBlICA6IHtkYXRhX3R5cGV9XG4iCgogICAgICAgICAgICAgICAgcmVtYWluaW5nID0gYmVuZWZpdC5nZXQoInJlbWFpbmluZyIsIDApCiAgICAgICAgICAgICAgICB0b3RhbCA9IGJlbmVmaXQuZ2V0KCJ0b3RhbCIsIDApCgogICAgICAgICAgICAgICAgaWYgZGF0YV90eXBlID09ICJEQVRBIjoKICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdfc3RyID0gZm9ybWF0X3F1b3RhX2J5dGUocmVtYWluaW5nKQogICAgICAgICAgICAgICAgICAgIHRvdGFsX3N0ciA9IGZvcm1hdF9xdW90YV9ieXRlKHRvdGFsKQogICAgICAgICAgICAgICAgICAgIGJlbmVmaXRfaW5mbyArPSBmIiAgS3VvdGEgOiB7cmVtYWluaW5nX3N0cn0gLyB7dG90YWxfc3RyfSIKICAgICAgICAgICAgICAgIGVsaWYgZGF0YV90eXBlID09ICJWT0lDRSI6CiAgICAgICAgICAgICAgICAgICAgYmVuZWZpdF9pbmZvICs9IGYiICBLdW90YSA6IHtyZW1haW5pbmcvNjA6LjJmfSAvIHt0b3RhbC82MDouMmZ9IG1lbml0IgogICAgICAgICAgICAgICAgZWxpZiBkYXRhX3R5cGUgPT0gIlRFWFQiOgogICAgICAgICAgICAgICAgICAgIGJlbmVmaXRfaW5mbyArPSBmIiAgS3VvdGEgOiB7cmVtYWluaW5nfSAvIHt0b3RhbH0gU01TIgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBiZW5lZml0X2luZm8gKz0gZiIgIEt1b3RhIDoge3JlbWFpbmluZ30gLyB7dG90YWx9IgoKICAgICAgICAgICAgICAgIGJlbmVmaXRfaW5mb3MuYXBwZW5kKGJlbmVmaXRfaW5mbykKCiAgICAgICAgICAgIHByaW50KGYi8J+UjiBGZXRjaGluZyBwYWNrYWdlIG5vLiB7bnVtfSBkZXRhaWxzLi4uIikKICAgICAgICAgICAgcGFja2FnZV9kZXRhaWxzID0gZ2V0X3BhY2thZ2UoYXBpX2tleSwgdG9rZW5zLCBxdW90YV9jb2RlKQogICAgICAgICAgICBpZiBwYWNrYWdlX2RldGFpbHM6CiAgICAgICAgICAgICAgICBmYW1pbHlfY29kZSA9IHBhY2thZ2VfZGV0YWlsc1sicGFja2FnZV9mYW1pbHkiXVsicGFja2FnZV9mYW1pbHlfY29kZSJdCgogICAgICAgICAgICBwcmludCgiPSIgKiA1NSkKICAgICAgICAgICAgcHJpbnQoZiLwn5OmIFBhY2thZ2Uge251bX0iKQogICAgICAgICAgICBwcmludChmIk5hbWU6IHtxdW90YV9uYW1lfSIpCiAgICAgICAgICAgIHByaW50KCJCZW5lZml0czoiKQogICAgICAgICAgICBpZiBiZW5lZml0X2luZm9zOgogICAgICAgICAgICAgICAgZm9yIGJpIGluIGJlbmVmaXRfaW5mb3M6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoYmkpCiAgICAgICAgICAgICAgICBwcmludCgiICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSIpCiAgICAgICAgICAgIHByaW50KGYiR3JvdXAgTmFtZToge2dyb3VwX25hbWV9IikKICAgICAgICAgICAgcHJpbnQoZiJRdW90YSBDb2RlOiB7cXVvdGFfY29kZX0iKQogICAgICAgICAgICBwcmludChmIkZhbWlseSBDb2RlOiB7ZmFtaWx5X2NvZGV9IikKICAgICAgICAgICAgcHJpbnQoZiJHcm91cCBDb2RlOiB7Z3JvdXBfY29kZX0iKQogICAgICAgICAgICBwcmludCgiPSIgKiA1NSkKCiAgICAgICAgICAgIG15X3BhY2thZ2VzLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAibnVtYmVyIjogbnVtLAogICAgICAgICAgICAgICAgIm5hbWUiOiBxdW90YV9uYW1lLAogICAgICAgICAgICAgICAgInF1b3RhX2NvZGUiOiBxdW90YV9jb2RlLAogICAgICAgICAgICAgICAgInByb2R1Y3Rfc3Vic2NyaXB0aW9uX3R5cGUiOiBwcm9kdWN0X3N1YnNjcmlwdGlvbl90eXBlLAogICAgICAgICAgICAgICAgInByb2R1Y3RfZG9tYWluIjogcHJvZHVjdF9kb21haW4sCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIG51bSArPSAxCgogICAgICAgIHByaW50KCLwn5GJIElucHV0IG5vbW9yIHBha2V0IGJ1YXQgbGlhdCBkZXRhaWwuIikKICAgICAgICBwcmludCgi8J+RiSBJbnB1dCBkZWwgPG5vbW9yIHBha2V0PiBidWF0IHVuc3Vic2NyaWJlLiIpCiAgICAgICAgcHJpbnQoIvCfkYkgSW5wdXQgMDAgYnVhdCBiYWxpayBrZSBtZW51IHV0YW1hLiIpCiAgICAgICAgcHJpbnQoIj0iICogNTUpCiAgICAgICAgY2hvaWNlID0gaW5wdXQoIlBpbGloYW46ICIpLnN0cmlwKCkKCiAgICAgICAgaWYgY2hvaWNlID09ICIwMCI6CiAgICAgICAgICAgIGluX215X3BhY2thZ2VzX21lbnUgPSBGYWxzZQoKICAgICAgICBlbGlmIGNob2ljZS5pc2RpZ2l0KCkgYW5kIDEgPD0gaW50KGNob2ljZSkgPD0gbGVuKG15X3BhY2thZ2VzKToKICAgICAgICAgICAgc2VsZWN0ZWRfcGtnID0gbmV4dCgocGtnIGZvciBwa2cgaW4gbXlfcGFja2FnZXMgaWYgcGtnWyJudW1iZXIiXSA9PSBpbnQoY2hvaWNlKSksIE5vbmUpCiAgICAgICAgICAgIGlmIG5vdCBzZWxlY3RlZF9wa2c6CiAgICAgICAgICAgICAgICBwcmludCgi4p2MIFBha2V0IG5nZ2FrIGtldGVtdSBicm8uIE1hc3VraW4gbm9tb3IgeWFuZyBiZW5lci4iKQogICAgICAgICAgICAgICAgcGF1c2UoKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgXyA9IHNob3dfcGFja2FnZV9kZXRhaWxzKGFwaV9rZXksIHRva2Vucywgc2VsZWN0ZWRfcGtnWyJxdW90YV9jb2RlIl0sIEZhbHNlKQoKICAgICAgICBlbGlmIGNob2ljZS5zdGFydHN3aXRoKCJkZWwgIik6CiAgICAgICAgICAgIGRlbF9wYXJ0cyA9IGNob2ljZS5zcGxpdCgiICIpCiAgICAgICAgICAgIGlmIGxlbihkZWxfcGFydHMpICE9IDIgb3Igbm90IGRlbF9wYXJ0c1sxXS5pc2RpZ2l0KCk6CiAgICAgICAgICAgICAgICBwcmludCgi4pqg77iPIEZvcm1hdCBpbnB1dCBkZWxldGUgbmdnYWsgdmFsaWQgYnJvLiIpCiAgICAgICAgICAgICAgICBwYXVzZSgpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgZGVsX251bWJlciA9IGludChkZWxfcGFydHNbMV0pCiAgICAgICAgICAgIGRlbF9wa2cgPSBuZXh0KChwa2cgZm9yIHBrZyBpbiBteV9wYWNrYWdlcyBpZiBwa2dbIm51bWJlciJdID09IGRlbF9udW1iZXIpLCBOb25lKQogICAgICAgICAgICBpZiBub3QgZGVsX3BrZzoKICAgICAgICAgICAgICAgIHByaW50KCLinYwgUGFrZXQgYnVhdCBkaWhhcHVzIG5nZ2FrIGtldGVtdSBicm8uIikKICAgICAgICAgICAgICAgIHBhdXNlKCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBjb25maXJtID0gaW5wdXQoZiJZYWtpbiBtYXUgdW5zdWJzY3JpYmUgZGFyaSBwYWtldCB7ZGVsX251bWJlcn0uIHtkZWxfcGtnWyduYW1lJ119PyAoeS9uKTogIikuc3RyaXAoKS5sb3dlcigpCiAgICAgICAgICAgIGlmIGNvbmZpcm0gPT0gJ3knOgogICAgICAgICAgICAgICAgcHJpbnQoZiLwn5SEIFVuc3Vic2NyaWJpbmcgZGFyaSBwYWtldCB7ZGVsX3BrZ1snbmFtZSddfS4uLiIpCiAgICAgICAgICAgICAgICBzdWNjZXNzID0gdW5zdWJzY3JpYmUoCiAgICAgICAgICAgICAgICAgICAgYXBpX2tleSwKICAgICAgICAgICAgICAgICAgICB0b2tlbnMsCiAgICAgICAgICAgICAgICAgICAgZGVsX3BrZ1sicXVvdGFfY29kZSJdLAogICAgICAgICAgICAgICAgICAgIGRlbF9wa2dbInByb2R1Y3Rfc3Vic2NyaXB0aW9uX3R5cGUiXSwKICAgICAgICAgICAgICAgICAgICBkZWxfcGtnWyJwcm9kdWN0X2RvbWFpbiJdCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgICAgIHByaW50KCLinIUgQmVyaGFzaWwgdW5zdWJzY3JpYmUgYnJvLiIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHByaW50KCLwn5KlIEdhZ2FsIHVuc3Vic2NyaWJlIGJyby4iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQoIuKGqe+4jyBVbnN1YnNjcmliZSBkaWJhdGFsaW4gYnJvLiIpCiAgICAgICAgICAgIHBhdXNlKCkKCg==').decode())
