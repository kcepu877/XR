#!/usr/bin/env python3
import base64
exec(base64.b64decode('aW1wb3J0IG9zCmltcG9ydCBqc29uCmltcG9ydCB1dWlkCmltcG9ydCByZXF1ZXN0cwpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgdGltZXpvbmUKCmZyb20gYXBwMy5tZW51cy51dGlsIGltcG9ydCBsaXZlX2xvYWRpbmcKZnJvbSBhcHAzLmNvbmZpZy50aGVtZV9jb25maWcgaW1wb3J0IGdldF90aGVtZQpmcm9tIGFwcDMuY2xpZW50LmVuY3J5cHQgaW1wb3J0ICgKICAgIGVuY3J5cHRzaWduX3hkYXRhLAogICAgamF2YV9saWtlX3RpbWVzdGFtcCwKICAgIGRlY3J5cHRfeGRhdGEsCiAgICBBUElfS0VZLAopCgpCQVNFX0FQSV9VUkwgPSBvcy5nZXRlbnYoIkJBU0VfQVBJX1VSTCIpCmlmIG5vdCBCQVNFX0FQSV9VUkw6CiAgICByYWlzZSBWYWx1ZUVycm9yKCJCQVNFX0FQSV9VUkwgZW52aXJvbm1lbnQgdmFyaWFibGUgdGlkYWsgZGlzZXQiKQpVQSA9IG9zLmdldGVudigiVUEiKQoKCmRlZiBzZW5kX2FwaV9yZXF1ZXN0KGFwaV9rZXk6IHN0ciwgcGF0aDogc3RyLCBwYXlsb2FkX2RpY3Q6IGRpY3QsIGlkX3Rva2VuOiBzdHIsIG1ldGhvZDogc3RyID0gIlBPU1QiKToKICAgIGVuY3J5cHRlZF9wYXlsb2FkID0gZW5jcnlwdHNpZ25feGRhdGEoCiAgICAgICAgYXBpX2tleT1hcGlfa2V5LAogICAgICAgIG1ldGhvZD1tZXRob2QsCiAgICAgICAgcGF0aD1wYXRoLAogICAgICAgIGlkX3Rva2VuPWlkX3Rva2VuLAogICAgICAgIHBheWxvYWQ9cGF5bG9hZF9kaWN0LAogICAgKQoKICAgIHh0aW1lID0gaW50KGVuY3J5cHRlZF9wYXlsb2FkWyJlbmNyeXB0ZWRfYm9keSJdWyJ4dGltZSJdKQogICAgbm93ID0gZGF0ZXRpbWUubm93KHRpbWV6b25lLnV0YykuYXN0aW1lem9uZSgpCiAgICBzaWdfdGltZV9zZWMgPSB4dGltZSAvLyAxMDAwCgogICAgYm9keSA9IGVuY3J5cHRlZF9wYXlsb2FkWyJlbmNyeXB0ZWRfYm9keSJdCiAgICB4X3NpZyA9IGVuY3J5cHRlZF9wYXlsb2FkWyJ4X3NpZ25hdHVyZSJdCgogICAgaGVhZGVycyA9IHsKICAgICAgICAiaG9zdCI6IEJBU0VfQVBJX1VSTC5yZXBsYWNlKCJodHRwczovLyIsICIiKSwKICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgiLAogICAgICAgICJ1c2VyLWFnZW50IjogVUEsCiAgICAgICAgIngtYXBpLWtleSI6IEFQSV9LRVksCiAgICAgICAgImF1dGhvcml6YXRpb24iOiBmIkJlYXJlciB7aWRfdG9rZW59IiwKICAgICAgICAieC1odiI6ICJ2MyIsCiAgICAgICAgIngtc2lnbmF0dXJlLXRpbWUiOiBzdHIoc2lnX3RpbWVfc2VjKSwKICAgICAgICAieC1zaWduYXR1cmUiOiB4X3NpZywKICAgICAgICAieC1yZXF1ZXN0LWlkIjogc3RyKHV1aWQudXVpZDQoKSksCiAgICAgICAgIngtcmVxdWVzdC1hdCI6IGphdmFfbGlrZV90aW1lc3RhbXAobm93KSwKICAgICAgICAieC12ZXJzaW9uLWFwcCI6ICI4LjkuMSIsCiAgICB9CgogICAgdXJsID0gZiJ7QkFTRV9BUElfVVJMfS97cGF0aH0iCiAgICByZXNwID0gcmVxdWVzdHMucG9zdCh1cmwsIGhlYWRlcnM9aGVhZGVycywgZGF0YT1qc29uLmR1bXBzKGJvZHkpLCB0aW1lb3V0PTMwKQoKICAgIHRyeToKICAgICAgICByZXR1cm4gZGVjcnlwdF94ZGF0YShhcGlfa2V5LCBqc29uLmxvYWRzKHJlc3AudGV4dCkpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmV0dXJuIHsiZXJyb3IiOiBmIkdhZ2FsIGRlY3J5cHQgcmVzcG9uc2U6IHtlfSIsICJyYXciOiByZXNwLnRleHR9CgoKZGVmIF93aXRoX2xvYWRpbmcobWVzc2FnZTogc3RyLCBmdW5jLCB1c2VfbG9hZGluZzogYm9vbCwgdGhlbWUsICphcmdzLCAqKmt3YXJncyk6CiAgICBpZiB1c2VfbG9hZGluZzoKICAgICAgICB3aXRoIGxpdmVfbG9hZGluZyhtZXNzYWdlLCB0aGVtZSk6CiAgICAgICAgICAgIHJldHVybiBmdW5jKCphcmdzLCAqKmt3YXJncykKICAgIHJldHVybiBmdW5jKCphcmdzLCAqKmt3YXJncykKCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBBUEkgV3JhcHBlciBGdW5jdGlvbnMKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpkZWYgZ2V0X3Byb2ZpbGUoYXBpX2tleTogc3RyLCBhY2Nlc3NfdG9rZW46IHN0ciwgaWRfdG9rZW46IHN0ciwgdXNlX2xvYWRpbmc6IGJvb2wgPSBUcnVlKSAtPiBkaWN0IHwgTm9uZToKICAgIHBhdGggPSAiYXBpL3Y4L3Byb2ZpbGUiCiAgICBwYXlsb2FkID0gewogICAgICAgICJhY2Nlc3NfdG9rZW4iOiBhY2Nlc3NfdG9rZW4sCiAgICAgICAgImFwcF92ZXJzaW9uIjogIjguOS4xIiwKICAgICAgICAiaXNfZW50ZXJwcmlzZSI6IEZhbHNlLAogICAgICAgICJsYW5nIjogImVuIiwKICAgIH0KICAgIHJldHVybiBfd2l0aF9sb2FkaW5nKCLwn5OhIE1lbmdhbWJpbCBwcm9maWwuLi4iLCBzZW5kX2FwaV9yZXF1ZXN0LCB1c2VfbG9hZGluZywgZ2V0X3RoZW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgICBhcGlfa2V5LCBwYXRoLCBwYXlsb2FkLCBpZF90b2tlbiwgIlBPU1QiKS5nZXQoImRhdGEiKQoKCmRlZiBnZXRfYmFsYW5jZShhcGlfa2V5OiBzdHIsIGlkX3Rva2VuOiBzdHIsIHVzZV9sb2FkaW5nOiBib29sID0gVHJ1ZSkgLT4gZGljdCB8IE5vbmU6CiAgICBwYXRoID0gImFwaS92OC9wYWNrYWdlcy9iYWxhbmNlLWFuZC1jcmVkaXQiCiAgICBwYXlsb2FkID0geyJpc19lbnRlcnByaXNlIjogRmFsc2UsICJsYW5nIjogImVuIn0KICAgIHJlcyA9IF93aXRoX2xvYWRpbmcoIvCfkrAgTWVuZ2FtYmlsIHNhbGRvLi4uIiwgc2VuZF9hcGlfcmVxdWVzdCwgdXNlX2xvYWRpbmcsIGdldF90aGVtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBhcGlfa2V5LCBwYXRoLCBwYXlsb2FkLCBpZF90b2tlbiwgIlBPU1QiKQogICAgcmV0dXJuIHJlcy5nZXQoImRhdGEiLCB7fSkuZ2V0KCJiYWxhbmNlIikKCgpkZWYgZ2V0X2ZhbWlseShhcGlfa2V5OiBzdHIsIHRva2VuczogZGljdCwgZmFtaWx5X2NvZGU6IHN0ciwKICAgICAgICAgICAgICAgaXNfZW50ZXJwcmlzZTogYm9vbCB8IE5vbmUgPSBOb25lLAogICAgICAgICAgICAgICBtaWdyYXRpb25fdHlwZTogc3RyIHwgTm9uZSA9IE5vbmUsCiAgICAgICAgICAgICAgIHVzZV9sb2FkaW5nOiBib29sID0gVHJ1ZSkgLT4gZGljdCB8IE5vbmU6CiAgICB0aGVtZSA9IGdldF90aGVtZSgpCiAgICBpc19lbnRlcnByaXNlX2xpc3QgPSBbRmFsc2UsIFRydWVdIGlmIGlzX2VudGVycHJpc2UgaXMgTm9uZSBlbHNlIFtpc19lbnRlcnByaXNlXQogICAgbWlncmF0aW9uX3R5cGVfbGlzdCA9IFsiTk9ORSIsICJQUkVfVE9fUFJJT0giLCAiUFJJT0hfVE9fUFJJTyIsICJQUklPX1RPX1BSSU9IIl0gaWYgbWlncmF0aW9uX3R5cGUgaXMgTm9uZSBlbHNlIFttaWdyYXRpb25fdHlwZV0KICAgIHBhdGggPSAiYXBpL3Y4L3hsLXN0b3Jlcy9vcHRpb25zL2xpc3QiCiAgICBpZF90b2tlbiA9IHRva2Vucy5nZXQoImlkX3Rva2VuIikKCiAgICBkZWYgX2ZldGNoX2ZhbWlseSgpOgogICAgICAgIGZvciBtdCBpbiBtaWdyYXRpb25fdHlwZV9saXN0OgogICAgICAgICAgICBmb3IgaWUgaW4gaXNfZW50ZXJwcmlzZV9saXN0OgogICAgICAgICAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgICAgICAgICAiaXNfc2hvd190YWdnaW5nX3RhYiI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgImlzX2RlZGljYXRlZF9ldmVudCI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgImlzX3RyYW5zYWN0aW9uX3JvdXRpbmUiOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAibWlncmF0aW9uX3R5cGUiOiBtdCwKICAgICAgICAgICAgICAgICAgICAicGFja2FnZV9mYW1pbHlfY29kZSI6IGZhbWlseV9jb2RlLAogICAgICAgICAgICAgICAgICAgICJpc19hdXRvYnV5IjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgImlzX2VudGVycHJpc2UiOiBpZSwKICAgICAgICAgICAgICAgICAgICAiaXNfcGRscCI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgInJlZmVycmFsX2NvZGUiOiAiIiwKICAgICAgICAgICAgICAgICAgICAiaXNfbWlncmF0aW9uIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgImxhbmciOiAiZW4iLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzID0gc2VuZF9hcGlfcmVxdWVzdChhcGlfa2V5LCBwYXRoLCBwYXlsb2FkLCBpZF90b2tlbiwgIlBPU1QiKQogICAgICAgICAgICAgICAgaWYgcmVzLmdldCgic3RhdHVzIikgPT0gIlNVQ0NFU1MiOgogICAgICAgICAgICAgICAgICAgIGZhbWlseV9uYW1lID0gcmVzWyJkYXRhIl1bInBhY2thZ2VfZmFtaWx5Il0uZ2V0KCJuYW1lIiwgIiIpCiAgICAgICAgICAgICAgICAgICAgaWYgZmFtaWx5X25hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNbImRhdGEiXQogICAgICAgIHJldHVybiBOb25lCgogICAgcmV0dXJuIF93aXRoX2xvYWRpbmcoZiLwn5OmIE1lbmdhbWJpbCBmYW1pbHkgcGFrZXQge2ZhbWlseV9jb2RlfS4uLiIsIF9mZXRjaF9mYW1pbHksIHVzZV9sb2FkaW5nLCB0aGVtZSkKCgpkZWYgZ2V0X2ZhbWlsaWVzKGFwaV9rZXk6IHN0ciwgdG9rZW5zOiBkaWN0LCBwYWNrYWdlX2NhdGVnb3J5X2NvZGU6IHN0ciwgdXNlX2xvYWRpbmc6IGJvb2wgPSBUcnVlKSAtPiBkaWN0IHwgTm9uZToKICAgIHBhdGggPSAiYXBpL3Y4L3hsLXN0b3Jlcy9mYW1pbGllcyIKICAgIHBheWxvYWQgPSB7CiAgICAgICAgIm1pZ3JhdGlvbl90eXBlIjogIiIsCiAgICAgICAgImlzX2VudGVycHJpc2UiOiBGYWxzZSwKICAgICAgICAiaXNfc2hhcmVhYmxlIjogRmFsc2UsCiAgICAgICAgInBhY2thZ2VfY2F0ZWdvcnlfY29kZSI6IHBhY2thZ2VfY2F0ZWdvcnlfY29kZSwKICAgICAgICAid2l0aF9pY29uX3VybCI6IFRydWUsCiAgICAgICAgImlzX21pZ3JhdGlvbiI6IEZhbHNlLAogICAgICAgICJsYW5nIjogImVuIiwKICAgIH0KICAgIHJlcyA9IF93aXRoX2xvYWRpbmcoZiLwn5OCIE1lbmdhbWJpbCBmYW1pbGllcyBrYXRlZ29yaSB7cGFja2FnZV9jYXRlZ29yeV9jb2RlfS4uLiIsIHNlbmRfYXBpX3JlcXVlc3QsIHVzZV9sb2FkaW5nLCBnZXRfdGhlbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgYXBpX2tleSwgcGF0aCwgcGF5bG9hZCwgdG9rZW5zWyJpZF90b2tlbiJdLCAiUE9TVCIpCiAgICByZXR1cm4gcmVzLmdldCgiZGF0YSIpIGlmIHJlcy5nZXQoInN0YXR1cyIpID09ICJTVUNDRVNTIiBlbHNlIE5vbmUKCgpkZWYgZ2V0X3BhY2thZ2UoYXBpX2tleTogc3RyLCB0b2tlbnM6IGRpY3QsCiAgICAgICAgICAgICAgICBwYWNrYWdlX29wdGlvbl9jb2RlOiBzdHIsCiAgICAgICAgICAgICAgICBwYWNrYWdlX2ZhbWlseV9jb2RlOiBzdHIgPSAiIiwKICAgICAgICAgICAgICAgIHBhY2thZ2VfdmFyaWFudF9jb2RlOiBzdHIgPSAiIiwKICAgICAgICAgICAgICAgIHVzZV9sb2FkaW5nOiBib29sID0gVHJ1ZSkgLT4gZGljdCB8IE5vbmU6CiAgICBwYXRoID0gImFwaS92OC94bC1zdG9yZXMvb3B0aW9ucy9kZXRhaWwiCiAgICBwYXlsb2FkID0gewogICAgICAgICJpc190cmFuc2FjdGlvbl9yb3V0aW5lIjogRmFsc2UsCiAgICAgICAgIm1pZ3JhdGlvbl90eXBlIjogIk5PTkUiLAogICAgICAgICJwYWNrYWdlX2ZhbWlseV9jb2RlIjogcGFja2FnZV9mYW1pbHlfY29kZSwKICAgICAgICAiZmFtaWx5X3JvbGVfaHViIjogIiIsCiAgICAgICAgImlzX2F1dG9idXkiOiBGYWxzZSwKICAgICAgICAiaXNfZW50ZXJwcmlzZSI6IEZhbHNlLAogICAgICAgICJpc19zaGFyZWFibGUiOiBGYWxzZSwKICAgICAgICAiaXNfbWlncmF0aW9uIjogRmFsc2UsCiAgICAgICAgImxhbmciOiAiaWQiLAogICAgICAgICJwYWNrYWdlX29wdGlvbl9jb2RlIjogcGFja2FnZV9vcHRpb25fY29kZSwKICAgICAgICAiaXNfdXBzZWxsX3BkcCI6IEZhbHNlLAogICAgICAgICJwYWNrYWdlX3ZhcmlhbnRfY29kZSI6IHBhY2thZ2VfdmFyaWFudF9jb2RlLAogICAgfQogICAgcmVzID0gX3dpdGhfbG9hZGluZygi8J+TpiBNZW5nYW1iaWwgZGV0YWlsIHBha2V0Li4uIiwgc2VuZF9hcGlfcmVxdWVzdCwgdXNlX2xvYWRpbmcsIGdldF90aGVtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBhcGlfa2V5LCBwYXRoLCBwYXlsb2FkLCB0b2tlbnNbImlkX3Rva2VuIl0sICJQT1NUIikKICAgIHJldHVybiByZXMuZ2V0KCJkYXRhIikKCgpkZWYgZ2V0X3BhY2thZ2VfZGV0YWlscyhhcGlfa2V5OiBzdHIsIHRva2VuczogZGljdCwKICAgICAgICAgICAgICAgICAgICAgICAgZmFtaWx5X2NvZGU6IHN0ciwgdmFyaWFudF9jb2RlOiBzdHIsIG9wdGlvbl9vcmRlcjogaW50LAogICAgICAgICAgICAgICAgICAgICAgICBpc19lbnRlcnByaXNlOiBib29sIHwgTm9uZSA9IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG1pZ3JhdGlvbl90eXBlOiBzdHIgfCBOb25lID0gTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgdXNlX2xvYWRpbmc6IGJvb2wgPSBUcnVlKSAtPiBkaWN0IHwgTm9uZToKICAgIGZhbWlseV9kYXRhID0gZ2V0X2ZhbWlseShhcGlfa2V5LCB0b2tlbnMsIGZhbWlseV9jb2RlLCBpc19lbnRlcnByaXNlLCBtaWdyYXRpb25fdHlwZSwgdXNlX2xvYWRpbmcpCiAgICBpZiBub3QgZmFtaWx5X2RhdGE6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBvcHRpb25fY29kZSA9IE5vbmUKICAgIGZvciB2YXJpYW50IGluIGZhbWlseV9kYXRhLmdldCgicGFja2FnZV92YXJpYW50cyIsIFtdKToKICAgICAgICBpZiB2YXJpYW50LmdldCgicGFja2FnZV92YXJpYW50X2NvZGUiKSA9PSB2YXJpYW50X2NvZGU6CiAgICAgICAgICAgIGZvciBvcHRpb24gaW4gdmFyaWFudC5nZXQoInBhY2thZ2Vfb3B0aW9ucyIsIFtdKToKICAgICAgICAgICAgICAgIGlmIG9wdGlvbi5nZXQoIm9yZGVyIikgPT0gb3B0aW9uX29yZGVyOgogICAgICAgICAgICAgICAgICAgIG9wdGlvbl9jb2RlID0gb3B0aW9uLmdldCgicGFja2FnZV9vcHRpb25fY29kZSIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgIGlmIG5vdCBvcHRpb25fY29kZToKICAgICAgICByZXR1cm4gTm9uZQoKICAgIHJldHVybiBnZXRfcGFja2FnZShhcGlfa2V5LCB0b2tlbnMsIG9wdGlvbl9jb2RlLCB1c2VfbG9hZGluZz11c2VfbG9hZGluZykKCgpkZWYgZ2V0X2FkZG9ucyhhcGlfa2V5OiBzdHIsIHRva2VuczogZGljdCwgcGFja2FnZV9vcHRpb25fY29kZTogc3RyLCB1c2VfbG9hZGluZzogYm9vbCA9IFRydWUpIC0+IGRpY3QgfCBOb25lOgogICAgcGF0aCA9ICJhcGkvdjgveGwtc3RvcmVzL29wdGlvbnMvYWRkb25zLXBpbmt5LWJveCIKICAgIHBheWxvYWQgPSB7ImlzX2VudGVycHJpc2UiOiBGYWxzZSwgImxhbmciOiAiZW4iLCAicGFja2FnZV9vcHRpb25fY29kZSI6IHBhY2thZ2Vfb3B0aW9uX2NvZGV9CiAgICByZXMgPSBfd2l0aF9sb2FkaW5nKGYi8J+nqSBNZW5nYW1iaWwgYWRkb25zLi4uIiwgc2VuZF9hcGlfcmVxdWVzdCwgdXNlX2xvYWRpbmcsIGdldF90aGVtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBhcGlfa2V5LCBwYXRoLCBwYXlsb2FkLCB0b2tlbnNbImlkX3Rva2VuIl0sICJQT1NUIikKICAgIHJldHVybiByZXMuZ2V0KCJkYXRhIikKCgpkZWYgaW50ZXJjZXB0X3BhZ2UoYXBpX2tleTogc3RyLCB0b2tlbnM6IGRpY3QsIG9wdGlvbl9jb2RlOiBzdHIsIGlzX2VudGVycHJpc2U6IGJvb2wgPSBGYWxzZSwgdXNlX2xvYWRpbmc6IGJvb2wgPSBUcnVlKSAtPiBkaWN0IHwgTm9uZToKICAgIHBhdGggPSAibWlzYy9hcGkvdjgvdXRpbGl0eS9pbnRlcmNlcHQtcGFnZSIKICAgIHBheWxvYWQgPSB7ImlzX2VudGVycHJpc2UiOiBpc19lbnRlcnByaXNlLCAibGFuZyI6ICJlbiIsICJwYWNrYWdlX29wdGlvbl9jb2RlIjogb3B0aW9uX2NvZGV9CiAgICByZXR1cm4gX3dpdGhfbG9hZGluZyhmIvCfm6HvuI8gTWVuZ2FtYmlsIGludGVyY2VwdC4uLiIsIHNlbmRfYXBpX3JlcXVlc3QsIHVzZV9sb2FkaW5nLCBnZXRfdGhlbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgIGFwaV9rZXksIHBhdGgsIHBheWxvYWQsIHRva2Vuc1siaWRfdG9rZW4iXSwgIlBPU1QiKQoKCmRlZiBsb2dpbl9pbmZvKGFwaV9rZXk6IHN0ciwgdG9rZW5zOiBkaWN0LCBpc19lbnRlcnByaXNlOiBib29sID0gRmFsc2UsIHVzZV9sb2FkaW5nOiBib29sID0gVHJ1ZSkgLT4gZGljdCB8IE5vbmU6CiAgICBwYXRoID0gImFwaS92OC9hdXRoL2xvZ2luIgogICAgcGF5bG9hZCA9IHsKICAgICAgICAiYWNjZXNzX3Rva2VuIjogdG9rZW5zWyJhY2Nlc3NfdG9rZW4iXSwKICAgICAgICAiaXNfZW50ZXJwcmlzZSI6IGlzX2VudGVycHJpc2UsCiAgICAgICAgImxhbmciOiAiZW4iLAogICAgfQogICAgcmVzID0gX3dpdGhfbG9hZGluZygi8J+UkSBNZW5nYW1iaWwgaW5mbyBsb2dpbi4uLiIsIHNlbmRfYXBpX3JlcXVlc3QsIHVzZV9sb2FkaW5nLCBnZXRfdGhlbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgYXBpX2tleSwgcGF0aCwgcGF5bG9hZCwgdG9rZW5zWyJpZF90b2tlbiJdLCAiUE9TVCIpCiAgICByZXR1cm4gcmVzLmdldCgiZGF0YSIpCgoKZGVmIGdldF9ub3RpZmljYXRpb25zKGFwaV9rZXk6IHN0ciwgdG9rZW5zOiBkaWN0LCB1c2VfbG9hZGluZzogYm9vbCA9IFRydWUpIC0+IGRpY3QgfCBOb25lOgogICAgcGF0aCA9ICJhcGkvdjgvbm90aWZpY2F0aW9uLW5vbi1ncm91cGluZyIKICAgIHBheWxvYWQgPSB7ImlzX2VudGVycHJpc2UiOiBGYWxzZSwgImxhbmciOiAiZW4ifQogICAgcmVzID0gX3dpdGhfbG9hZGluZygi8J+UlCBNZW5nYW1iaWwgbm90aWZpa2FzaS4uLiIsIHNlbmRfYXBpX3JlcXVlc3QsIHVzZV9sb2FkaW5nLCBnZXRfdGhlbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgYXBpX2tleSwgcGF0aCwgcGF5bG9hZCwgdG9rZW5zWyJpZF90b2tlbiJdLCAiUE9TVCIpCiAgICByZXR1cm4gcmVzIGlmIHJlcy5nZXQoInN0YXR1cyIpID09ICJTVUNDRVNTIiBlbHNlIE5vbmUKCgpkZWYgZ2V0X25vdGlmaWNhdGlvbl9kZXRhaWwoYXBpX2tleTogc3RyLCB0b2tlbnM6IGRpY3QsIG5vdGlmaWNhdGlvbl9pZDogc3RyLCB1c2VfbG9hZGluZzogYm9vbCA9IFRydWUpIC0+IGRpY3QgfCBOb25lOgogICAgcGF0aCA9ICJhcGkvdjgvbm90aWZpY2F0aW9uL2RldGFpbCIKICAgIHBheWxvYWQgPSB7ImlzX2VudGVycHJpc2UiOiBGYWxzZSwgImxhbmciOiAiZW4iLCAibm90aWZpY2F0aW9uX2lkIjogbm90aWZpY2F0aW9uX2lkfQogICAgcmVzID0gX3dpdGhfbG9hZGluZyhmIvCflJQgTWVuZ2FtYmlsIGRldGFpbCBub3RpZmlrYXNpIHtub3RpZmljYXRpb25faWR9Li4uIiwgc2VuZF9hcGlfcmVxdWVzdCwgdXNlX2xvYWRpbmcsIGdldF90aGVtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBhcGlfa2V5LCBwYXRoLCBwYXlsb2FkLCB0b2tlbnNbImlkX3Rva2VuIl0sICJQT1NUIikKICAgIHJldHVybiByZXMgaWYgcmVzLmdldCgic3RhdHVzIikgPT0gIlNVQ0NFU1MiIGVsc2UgTm9uZQoKCmRlZiBnZXRfcGVuZGluZ190cmFuc2FjdGlvbihhcGlfa2V5OiBzdHIsIHRva2VuczogZGljdCwgdXNlX2xvYWRpbmc6IGJvb2wgPSBUcnVlKSAtPiBkaWN0IHwgTm9uZToKICAgIHBhdGggPSAiYXBpL3Y4L3Byb2ZpbGUiCiAgICBwYXlsb2FkID0geyJpc19lbnRlcnByaXNlIjogRmFsc2UsICJsYW5nIjogImVuIn0KICAgIHJlcyA9IF93aXRoX2xvYWRpbmcoIuKPsyBNZW5nYW1iaWwgdHJhbnNha3NpIHBlbmRpbmcuLi4iLCBzZW5kX2FwaV9yZXF1ZXN0LCB1c2VfbG9hZGluZywgZ2V0X3RoZW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGFwaV9rZXksIHBhdGgsIHBheWxvYWQsIHRva2Vuc1siaWRfdG9rZW4iXSwgIlBPU1QiKQogICAgZGF0YSA9IHJlcy5nZXQoImRhdGEiLCB7fSkKICAgIHJldHVybiBkYXRhIGlmIHJlcy5nZXQoInN0YXR1cyIpID09ICJTVUNDRVNTIiBhbmQgInBlbmRpbmdfcGF5bWVudCIgaW4gZGF0YSBlbHNlIE5vbmUKCgpkZWYgZ2V0X3RyYW5zYWN0aW9uX2hpc3RvcnkoYXBpX2tleTogc3RyLCB0b2tlbnM6IGRpY3QsIHVzZV9sb2FkaW5nOiBib29sID0gVHJ1ZSkgLT4gZGljdCB8IE5vbmU6CiAgICBwYXRoID0gInBheW1lbnRzL2FwaS92OC90cmFuc2FjdGlvbi1oaXN0b3J5IgogICAgcGF5bG9hZCA9IHsiaXNfZW50ZXJwcmlzZSI6IEZhbHNlLCAibGFuZyI6ICJlbiJ9CiAgICByZXMgPSBfd2l0aF9sb2FkaW5nKCLwn5OcIE1lbmdhbWJpbCByaXdheWF0IHRyYW5zYWtzaS4uLiIsIHNlbmRfYXBpX3JlcXVlc3QsIHVzZV9sb2FkaW5nLCBnZXRfdGhlbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgYXBpX2tleSwgcGF0aCwgcGF5bG9hZCwgdG9rZW5zWyJpZF90b2tlbiJdLCAiUE9TVCIpCiAgICBkYXRhID0gcmVzLmdldCgiZGF0YSIsIHt9KQogICAgcmV0dXJuIGRhdGEgaWYgcmVzLmdldCgic3RhdHVzIikgPT0gIlNVQ0NFU1MiIGFuZCAibGlzdCIgaW4gZGF0YSBlbHNlIE5vbmUKCgpkZWYgZ2V0X3RpZXJpbmdfaW5mbyhhcGlfa2V5OiBzdHIsIHRva2VuczogZGljdCwgdXNlX2xvYWRpbmc6IGJvb2wgPSBUcnVlKSAtPiBkaWN0OgogICAgcGF0aCA9ICJnYW1pZmljYXRpb24vYXBpL3Y4L2xveWFsdGllcy90aWVyaW5nL2luZm8iCiAgICBwYXlsb2FkID0geyJpc19lbnRlcnByaXNlIjogRmFsc2UsICJsYW5nIjogImVuIn0KICAgIHJlcyA9IF93aXRoX2xvYWRpbmcoIvCfj4YgTWVuZ2FtYmlsIGluZm8gdGllcmluZy4uLiIsIHNlbmRfYXBpX3JlcXVlc3QsIHVzZV9sb2FkaW5nLCBnZXRfdGhlbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgYXBpX2tleSwgcGF0aCwgcGF5bG9hZCwgdG9rZW5zWyJpZF90b2tlbiJdLCAiUE9TVCIpCiAgICByZXR1cm4gcmVzLmdldCgiZGF0YSIsIHt9KSBpZiByZXMgYW5kIHJlcy5nZXQoInN0YXR1cyIpID09ICJTVUNDRVNTIiBlbHNlIHt9CgoKZGVmIHVuc3Vic2NyaWJlKGFwaV9rZXk6IHN0ciwgdG9rZW5zOiBkaWN0LAogICAgICAgICAgICAgICAgcXVvdGFfY29kZTogc3RyLCBwcm9kdWN0X2RvbWFpbjogc3RyLCBwcm9kdWN0X3N1YnNjcmlwdGlvbl90eXBlOiBzdHIsCiAgICAgICAgICAgICAgICB1c2VfbG9hZGluZzogYm9vbCA9IFRydWUpIC0+IGJvb2w6CiAgICBwYXRoID0gImFwaS92OC9wYWNrYWdlcy91bnN1YnNjcmliZSIKICAgIHBheWxvYWQgPSB7CiAgICAgICAgInByb2R1Y3Rfc3Vic2NyaXB0aW9uX3R5cGUiOiBwcm9kdWN0X3N1YnNjcmlwdGlvbl90eXBlLAogICAgICAgICJxdW90YV9jb2RlIjogcXVvdGFfY29kZSwKICAgICAgICAicHJvZHVjdF9kb21haW4iOiBwcm9kdWN0X2RvbWFpbiwKICAgICAgICAiaXNfZW50ZXJwcmlzZSI6IEZhbHNlLAogICAgICAgICJ1bnN1YnNjcmliZV9yZWFzb25fY29kZSI6ICIiLAogICAgICAgICJsYW5nIjogImVuIiwKICAgICAgICAiZmFtaWx5X21lbWJlcl9pZCI6ICIiLAogICAgfQogICAgcmVzID0gX3dpdGhfbG9hZGluZyhmIvCfmqsgVW5zdWJzY3JpYmUga3VvdGEge3F1b3RhX2NvZGV9Li4uIiwgc2VuZF9hcGlfcmVxdWVzdCwgdXNlX2xvYWRpbmcsIGdldF90aGVtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBhcGlfa2V5LCBwYXRoLCBwYXlsb2FkLCB0b2tlbnNbImlkX3Rva2VuIl0sICJQT1NUIikKICAgIHJldHVybiBib29sKHJlcyBhbmQgcmVzLmdldCgiY29kZSIpID09ICIwMDAiKQoKCmRlZiBkYXNoYm9hcmRfc2VnbWVudHMoYXBpX2tleTogc3RyLCB0b2tlbnM6IGRpY3QsIHVzZV9sb2FkaW5nOiBib29sID0gVHJ1ZSkgLT4gZGljdDoKICAgIHBhdGggPSAiZGFzaGJvYXJkL2FwaS92OC9zZWdtZW50cyIKICAgIHBheWxvYWQgPSB7ImFjY2Vzc190b2tlbiI6IHRva2Vuc1siYWNjZXNzX3Rva2VuIl19CiAgICByZXR1cm4gX3dpdGhfbG9hZGluZygi8J+TiiBNZW5nYW1iaWwgc2VnbWVuIGRhc2hib2FyZC4uLiIsIHNlbmRfYXBpX3JlcXVlc3QsIHVzZV9sb2FkaW5nLCBnZXRfdGhlbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgIGFwaV9rZXksIHBhdGgsIHBheWxvYWQsIHRva2Vuc1siaWRfdG9rZW4iXSwgIlBPU1QiKQoKCmRlZiBkYXNoX3NlZ21lbnRzKGFwaV9rZXk6IHN0ciwgaWRfdG9rZW46IHN0ciwgYWNjZXNzX3Rva2VuOiBzdHIsIGJhbGFuY2U6IGludCA9IDAsIHVzZV9sb2FkaW5nOiBib29sID0gVHJ1ZSkgLT4gZGljdCB8IE5vbmU6CiAgICBwYXRoID0gImRhc2hib2FyZC9hcGkvdjgvc2VnbWVudHMiCiAgICBwYXlsb2FkID0gewogICAgICAgICJhY2Nlc3NfdG9rZW4iOiBhY2Nlc3NfdG9rZW4sCiAgICAgICAgImFwcF92ZXJzaW9uIjogIjguOS4xIiwKICAgICAgICAiY3VycmVudF9iYWxhbmNlIjogYmFsYW5jZSwKICAgICAgICAiZmFtaWx5X3BsYW5fcm9sZSI6ICJOT19ST0xFIiwKICAgICAgICAiaXNfZW50ZXJwcmlzZSI6IEZhbHNlLAogICAgICAgICJsYW5nIjogImlkIiwKICAgICAgICAibWFudWZhY3R1cmVyX25hbWUiOiAic2Ftc3VuZyIsCiAgICAgICAgIm1vZGVsX25hbWUiOiAiU00tTjkzNUYiLAogICAgfQogICAgcmVzID0gX3dpdGhfbG9hZGluZygi8J+TiiBNZW5nYW1iaWwgZGF0YSBzZWdtZW4gcGVuZ2d1bmEuLi4iLCBzZW5kX2FwaV9yZXF1ZXN0LCB1c2VfbG9hZGluZywgZ2V0X3RoZW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGFwaV9rZXksIHBhdGgsIHBheWxvYWQsIGlkX3Rva2VuLCAiUE9TVCIpCiAgICBpZiBub3QgKGlzaW5zdGFuY2UocmVzLCBkaWN0KSBhbmQgImRhdGEiIGluIHJlcyk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkYXRhID0gcmVzWyJkYXRhIl0KICAgIGxveWFsdHlfZGF0YSA9IGRhdGEuZ2V0KCJsb3lhbHR5Iiwge30pLmdldCgiZGF0YSIsIHt9KQogICAgbG95YWx0eV9pbmZvID0gewogICAgICAgICJjdXJyZW50X3BvaW50IjogbG95YWx0eV9kYXRhLmdldCgiY3VycmVudF9wb2ludCIsIDApLAogICAgICAgICJ0aWVyX25hbWUiOiBsb3lhbHR5X2RhdGEuZ2V0KCJkZXRhaWxfdGllciIsIHt9KS5nZXQoIm5hbWUiLCAiIiksCiAgICB9CiAgICBub3RpZmljYXRpb25zID0gZGF0YS5nZXQoIm5vdGlmaWNhdGlvbiIsIHt9KS5nZXQoImRhdGEiLCBbXSkKICAgIHNmeV9kYXRhID0gZGF0YS5nZXQoInNwZWNpYWxfZm9yX3lvdSIsIHt9KS5nZXQoImRhdGEiLCB7fSkKICAgIHNmeV9iYW5uZXJzID0gc2Z5X2RhdGEuZ2V0KCJiYW5uZXJzIiwgW10pCiAgICBzcGVjaWFsX3BhY2thZ2VzID0gW10KCiAgICBmb3IgcGtnIGluIHNmeV9iYW5uZXJzOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IHBrZy5nZXQoImFjdGlvbl9wYXJhbSIpOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAga3VvdGFfdG90YWwgPSBzdW0oCiAgICAgICAgICAgICAgICBpbnQoYmVuZWZpdC5nZXQoInRvdGFsIiwgMCkpCiAgICAgICAgICAgICAgICBmb3IgYmVuZWZpdCBpbiBwa2cuZ2V0KCJiZW5lZml0cyIsIFtdKQogICAgICAgICAgICAgICAgaWYgYmVuZWZpdC5nZXQoImRhdGFfdHlwZSIpID09ICJEQVRBIgogICAgICAgICAgICApCiAgICAgICAgICAgIGt1b3RhX2diID0ga3VvdGFfdG90YWwgLyAoMTAyNCAqKiAzKQogICAgICAgICAgICBvcmlnaW5hbF9wcmljZSA9IGludChwa2cuZ2V0KCJvcmlnaW5hbF9wcmljZSIsIDApKQogICAgICAgICAgICBkaXNjb3VudGVkX3ByaWNlID0gaW50KHBrZy5nZXQoImRpc2NvdW50ZWRfcHJpY2UiLCBvcmlnaW5hbF9wcmljZSkpCiAgICAgICAgICAgIGRpc2tvbl9wZXJjZW50ID0gaW50KHJvdW5kKChvcmlnaW5hbF9wcmljZSAtIGRpc2NvdW50ZWRfcHJpY2UpIC8gb3JpZ2luYWxfcHJpY2UgKiAxMDApKSBpZiBvcmlnaW5hbF9wcmljZSBlbHNlIDAKCiAgICAgICAgICAgIHNwZWNpYWxfcGFja2FnZXMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICJuYW1lIjogZiJ7cGtnLmdldCgnZmFtaWx5X25hbWUnLCAnJyl9ICh7cGtnLmdldCgndGl0bGUnLCAnJyl9KSB7cGtnLmdldCgndmFsaWRpdHknLCAnJyl9IiwKICAgICAgICAgICAgICAgICJrb2RlX3Bha2V0IjogcGtnLmdldCgiYWN0aW9uX3BhcmFtIiwgIiIpLAogICAgICAgICAgICAgICAgIm9yaWdpbmFsX3ByaWNlIjogb3JpZ2luYWxfcHJpY2UsCiAgICAgICAgICAgICAgICAiZGlza29uX3ByaWNlIjogZGlzY291bnRlZF9wcmljZSwKICAgICAgICAgICAgICAgICJkaXNrb25fcGVyY2VudCI6IGRpc2tvbl9wZXJjZW50LAogICAgICAgICAgICAgICAgImt1b3RhX2diIjoga3VvdGFfZ2IsCiAgICAgICAgICAgIH0pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgY29udGludWUKCiAgICByZXR1cm4gewogICAgICAgICJsb3lhbHR5IjogbG95YWx0eV9pbmZvLAogICAgICAgICJub3RpZmljYXRpb24iOiBub3RpZmljYXRpb25zLAogICAgICAgICJzcGVjaWFsX3BhY2thZ2VzIjogc3BlY2lhbF9wYWNrYWdlcywKICAgIH0KCgpkZWYgZ2V0X3F1b3RhKGFwaV9rZXk6IHN0ciwgaWRfdG9rZW46IHN0ciwgdXNlX2xvYWRpbmc6IGJvb2wgPSBUcnVlKSAtPiBkaWN0IHwgTm9uZToKICAgIHBhdGggPSAiYXBpL3Y4L3BhY2thZ2VzL3F1b3RhLXN1bW1hcnkiCiAgICBwYXlsb2FkID0geyJpc19lbnRlcnByaXNlIjogRmFsc2UsICJsYW5nIjogImVuIn0KICAgIHJlcyA9IF93aXRoX2xvYWRpbmcoIvCfk7YgTWVuZ2FtYmlsIHJpbmdrYXNhbiBrdW90YS4uLiIsIHNlbmRfYXBpX3JlcXVlc3QsIHVzZV9sb2FkaW5nLCBnZXRfdGhlbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgYXBpX2tleSwgcGF0aCwgcGF5bG9hZCwgaWRfdG9rZW4sICJQT1NUIikKICAgIHF1b3RhID0gcmVzLmdldCgiZGF0YSIsIHt9KS5nZXQoInF1b3RhIiwge30pLmdldCgiZGF0YSIpCiAgICBpZiBxdW90YToKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAicmVtYWluaW5nIjogcXVvdGEuZ2V0KCJyZW1haW5pbmciLCAwKSwKICAgICAgICAgICAgInRvdGFsIjogcXVvdGEuZ2V0KCJ0b3RhbCIsIDApLAogICAgICAgICAgICAiaGFzX3VubGltaXRlZCI6IHF1b3RhLmdldCgiaGFzX3VubGltaXRlZCIsIEZhbHNlKSwKICAgICAgICB9CiAgICByZXR1cm4gTm9uZQo=').decode())
